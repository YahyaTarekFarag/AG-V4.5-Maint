[{"filePath":"c:\\AG V4.5\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\layout\\DashboardLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\layout\\NetworkSynchronizer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'flushQueue'. Either include it or remove the dependency array.","line":26,"column":8,"nodeType":"ArrayExpression","endLine":26,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [flushQueue]","fix":{"range":[1029,1031],"text":"[flushQueue]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { OfflineQueue } from '../../lib/offlineQueue';\r\nimport { RefreshCcw, WifiOff } from 'lucide-react';\r\n\r\nexport default function NetworkSynchronizer() {\r\n    const [isSyncing, setIsSyncing] = useState(false);\r\n    const [pendingCount, setPendingCount] = useState(0);\r\n\r\n    useEffect(() => {\r\n        const updateCount = () => setPendingCount(OfflineQueue.getQueue().length);\r\n        updateCount();\r\n\r\n        // Listen for internal enqueue events\r\n        window.addEventListener('sovereign_offline_enqueued', updateCount);\r\n        window.addEventListener('online', flushQueue);\r\n\r\n        // Periodic check every 30 seconds as fallback\r\n        const interval = setInterval(flushQueue, 30000);\r\n\r\n        return () => {\r\n            window.removeEventListener('sovereign_offline_enqueued', updateCount);\r\n            window.removeEventListener('online', flushQueue);\r\n            clearInterval(interval);\r\n        };\r\n    }, []);\r\n\r\n    const flushQueue = async () => {\r\n        if (!navigator.onLine || isSyncing) return;\r\n\r\n        const queue = OfflineQueue.getQueue();\r\n        if (queue.length === 0) return;\r\n\r\n        setIsSyncing(true);\r\n        console.log(`ğŸ”ƒ Syncing ${queue.length} pending actions in parallel...`);\r\n\r\n        for (const action of queue) {\r\n            try {\r\n                let error;\r\n                if (action.action === 'update' && action.filter) {\r\n                    const { error: err } = await supabase\r\n                        .from(action.table)\r\n                        .update(action.data)\r\n                        .eq(action.filter.column, action.filter.value);\r\n                    error = err;\r\n                } else if (action.action === 'insert') {\r\n                    const { error: err } = await supabase\r\n                        .from(action.table)\r\n                        .insert(action.data);\r\n                    error = err;\r\n                } else if (action.action === 'delete' && action.filter) {\r\n                    const { error: err } = await supabase\r\n                        .from(action.table)\r\n                        .delete()\r\n                        .eq(action.filter.column, action.filter.value);\r\n                    error = err;\r\n                }\r\n\r\n                if (!error) {\r\n                    OfflineQueue.dequeue(action.id);\r\n                } else {\r\n                    console.error(`âŒ Sync failed for action ${action.id}:`, error);\r\n                    // Increment retry or keep in queue\r\n                    action.retryCount++;\r\n                    OfflineQueue.updateAction(action);\r\n                }\r\n            } catch (e) {\r\n                console.error('Fatal sync error:', e);\r\n            }\r\n        }\r\n\r\n        setPendingCount(OfflineQueue.getQueue().length);\r\n        setIsSyncing(false);\r\n    };\r\n\r\n    if (pendingCount === 0 && !isSyncing) return null;\r\n\r\n    return (\r\n        <div className=\"fixed bottom-20 left-4 z-[100] animate-in fade-in slide-in-from-bottom-4\">\r\n            <div className={`flex items-center gap-3 px-4 py-3 rounded-2xl border shadow-xl transition-all ${isSyncing ? 'bg-primary-600 text-white border-primary-500' : 'bg-amber-600 text-white border-amber-500'\r\n                }`}>\r\n                {isSyncing ? (\r\n                    <RefreshCcw className=\"w-5 h-5 animate-spin\" />\r\n                ) : (\r\n                    <WifiOff className=\"w-5 h-5 animate-pulse\" />\r\n                )}\r\n                <div className=\"text-right\">\r\n                    <p className=\"text-xs font-black uppercase tracking-tighter\">\r\n                        {isSyncing ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...' : 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù„Ù‚Ø© (Ø£ÙˆÙÙ„Ø§ÙŠÙ†)'}\r\n                    </p>\r\n                    <p className=\"text-[10px] opacity-80\">\r\n                        {isSyncing ? `ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø±ÙØ¹ ${pendingCount} Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø³ÙŠÙ‚Ø§Ù†` : `ÙŠÙˆØ¬Ø¯ ${pendingCount} Ø¹Ù…Ù„ÙŠØ© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¹ÙˆØ¯Ø© Ø§Ù„Ø´Ø¨ÙƒØ©`}\r\n                    </p>\r\n                </div>\r\n                {navigator.onLine && !isSyncing && (\r\n                    <button\r\n                        onClick={flushQueue}\r\n                        className=\"p-1.5 bg-white/20 hover:bg-white/30 rounded-lg transition-colors\"\r\n                    >\r\n                        <RefreshCcw className=\"w-4 h-4\" />\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\layout\\OmniSearch.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'q' is assigned a value but never used.","line":59,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":59,"endColumn":22},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'profile'. Either include it or remove the dependency array.","line":100,"column":8,"nodeType":"ArrayExpression","endLine":100,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [profile, query]","fix":{"range":[4634,4641],"text":"[profile, query]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { Search, Command, ArrowRight, Loader2 } from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { applyRBACFilter, getRBACSelect } from '../../lib/rbac';\r\nimport { SOVEREIGN_REGISTRY } from '../../lib/sovereign';\r\nimport * as LucideIcons from 'lucide-react';\r\nimport clsx from 'clsx';\r\n\r\nconst ALL_ROLES = ['admin', 'brand_ops_manager', 'sector_manager', 'area_manager', 'manager', 'maint_manager', 'maint_supervisor', 'technician'];\r\n\r\nexport default function OmniSearch() {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [query, setQuery] = useState('');\r\n    const [results, setResults] = useState<{ type: string; id: string; label: string; sub?: string; path: string; icon?: string }[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [activeIndex, setActiveIndex] = useState(0);\r\n    const { profile } = useAuth();\r\n    const navigate = useNavigate();\r\n    const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n    // Toggle with Shift+K\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (e.shiftKey && e.key === 'K') {\r\n                e.preventDefault();\r\n                setIsOpen(prev => !prev);\r\n            }\r\n            if (e.key === 'Escape') setIsOpen(false);\r\n        };\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            inputRef.current?.focus();\r\n            setQuery('');\r\n            setResults([]);\r\n        }\r\n    }, [isOpen]);\r\n\r\n    // Search Logic (Debounced & Dynamic)\r\n    useEffect(() => {\r\n        if (!query.trim()) {\r\n            setResults([]);\r\n            return;\r\n        }\r\n\r\n        const timer = setTimeout(async () => {\r\n            setLoading(true);\r\n            try {\r\n                // â”€â”€â”€ 1. Dynamic Table Search â”€â”€â”€\r\n                const searchables = Object.values(SOVEREIGN_REGISTRY).filter(s => s.roles.includes(profile?.role || ''));\r\n\r\n                const searchPromises = searchables.map(async (schema) => {\r\n                    let q = supabase.from(schema.tableName).select(getRBACSelect(schema.tableName));\r\n                    q = applyRBACFilter(q, schema.tableName, profile);\r\n\r\n                    // Smart Search: try to find a searchable column\r\n                    const searchableCols = ['name', 'full_name', 'asset_name', 'label', 'title', 'description'];\r\n                    const results = await Promise.all(searchableCols.map(col =>\r\n                        supabase.from(schema.tableName).select(getRBACSelect(schema.tableName)).ilike(col, `%${query}%`).limit(2)\r\n                    ));\r\n\r\n                    const combined = results.flatMap(r => r.data || []).slice(0, 3);\r\n                    return combined.map((item: any) => ({\r\n                        type: schema.tableName,\r\n                        id: item.id,\r\n                        label: item.name || item.full_name || item.asset_name || item.label || item.id,\r\n                        sub: schema.label,\r\n                        path: schema.path,\r\n                        icon: schema.icon\r\n                    }));\r\n                });\r\n\r\n                const dynamicResults = (await Promise.all(searchPromises)).flat();\r\n\r\n                // â”€â”€â”€ 2. Page Shortcuts (Static + Dynamic) â”€â”€â”€\r\n                const pageShortcuts = [\r\n                    { label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„ÙˆØ­ØªÙƒ)', path: '/', icon: 'LayoutDashboard', roles: ALL_ROLES },\r\n                    { label: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©', path: '/map', icon: 'Map', roles: ['admin', 'manager', 'maint_manager', 'maint_supervisor', 'brand_ops_manager', 'sector_manager', 'area_manager'] },\r\n                    ...Object.values(SOVEREIGN_REGISTRY).map(s => ({ label: s.label, path: s.path, icon: s.icon, roles: s.roles }))\r\n                ].filter(p => (p.label as string).includes(query) && (p.roles as string[]).includes(profile?.role || ''));\r\n\r\n                setResults([\r\n                    ...dynamicResults,\r\n                    ...pageShortcuts.map(p => ({ type: 'page', id: p.path, label: p.label, path: p.path, icon: p.icon }))\r\n                ]);\r\n            } catch (e) {\r\n                console.error('Search error', e);\r\n            } finally {\r\n                setLoading(false);\r\n                setActiveIndex(0);\r\n            }\r\n        }, 300);\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [query]);\r\n\r\n    const handleSelect = (result: any) => {\r\n        navigate(result.path);\r\n        setIsOpen(false);\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] flex items-start justify-center pt-[15vh] px-4\">\r\n            <div className=\"absolute inset-0 bg-surface-950/60 backdrop-blur-sm\" onClick={() => setIsOpen(false)} />\r\n\r\n            <div className=\"bg-surface-900/95 backdrop-blur-xl w-full max-w-2xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200\">\r\n                {/* Search Bar */}\r\n                <div className=\"p-4 flex items-center gap-4 border-b border-surface-800 bg-surface-800/50\">\r\n                    {loading ? <Loader2 className=\"w-6 h-6 text-brand-blaban animate-spin\" /> : <Search className=\"w-6 h-6 text-surface-500\" />}\r\n                    <input\r\n                        ref={inputRef}\r\n                        type=\"text\"\r\n                        placeholder=\"Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨Ù„Ø§ØºØŒ Ù…Ø¹Ø¯Ø©ØŒ Ø£Ùˆ Ù…ÙˆØ¸Ù... (Shift + K)\"\r\n                        className=\"flex-1 bg-transparent border-none outline-none text-lg text-white placeholder-surface-500 font-medium\"\r\n                        value={query}\r\n                        onChange={(e) => setQuery(e.target.value)}\r\n                        onKeyDown={(e) => {\r\n                            if (e.key === 'ArrowDown') setActiveIndex(prev => Math.min(prev + 1, results.length - 1));\r\n                            if (e.key === 'ArrowUp') setActiveIndex(prev => Math.max(prev - 1, 0));\r\n                            if (e.key === 'Enter' && results[activeIndex]) handleSelect(results[activeIndex]);\r\n                        }}\r\n                    />\r\n                    <div className=\"flex items-center gap-1.5 px-2 py-1 bg-surface-800 rounded-lg text-[10px] font-bold text-surface-400 border border-surface-700 uppercase\">\r\n                        <span>Esc</span>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Results List */}\r\n                <div className=\"max-h-[60vh] overflow-y-auto p-2 custom-scrollbar\">\r\n                    {results.length === 0 && !loading && (\r\n                        <div className=\"p-8 text-center\">\r\n                            {query ? (\r\n                                <p className=\"text-surface-500\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ø¹Ù† \"{query}\"</p>\r\n                            ) : (\r\n                                <div className=\"space-y-4\">\r\n                                    <Command className=\"w-12 h-12 text-surface-800 mx-auto\" />\r\n                                    <p className=\"text-surface-500 font-medium\">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¨Ù„Ø¨Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {results.map((result, idx) => (\r\n                        <button\r\n                            key={idx}\r\n                            onClick={() => handleSelect(result)}\r\n                            className={clsx(\r\n                                \"w-full flex items-center justify-between p-4 rounded-2xl transition-all group\",\r\n                                idx === activeIndex ? \"bg-brand-blaban text-white shadow-xl shadow-brand-blaban/30 scale-[1.02]\" : \"hover:bg-surface-800\"\r\n                            )}\r\n                        >\r\n                            <div className=\"flex items-center gap-4\">\r\n                                <div className={clsx(\r\n                                    \"w-10 h-10 rounded-xl flex items-center justify-center shrink-0 transition-colors\",\r\n                                    idx === activeIndex ? \"bg-white/20\" : \"bg-surface-800 text-surface-400\"\r\n                                )}>\r\n                                    {(() => {\r\n                                        const IconComp = (LucideIcons as any)[result.icon || ''] ||\r\n                                            (result.type === 'page' ? LucideIcons.Command : LucideIcons.Search);\r\n                                        return <IconComp className=\"w-5 h-5\" />;\r\n                                    })()}\r\n                                </div>\r\n                                <div className=\"text-right\">\r\n                                    <p className=\"font-bold text-white\">{result.label}</p>\r\n                                    {result.sub && (\r\n                                        <p className={clsx(\r\n                                            \"text-xs mt-0.5\",\r\n                                            idx === activeIndex ? \"text-white/70\" : \"text-surface-500\"\r\n                                        )}>\r\n                                            {result.sub}\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                            <ArrowRight className={clsx(\r\n                                \"w-5 h-5 transition-transform\",\r\n                                idx === activeIndex ? \"translate-x-0 opacity-100\" : \"translate-x-4 opacity-0\"\r\n                            )} />\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 bg-surface-950 border-t border-surface-800 flex items-center gap-6 text-[10px] text-surface-500 font-bold uppercase overflow-x-auto\">\r\n                    <div className=\"flex items-center gap-1.5 whitespace-nowrap\">\r\n                        <span className=\"px-1.5 py-1 bg-surface-800 border border-surface-700 rounded shadow-sm text-surface-300\">â†µ</span>\r\n                        Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1.5 whitespace-nowrap\">\r\n                        <span className=\"px-1.5 py-1 bg-surface-800 border border-surface-700 rounded shadow-sm text-surface-300\">â†“â†‘</span>\r\n                        Ù„Ù„ØªÙ†Ù‚Ù„\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1.5 whitespace-nowrap\">\r\n                        <span className=\"px-1.5 py-1 bg-surface-800 border border-surface-700 rounded shadow-sm text-surface-300\">Shift + K</span>\r\n                        Ù„Ù„Ø¥ØºÙ„Ø§Ù‚\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\layout\\ShiftStatus.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchActiveShift'. Either include it or remove the dependency array.","line":18,"column":8,"nodeType":"ArrayExpression","endLine":18,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchActiveShift, profile]","fix":{"range":[785,794],"text":"[fetchActiveShift, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { MapPin, Clock, Play, Square, Loader2, AlertCircle, Timer } from 'lucide-react';\r\nimport { format, differenceInMinutes } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport { getGeoLocation } from '../../lib/geo';\r\n\r\nexport default function ShiftStatus() {\r\n    const { profile } = useAuth();\r\n    const [activeShift, setActiveShift] = useState<any | null>(null);\r\n    const [shiftLoading, setShiftLoading] = useState(true);\r\n    const [shiftError, setShiftError] = useState<string | null>(null);\r\n    const [elapsed, setElapsed] = useState<string>('');\r\n\r\n    useEffect(() => {\r\n        fetchActiveShift();\r\n    }, [profile]);\r\n\r\n    // Live elapsed timer\r\n    useEffect(() => {\r\n        if (!activeShift) {\r\n            setElapsed('');\r\n            return;\r\n        }\r\n        const timer = setInterval(() => {\r\n            const mins = differenceInMinutes(new Date(), new Date(activeShift.clock_in));\r\n            const h = Math.floor(mins / 60).toString().padStart(2, '0');\r\n            const m = (mins % 60).toString().padStart(2, '0');\r\n            setElapsed(`${h}:${m}`);\r\n        }, 1000);\r\n        return () => clearInterval(timer);\r\n    }, [activeShift]);\r\n\r\n    const fetchActiveShift = async () => {\r\n        if (!profile || profile.role !== 'technician') {\r\n            setShiftLoading(false);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const { data } = await supabase\r\n                .from('technician_attendance' as any)\r\n                .select('*')\r\n                .eq('profile_id', profile.id)\r\n                .is('clock_out', null)\r\n                .order('clock_in', { ascending: false })\r\n                .limit(1)\r\n                .maybeSingle();\r\n            setActiveShift(data);\r\n        } catch (e) {\r\n            console.error('Error fetching shift', e);\r\n        } finally {\r\n            setShiftLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleShiftToggle = async () => {\r\n        if (!profile) return;\r\n        setShiftLoading(true);\r\n        setShiftError(null);\r\n        try {\r\n            const coords = await getGeoLocation();\r\n            if (activeShift) {\r\n                // End shift\r\n                const { error } = await supabase\r\n                    .from('technician_attendance' as any)\r\n                    .update({\r\n                        clock_out: new Date().toISOString(),\r\n                        clock_out_lat: coords.lat,\r\n                        clock_out_lng: coords.lng\r\n                    })\r\n                    .eq('id', activeShift.id);\r\n                if (error) throw error;\r\n                setActiveShift(null);\r\n            } else {\r\n                // Start shift\r\n                const { data, error } = await supabase\r\n                    .from('technician_attendance' as any)\r\n                    .insert([{\r\n                        profile_id: profile.id,\r\n                        clock_in: new Date().toISOString(),\r\n                        clock_in_lat: coords.lat,\r\n                        clock_in_lng: coords.lng,\r\n                    }])\r\n                    .select()\r\n                    .single();\r\n                if (error) throw error;\r\n                setActiveShift(data);\r\n            }\r\n        } catch (e: any) {\r\n            setShiftError(e.message);\r\n        } finally {\r\n            setShiftLoading(false);\r\n        }\r\n    };\r\n\r\n    if (!profile || profile.role !== 'technician') return null;\r\n\r\n    return (\r\n        <div className={`rounded-2xl p-5 mb-6 border flex items-center justify-between flex-wrap gap-4 transition-all duration-300 ${activeShift\r\n            ? 'bg-teal-900/10 border-teal-900/30 shadow-sm'\r\n            : 'bg-surface-900 border-surface-800'\r\n            }`}>\r\n            <div>\r\n                <h3 className={`font-bold text-lg flex items-center gap-2 ${activeShift ? 'text-teal-400' : 'text-surface-300'}`}>\r\n                    <div className={`w-2 h-2 rounded-full ${activeShift ? 'bg-teal-500 animate-pulse' : 'bg-surface-600'}`} />\r\n                    {activeShift ? 'Ù…Ù†Ø§ÙˆØ¨ØªÙƒ Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†' : 'Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©'}\r\n                </h3>\r\n                {activeShift ? (\r\n                    <div className=\"text-sm text-teal-400 mt-1 space-y-0.5\">\r\n                        <p className=\"flex items-center gap-1.5 font-medium\">\r\n                            <Clock className=\"w-3.5 h-3.5\" />\r\n                            ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±: {format(new Date(activeShift.clock_in), 'hh:mm a - PPP', { locale: ar })}\r\n                        </p>\r\n                        <p className=\"flex items-center gap-2\">\r\n                            <Timer className=\"w-4 h-4\" />\r\n                            <span className=\"font-mono font-bold text-teal-100 text-xl tracking-wider\">{elapsed}</span>\r\n                            <span className=\"text-xs font-semibold\">(Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©)</span>\r\n                        </p>\r\n                        {activeShift.clock_in_lat && (\r\n                            <p className=\"flex items-center gap-1 text-xs text-teal-400/80 bg-teal-900/20 w-fit px-2 py-0.5 rounded-full mt-1\">\r\n                                <MapPin className=\"w-3 h-3\" />\r\n                                Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ø¬Ù‘Ù„ Ø¢Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­ (GPS)\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                ) : (\r\n                    <p className=\"text-sm text-surface-500 mt-1 font-medium\">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¨Ø¯Ø¡ Ù…Ù†Ø§ÙˆØ¨ØªÙƒ ÙˆØªØ³Ø¬ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</p>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"flex flex-col items-end gap-2\">\r\n                {shiftError && (\r\n                    <div className=\"flex items-center gap-1 text-red-400 text-xs bg-red-900/20 px-3 py-1.5 rounded-lg border border-red-900/30 mb-1 animate-in fade-in slide-in-from-top-1\">\r\n                        <AlertCircle className=\"w-3.5 h-3.5 shrink-0\" />\r\n                        <span>{shiftError}</span>\r\n                    </div>\r\n                )}\r\n                <button\r\n                    onClick={handleShiftToggle}\r\n                    disabled={shiftLoading}\r\n                    className={`flex items-center gap-2 px-8 py-3.5 text-white font-bold rounded-2xl shadow-lg transition-all active:scale-95 disabled:opacity-70 ${activeShift\r\n                        ? 'bg-red-500 hover:bg-red-400 shadow-red-500/20'\r\n                        : 'bg-teal-600 hover:bg-teal-500 shadow-teal-500/20'\r\n                        }`}\r\n                >\r\n                    {shiftLoading\r\n                        ? <Loader2 className=\"w-5 h-5 animate-spin\" />\r\n                        : activeShift\r\n                            ? <Square className=\"w-5 h-5\" />\r\n                            : <Play className=\"w-5 h-5 fill-white\" />\r\n                    }\r\n                    <span>{activeShift ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± (Ø¨Ø¯Ø£)'}</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\layout\\Sidebar.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'ALL_ROLES'. Either include it or remove the dependency array.","line":38,"column":8,"nodeType":"ArrayExpression","endLine":38,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [ALL_ROLES, profile]","fix":{"range":[1694,1703],"text":"[ALL_ROLES, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { NavLink } from 'react-router-dom';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { LogOut, Smartphone } from 'lucide-react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { SOVEREIGN_REGISTRY } from '../../lib/sovereign';\r\nimport * as LucideIcons from 'lucide-react';\r\nimport clsx from 'clsx';\r\n\r\nexport default function Sidebar({ onItemClick }: { onItemClick?: () => void }) {\r\n    const [dynamicItems, setDynamicItems] = useState<any[]>([]);\r\n    const { profile, signOut } = useAuth();\r\n    const [deferredPrompt, setDeferredPrompt] = useState<any>(null);\r\n    const [isInstalled, setIsInstalled] = useState(false);\r\n\r\n    useEffect(() => {\r\n        // Fetch dynamic schemas for individual SaaS routes\r\n        const fetchDynamicItems = async () => {\r\n            const { data } = await supabase\r\n                .from('ui_schemas')\r\n                .select('table_name, list_config, nav_config');\r\n\r\n            if (data) {\r\n                const items = data\r\n                    .filter(s => s.nav_config?.is_visible !== false)\r\n                    .filter(s => !s.nav_config?.roles || (Array.isArray(s.nav_config.roles) && s.nav_config.roles.includes(profile?.role)))\r\n                    .map(s => ({\r\n                        label: s.list_config?.title || s.table_name,\r\n                        path: `/manage/${s.table_name}`,\r\n                        icon: s.nav_config?.icon || 'Layout',\r\n                        roles: s.nav_config?.roles || ALL_ROLES\r\n                    }));\r\n                setDynamicItems(items);\r\n            }\r\n        };\r\n\r\n        if (profile) fetchDynamicItems();\r\n    }, [profile]);\r\n\r\n    useEffect(() => {\r\n        window.addEventListener('beforeinstallprompt', (e) => {\r\n            e.preventDefault();\r\n            setDeferredPrompt(e);\r\n        });\r\n\r\n        if (window.matchMedia('(display-mode: standalone)').matches) {\r\n            setIsInstalled(true);\r\n        }\r\n    }, []);\r\n\r\n    const handleInstall = async () => {\r\n        if (!deferredPrompt) return;\r\n        deferredPrompt.prompt();\r\n        const { outcome } = await deferredPrompt.userChoice;\r\n        if (outcome === 'accepted') {\r\n            setDeferredPrompt(null);\r\n        }\r\n    };\r\n\r\n    const ROLE_LABELS: Record<string, string> = {\r\n        admin: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ø¸Ø§Ù…',\r\n        brand_ops_manager: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©',\r\n        sector_manager: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ©',\r\n        area_manager: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ',\r\n        manager: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ',\r\n        maint_manager: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©',\r\n        maint_supervisor: 'Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠØ©',\r\n        technician: 'Ø£Ø®ØµØ§Ø¦ÙŠ ØµÙŠØ§Ù†Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ©',\r\n    };\r\n\r\n    const ALL_ROLES = Object.keys(ROLE_LABELS);\r\n\r\n    // â”€â”€â”€ Core Navigation (Static) â”€â”€â”€\r\n    const coreItems = [\r\n        { label: 'Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©', path: '/', icon: 'LayoutDashboard', roles: ALL_ROLES },\r\n        { label: 'Ù…Ø±ÙƒØ² Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹', path: '/my-tickets', icon: 'ClipboardList', roles: ['manager'] },\r\n        { label: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©', path: '/tech-tickets', icon: 'Timer', roles: ['technician'] },\r\n        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ù„Ø§Øª', path: '/my-salary', icon: 'Wallet', roles: ['technician'] },\r\n        { label: 'Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠØ©', path: '/maint-dashboard', icon: 'Wrench', roles: ['admin', 'maint_manager', 'maint_supervisor', 'brand_ops_manager', 'sector_manager', 'area_manager'] },\r\n        { label: 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ', path: '/attendance-live', icon: 'Fingerprint', roles: ['admin', 'maint_manager', 'maint_supervisor', 'brand_ops_manager', 'sector_manager', 'area_manager'] },\r\n        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ', path: '/reports', icon: 'BarChart3', roles: ['admin', 'maint_manager', 'brand_ops_manager'] },\r\n        { label: 'Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GIS)', path: '/map', icon: 'Map', roles: ['admin', 'manager', 'maint_manager', 'maint_supervisor', 'brand_ops_manager', 'sector_manager', 'area_manager'] },\r\n    ];\r\n\r\n    // â”€â”€â”€ Sovereign Registry Navigation (Dynamic) â”€â”€â”€\r\n    const registryItems = Object.values(SOVEREIGN_REGISTRY).map(entry => ({\r\n        label: entry.label,\r\n        path: entry.path,\r\n        icon: entry.icon || 'Layout',\r\n        roles: entry.roles || []\r\n    }));\r\n\r\n\r\n    const ADMIN_ROLES = ['admin'];\r\n\r\n    // â”€â”€â”€ Admin Utility Links (Static) â”€â”€â”€\r\n    const adminItems = [\r\n        { label: 'ØªÙ‡ÙŠØ¦Ø© ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…', path: '/settings', icon: 'Settings', roles: ADMIN_ROLES },\r\n        { label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©', path: '/admin/settings', icon: 'ShieldCheck', roles: ADMIN_ROLES },\r\n    ];\r\n\r\n    // Filter dynamic items to avoid duplicates with static registry or core\r\n    const filteredDynamic = dynamicItems.filter(d =>\r\n        !coreItems.some(c => c.path === d.path) &&\r\n        !registryItems.some(r => r.path === d.path)\r\n    );\r\n\r\n    const allNavItems = [...coreItems, ...registryItems, ...filteredDynamic, ...adminItems];\r\n    const authorizedLinks = allNavItems.filter(item => profile && item.roles.includes(profile.role));\r\n\r\n    return (\r\n        <aside className=\"w-72 brand-gradient text-white flex flex-col h-full transition-all duration-500 shadow-2xl overflow-y-auto custom-scrollbar relative z-50\">\r\n            <div className=\"absolute inset-0 bg-black/10 -z-10\" />\r\n            <div className=\"p-6 flex items-center gap-4 border-b border-surface-800 shrink-0\">\r\n                <div className=\"w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg shrink-0\">\r\n                    <img src=\"/logo.png\" alt=\"B.Laban\" className=\"w-8 h-8 object-contain\" onError={(e) => {\r\n                        (e.target as any).src = 'https://portal.blaban.com.eg/assets/images/logo.png';\r\n                    }} />\r\n                </div>\r\n                <div>\r\n                    <h2 className=\"text-xl font-black tracking-tighter text-white\">B.LABAN</h2>\r\n                    <p className=\"text-[10px] text-primary-400 font-bold uppercase tracking-widest\">Sovereign Engine</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"p-6 pb-4 border-b border-white/10 bg-black/10 shrink-0\">\r\n                <div className=\"flex items-center gap-3 p-3 rounded-2xl bg-white/10 backdrop-blur-md border border-white/10 shadow-inner\">\r\n                    <div className=\"w-10 h-10 bg-white rounded-xl flex items-center justify-center text-primary-600 font-black text-lg shrink-0 border border-white/20 shadow-lg\">\r\n                        {profile?.full_name?.charAt(0) || 'M'}\r\n                    </div>\r\n                    <div className=\"overflow-hidden\">\r\n                        <p className=\"font-black text-sm text-white truncate\">{profile?.full_name}</p>\r\n                        <div className=\"flex items-center gap-1 mt-0.5\">\r\n                            <div className=\"w-1.5 h-1.5 rounded-full bg-accent-sky animate-pulse\" />\r\n                            <p className=\"text-[10px] text-white/80 font-black uppercase tracking-widest truncate\">\r\n                                {ROLE_LABELS[profile?.role || ''] || profile?.role}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <nav className=\"flex-1 p-4 space-y-1.5 overflow-y-auto custom-scrollbar\">\r\n                {authorizedLinks.map((item) => (\r\n                    <NavLink\r\n                        key={item.path}\r\n                        to={item.path}\r\n                        onClick={onItemClick}\r\n                        className={({ isActive }: { isActive: boolean }) => clsx(\r\n                            \"flex items-center gap-4 px-5 py-4 rounded-2xl transition-all duration-300 text-sm font-black group relative overflow-hidden\",\r\n                            isActive\r\n                                ? \"bg-white text-primary-600 shadow-xl shadow-black/20 translate-x-3 scale-[1.02]\"\r\n                                : \"text-white/80 hover:bg-white/10 hover:text-white hover:translate-x-2\"\r\n                        )}\r\n                    >\r\n                        {({ isActive }: { isActive: boolean }) => (\r\n                            <>\r\n                                <div className={clsx(\r\n                                    \"w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-500 shadow-inner\",\r\n                                    isActive ? \"bg-primary-50 text-primary-600 rotate-6\" : \"bg-white/10 group-hover:bg-white/20 group-hover:rotate-6 border border-white/5\"\r\n                                )}>\r\n                                    {(() => {\r\n                                        const IconComponent = (LucideIcons as any)[item.icon] || LucideIcons.Layout;\r\n                                        return <IconComponent className={clsx(\"w-5 h-5 shrink-0 transition-transform duration-500\", !isActive && \"group-hover:scale-110\")} />;\r\n                                    })()}\r\n                                </div>\r\n                                <span className=\"flex-1 font-outfit tracking-wide\">{item.label}</span>\r\n                                {isActive && <div className=\"w-2 h-2 rounded-full bg-white shadow-[0_0_15px_rgba(255,255,255,1)] animate-pulse\" />}\r\n                            </>\r\n                        )}\r\n                    </NavLink>\r\n                ))}\r\n            </nav>\r\n\r\n            <div className=\"p-4 border-t border-surface-800 bg-surface-800/10 space-y-2 shrink-0\">\r\n                {deferredPrompt && !isInstalled && (\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); handleInstall(); }}\r\n                        className=\"btn-3d flex items-center gap-3 w-full px-4 py-3 text-sm font-bold text-emerald-400 bg-emerald-500/10 hover:bg-emerald-500/20 rounded-xl transition-all border border-emerald-500/20 shadow-lg shadow-emerald-900/10\"\r\n                    >\r\n                        <Smartphone className=\"w-5 h-5 shrink-0\" />\r\n                        <span>ØªÙ†Ø´ÙŠØ· ÙˆØ¶Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ (Mobile PWA)</span>\r\n                    </button>\r\n                )}\r\n\r\n                <button\r\n                    onClick={() => { if (window.confirm('ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù…Ù†Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ')) signOut(); }}\r\n                    className=\"flex items-center gap-3 w-full px-4 py-3 text-sm font-bold text-red-400 hover:bg-red-500/10 hover:text-red-300 rounded-xl transition-all\"\r\n                >\r\n                    <LogOut className=\"w-5 h-5 shrink-0\" />\r\n                    <span>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù…Ù†Ø©</span>\r\n                </button>\r\n            </div>\r\n        </aside>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\AuditLogViewer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":39,"column":49,"nodeType":"ArrayExpression","endLine":39,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [tableName, page, load]","fix":{"range":[1230,1247],"text":"[tableName, page, load]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { Loader2, History, RefreshCw } from 'lucide-react';\r\nimport { format } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\n\r\ninterface AuditLog {\r\n    id: string;\r\n    table_name: string;\r\n    record_id: string;\r\n    action: 'INSERT' | 'UPDATE' | 'DELETE';\r\n    old_data: any;\r\n    new_data: any;\r\n    user_id: string;\r\n    performed_at: string;\r\n    // Optional join\r\n    performer?: { full_name: string };\r\n}\r\n\r\nconst ACTION_STYLE: Record<string, string> = {\r\n    INSERT: 'text-green-700 bg-green-50 border-green-200',\r\n    UPDATE: 'text-blue-700  bg-blue-50  border-blue-200',\r\n    DELETE: 'text-red-700   bg-red-50   border-red-200',\r\n};\r\nconst ACTION_LABEL: Record<string, string> = {\r\n    INSERT: '+ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯',\r\n    UPDATE: 'âœ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',\r\n    DELETE: 'âœ• Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„',\r\n};\r\n\r\ninterface Props { tableName: string; }\r\n\r\nexport default function AuditLogViewer({ tableName }: Props) {\r\n    const [logs, setLogs] = useState<AuditLog[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [page, setPage] = useState(0);\r\n    const PAGE_SIZE = 20;\r\n\r\n    useEffect(() => { if (tableName) load(); }, [tableName, page]);\r\n\r\n    const load = async () => {\r\n        setLoading(true);\r\n        const { data } = await supabase\r\n            .from('audit_logs' as any)\r\n            .select('*')\r\n            .eq('table_name', tableName)\r\n            .order('performed_at', { ascending: false })\r\n            .range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1);\r\n        setLogs((data || []) as AuditLog[]);\r\n        setLoading(false);\r\n    };\r\n\r\n    if (loading) return (\r\n        <div className=\"bg-white rounded-2xl border border-surface-200 p-16 flex items-center justify-center\">\r\n            <Loader2 className=\"w-7 h-7 animate-spin text-primary-400\" />\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className=\"bg-white rounded-2xl border border-surface-200 shadow-sm overflow-hidden\">\r\n            <div className=\"p-5 border-b border-surface-100 flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <History className=\"w-5 h-5 text-primary-500\" />\r\n                    <span className=\"font-semibold text-surface-800\">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</span>\r\n                    <span className=\"text-xs bg-surface-100 text-surface-500 px-2 py-0.5 rounded-full font-mono\">{tableName}</span>\r\n                </div>\r\n                <button onClick={load} className=\"p-2 text-surface-400 hover:text-surface-700 hover:bg-surface-100 rounded-lg transition-colors\">\r\n                    <RefreshCw className=\"w-4 h-4\" />\r\n                </button>\r\n            </div>\r\n\r\n            {logs.length === 0 ? (\r\n                <div className=\"p-12 text-center text-surface-400\">\r\n                    <History className=\"w-10 h-10 mx-auto mb-2 text-surface-200\" />\r\n                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø³Ø¬Ù‘Ù„Ø© Ø¨Ø¹Ø¯</p>\r\n                    <p className=\"text-xs mt-1\">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ sovereign_v2_audit.sql</p>\r\n                </div>\r\n            ) : (\r\n                <>\r\n                    <div className=\"overflow-x-auto max-h-[55vh] overflow-y-auto\">\r\n                        <table className=\"w-full text-sm\">\r\n                            <thead className=\"bg-surface-50 border-b border-surface-100 sticky top-0\">\r\n                                <tr>\r\n                                    <th className=\"text-right px-4 py-3 text-xs font-semibold text-surface-500\">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>\r\n                                    <th className=\"text-right px-4 py-3 text-xs font-semibold text-surface-500\">Ø§Ù„Ù…Ø¹Ø±Ù</th>\r\n                                    <th className=\"text-right px-4 py-3 text-xs font-semibold text-surface-500\">Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>\r\n                                    <th className=\"text-right px-4 py-3 text-xs font-semibold text-surface-500\">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-surface-100\">\r\n                                {logs.map(log => (\r\n                                    <tr key={log.id} className=\"hover:bg-surface-50 transition-colors\">\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <span className={`inline-block px-2 py-0.5 rounded border text-xs font-semibold ${ACTION_STYLE[log.action] || ''}`}>\r\n                                                {ACTION_LABEL[log.action] || log.action}\r\n                                            </span>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <span className=\"font-mono text-xs text-surface-500 truncate max-w-[100px] block\">{log.record_id || 'â€”'}</span>\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3 text-surface-500 whitespace-nowrap text-xs\">\r\n                                            {log.performed_at ? format(new Date(log.performed_at), 'dd/MM/yyyy HH:mm', { locale: ar }) : 'â€”'}\r\n                                        </td>\r\n                                        <td className=\"px-4 py-3\">\r\n                                            <details className=\"cursor-pointer\">\r\n                                                <summary className=\"text-xs text-primary-600 hover:text-primary-800 font-medium list-none\">Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª â†</summary>\r\n                                                <div className=\"mt-2 grid grid-cols-2 gap-2 max-w-lg\">\r\n                                                    {log.old_data && (\r\n                                                        <div>\r\n                                                            <p className=\"text-xs text-red-500 font-semibold mb-1\">Ù‚Ø¨Ù„:</p>\r\n                                                            <pre className=\"text-xs bg-red-50 rounded p-2 overflow-x-auto max-h-32 text-red-800 border border-red-100\">\r\n                                                                {JSON.stringify(log.old_data, null, 2)}\r\n                                                            </pre>\r\n                                                        </div>\r\n                                                    )}\r\n                                                    {log.new_data && (\r\n                                                        <div>\r\n                                                            <p className=\"text-xs text-green-600 font-semibold mb-1\">Ø¨Ø¹Ø¯:</p>\r\n                                                            <pre className=\"text-xs bg-green-50 rounded p-2 overflow-x-auto max-h-32 text-green-800 border border-green-100\">\r\n                                                                {JSON.stringify(log.new_data, null, 2)}\r\n                                                            </pre>\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </details>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                    <div className=\"p-4 border-t border-surface-100 flex justify-between items-center\">\r\n                        <button disabled={page === 0} onClick={() => setPage(p => p - 1)} className=\"px-4 py-2 text-sm text-surface-600 hover:bg-surface-100 rounded-lg disabled:opacity-40 transition-colors\">\r\n                            â† Ø§Ù„Ø³Ø§Ø¨Ù‚\r\n                        </button>\r\n                        <span className=\"text-xs text-surface-400\">ØµÙØ­Ø© {page + 1}</span>\r\n                        <button disabled={logs.length < PAGE_SIZE} onClick={() => setPage(p => p + 1)} className=\"px-4 py-2 text-sm text-surface-600 hover:bg-surface-100 rounded-lg disabled:opacity-40 transition-colors\">\r\n                            Ø§Ù„ØªØ§Ù„ÙŠ â†’\r\n                        </button>\r\n                    </div>\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignActionModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchInitialData' and 'isEdit'. Either include them or remove the dependency array.","line":64,"column":8,"nodeType":"ArrayExpression","endLine":64,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [fetchInitialData, isEdit, isOpen, record, schema]","fix":{"range":[2815,2839],"text":"[fetchInitialData, isEdit, isOpen, record, schema]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'password' is assigned a value but never used.","line":247,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":247,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { supabase, supabaseAdmin } from '../../lib/supabase';\r\nimport { UISchema, FieldConfig } from '../../types/schema';\r\nimport { getGeoLocation } from '../../lib/geo';\r\nimport { X, Loader2, MapPin, Navigation, Upload, QrCode } from 'lucide-react';\r\nimport { compressImage } from '../../lib/image';\r\nimport { uploadToDrive } from '../../lib/drive';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { applyRBACFilter, getSecureProfileSelect } from '../../lib/rbac';\r\nimport clsx from 'clsx';\r\nimport BottomSheet from '../ui/BottomSheet';\r\nimport QRScanner from '../ui/QRScanner';\r\nimport { useToast } from '../../contexts/ToastContext';\r\n\r\ninterface SovereignActionModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    schema: UISchema;\r\n    record: any | null; // null means create mode\r\n    onSuccess: () => void;\r\n    isAssignMode?: boolean;\r\n    actionTitle?: string;\r\n}\r\n\r\nexport default function SovereignActionModal({ isOpen, onClose, schema, record, onSuccess, isAssignMode, actionTitle }: SovereignActionModalProps) {\r\n    const { profile: currentUserProfile } = useAuth();\r\n    const { showToast } = useToast();\r\n    const [formData, setFormData] = useState<Record<string, any>>({});\r\n    const [loading, setLoading] = useState(false);\r\n    const [uploading, setUploading] = useState<string | null>(null);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [lookupData, setLookupData] = useState<Record<string, any[]>>({});\r\n    const [gpsLoading, setGpsLoading] = useState(false);\r\n    const [gpsSuccess, setGpsSuccess] = useState(false);\r\n    const [settings, setSettings] = useState<Record<string, any>>({});\r\n    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);\r\n    const [activeScannerField, setActiveScannerField] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const handleResize = () => setIsMobile(window.innerWidth < 768);\r\n        window.addEventListener('resize', handleResize);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    const { form_config, table_name } = schema;\r\n    const isEdit = !!record;\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setError(null);\r\n            if (isEdit && record) {\r\n                const initialData = { ...record };\r\n                for (const key in initialData) {\r\n                    if (typeof initialData[key] === 'object' && initialData[key] !== null) {\r\n                        initialData[key] = JSON.stringify(initialData[key], null, 2);\r\n                    }\r\n                }\r\n                setFormData(initialData);\r\n            } else {\r\n                setFormData({});\r\n            }\r\n            fetchInitialData();\r\n        }\r\n    }, [isOpen, record, schema]);\r\n\r\n    const fetchInitialData = async () => {\r\n        await Promise.all([fetchLookups(), fetchSettings()]);\r\n    };\r\n\r\n    const fetchSettings = async () => {\r\n        try {\r\n            const { data } = await supabase.from('system_settings').select('*');\r\n            if (data) {\r\n                const mapped = data.reduce((acc, s) => ({ ...acc, [s.key]: s.value }), {});\r\n                setSettings(mapped);\r\n\r\n                // [SINGULARITY FIX] Use existing currentUserProfile to avoid redundant DB call\r\n                const branchCol = schema.directBranchColumn;\r\n                if (branchCol && !isEdit && currentUserProfile?.role === 'manager' && mapped.restrict_branch_submission === 'true') {\r\n                    if (currentUserProfile?.branch_id) {\r\n                        setFormData(prev => ({ ...prev, [branchCol]: currentUserProfile.branch_id }));\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error('Settings fetch error', e);\r\n        }\r\n    };\r\n\r\n    // Smart Fetch for Dropdowns (The Reverse Lookup)\r\n    const fetchLookups = async () => {\r\n        const lookupFields = form_config.fields.filter(f => f.type === 'select' && f.dataSource);\r\n\r\n        for (const field of lookupFields) {\r\n            if (!field.dataSource) continue;\r\n            try {\r\n                let query = supabase.from(field.dataSource as any).select(\r\n                    field.dataSource === 'profiles' ? getSecureProfileSelect(currentUserProfile?.role || '') : '*'\r\n                );\r\n\r\n                // Apply RBAC filters to lookups\r\n                query = applyRBACFilter(query, field.dataSource, currentUserProfile);\r\n\r\n                // If in Assign Mode, only show technicians\r\n                if (isAssignMode && field.key === 'assigned_to' && field.dataSource === 'profiles') {\r\n                    query = query.eq('role', 'technician');\r\n                }\r\n\r\n                const { data } = await query;\r\n                if (data) {\r\n                    setLookupData(prev => ({ ...prev, [field.key]: data }));\r\n                }\r\n            } catch (e) {\r\n                console.error(`Error fetching lookup data for ${field.key}`, e);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleChange = (key: string, value: any) => {\r\n        setFormData(prev => ({ ...prev, [key]: value }));\r\n    };\r\n\r\n    const handleImageUpload = async (key: string, file: File) => {\r\n        setUploading(key);\r\n        setError(null);\r\n        try {\r\n            const compressed = await compressImage(file);\r\n            const url = await uploadToDrive(compressed as File);\r\n            setFormData(prev => ({ ...prev, [key]: url }));\r\n        } catch (e: any) {\r\n            setError('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + e.message);\r\n        } finally {\r\n            setUploading(null);\r\n        }\r\n    };\r\n\r\n    // GPS auto-fill â€” robust check that works with any lat/lng field naming\r\n    const isLatField = (f: FieldConfig) => {\r\n        const k = f.key.toLowerCase();\r\n        const l = (f.label || '').toLowerCase();\r\n        return k === 'latitude' || k === 'lat' || k.includes('_lat') || l.includes('latitude');\r\n    };\r\n    const isLngField = (f: FieldConfig) => {\r\n        const k = f.key.toLowerCase();\r\n        const l = (f.label || '').toLowerCase();\r\n        return k === 'longitude' || k === 'lng' || k === 'lon' || k.includes('_lng') || l.includes('longitude');\r\n    };\r\n    const hasGpsFields = form_config.fields.some(f => isLatField(f) || isLngField(f));\r\n\r\n    const handleGPS = async () => {\r\n        setGpsLoading(true);\r\n        setGpsSuccess(false);\r\n        try {\r\n            const coords = await getGeoLocation();\r\n            const updates: Record<string, number> = {};\r\n            form_config.fields.forEach(f => {\r\n                if (isLatField(f)) updates[f.key] = coords.lat;\r\n                if (isLngField(f)) updates[f.key] = coords.lng;\r\n            });\r\n            setFormData(prev => ({ ...prev, ...updates }));\r\n            setGpsSuccess(true);\r\n            setTimeout(() => setGpsSuccess(false), 3000);\r\n        } catch (e: any) {\r\n            setError(e.message);\r\n        } finally {\r\n            setGpsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            // Process form data...\r\n            const processedData = { ...formData };\r\n\r\n            // â”€â”€â”€ Stage 1: Geofencing for Ticket Creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n            if (table_name === 'tickets' && !isEdit) {\r\n                const isGeofenceEnabled = settings.geofencing_enabled === 'true';\r\n                const radius = parseInt(settings.geofencing_radius || '100');\r\n                const branchId = processedData.branch_id;\r\n\r\n                if (isGeofenceEnabled && branchId) {\r\n                    const { data: branch } = await supabase.from('branches').select('latitude, longitude').eq('id', branchId).single();\r\n                    if (branch?.latitude && branch?.longitude) {\r\n                        const coords = await getGeoLocation();\r\n                        const { calculateDistance } = await import('../../lib/geo');\r\n                        const dist = calculateDistance(coords.lat, coords.lng, branch.latitude, branch.longitude);\r\n\r\n                        if (dist > radius) {\r\n                            throw new Error(`Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ±Ø¹(Ø£Ù‚Ù„ Ù…Ù† ${radius}Ù…) Ù„ÙØªØ­ Ø¨Ù„Ø§Øº.Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${Math.round(dist)} Ù…ØªØ±.`);\r\n                        }\r\n\r\n                        // Store the reporting location\r\n                        processedData.reported_lat = coords.lat;\r\n                        processedData.reported_lng = coords.lng;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // [SINGULARITY FIX] Type Mutation Safety: Ensure we only parse if valid JSON object string\r\n            schema.form_config.fields.forEach(field => {\r\n                if (field.type === 'textarea' && processedData[field.key]) {\r\n                    const val = String(processedData[field.key]).trim();\r\n                    if (val.startsWith('{') || val.startsWith('[')) {\r\n                        try {\r\n                            const parsed = JSON.parse(val);\r\n                            if (typeof parsed === 'object') {\r\n                                processedData[field.key] = parsed;\r\n                            }\r\n                        } catch (e) {\r\n                            // Suppress parse errors for long textual inputs that happen to start with { or [\r\n                            // Fallback to raw text \r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            // â”€â”€â”€ Stage 2: Payload Cleaning (Whitelist valid columns only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n            const allowedKeys = new Set([\r\n                ...schema.form_config.fields.map(f => f.key),\r\n                'status', 'reported_lat', 'reported_lng', 'started_lat', 'started_lng',\r\n                'resolved_lat', 'resolved_lng', 'resolved_at', 'rating_score', 'rating_comment',\r\n                'asset_id', 'fault_type_id', 'downtime_start', 'submission_id', 'version'\r\n            ]);\r\n\r\n            const finalPayload: Record<string, any> = {};\r\n            Object.keys(processedData).forEach(key => {\r\n                // Only include keys in the schema or operational whitelist\r\n                // AND exclude objects/arrays that wasn't explicitly handled (like joined relation objects)\r\n                const val = processedData[key];\r\n                if (allowedKeys.has(key)) {\r\n                    finalPayload[key] = val;\r\n                }\r\n            });\r\n\r\n            if (isEdit) {\r\n                // AUTO-STATUS FOR ASSIGNMENT\r\n                if (isAssignMode) {\r\n                    finalPayload.status = 'assigned';\r\n                }\r\n\r\n                if (table_name === 'profiles') {\r\n                    // Update profile info (Exclude password/email virtual fields from public.profiles table update)\r\n                    const { password, ...updatePayload } = finalPayload;\r\n                    const { error: updateError } = await supabase\r\n                        .from(table_name as any)\r\n                        .update(updatePayload)\r\n                        .eq('id', record.id);\r\n                    if (updateError) throw updateError;\r\n                } else {\r\n                    // --- OPTIMISTIC LOCKING IMPLEMENTATION ---\r\n                    // We check the 'version' column. If it changed since we opened the modal, the update fails.\r\n                    const query = supabase\r\n                        .from(table_name as any)\r\n                        .update(finalPayload)\r\n                        .eq('id', record.id);\r\n\r\n                    // Only apply version check if version exists (to avoid breaking other tables)\r\n                    if (record.version !== undefined) {\r\n                        const { data: updateData, error: updateError } = await query\r\n                            .eq('version', record.version)\r\n                            .select();\r\n\r\n                        if (updateError) throw updateError;\r\n                        if (!updateData || updateData.length === 0) {\r\n                            throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù‚Ø§Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù†Ø´ØºØ§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');\r\n                        }\r\n                    } else {\r\n                        const { error: updateError } = await query;\r\n                        if (updateError) throw updateError;\r\n                    }\r\n                }\r\n            } else {\r\n                if (table_name === 'profiles') {\r\n                    // â”€â”€â”€ Create Employee via Admin API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n                    if (!supabaseAdmin) {\r\n                        throw new Error('Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø¯Ù…Ø© (Service Role Key) ØºÙŠØ± Ù…ÙØ¹Ø±ÙÙ‘Ù.');\r\n                    }\r\n\r\n                    const employeeCode = (finalPayload.employee_code || '').trim();\r\n                    const email = `${employeeCode} @fsc-system.local`;\r\n                    const password = finalPayload.password || '12345';\r\n\r\n                    const { data: newUser, error: createError } = await supabaseAdmin.auth.admin.createUser({\r\n                        email,\r\n                        password,\r\n                        email_confirm: true,\r\n                        user_metadata: {\r\n                            employee_code: employeeCode,\r\n                            full_name: finalPayload.full_name,\r\n                            role: finalPayload.role,\r\n                        },\r\n                    });\r\n                    if (createError) throw createError;\r\n\r\n                    const { error: profileError } = await supabase\r\n                        .from('profiles' as any)\r\n                        .upsert({\r\n                            id: newUser.user.id,\r\n                            employee_code: employeeCode,\r\n                            full_name: finalPayload.full_name,\r\n                            role: finalPayload.role,\r\n                            brand_id: finalPayload.brand_id,\r\n                            sector_id: finalPayload.sector_id,\r\n                            area_id: finalPayload.area_id,\r\n                            branch_id: finalPayload.branch_id,\r\n                        }, { onConflict: 'id' });\r\n                    if (profileError) throw profileError;\r\n                } else {\r\n                    const { error: insertError } = await supabase\r\n                        .from(table_name as any)\r\n                        .insert([finalPayload]);\r\n                    if (insertError) throw insertError;\r\n                }\r\n            }\r\n            showToast(isEdit ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');\r\n            onSuccess();\r\n        } catch (e: any) {\r\n            const errorMsg = e.message || 'ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© Ø­ØµÙ„Øª ÙˆØ¥Ø­Ù†Ø§ Ø¨Ù†Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';\r\n            setError(errorMsg);\r\n            showToast(errorMsg, 'error');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const title = isAssignMode ? (actionTitle || 'ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù„ÙƒØ§Ø¯Ø± ÙÙ†ÙŠ Ù…Ø¹ØªÙ…Ø¯') : isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©' : form_config.title || 'ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯';\r\n\r\n    const renderFormContent = () => (\r\n        <div className=\"flex flex-col\">\r\n            <div className=\"flex-1\">\r\n                <form id=\"sovereign-form\" onSubmit={handleSubmit} className=\"space-y-5\">\r\n                    {error && (\r\n                        <div className=\"p-3 bg-red-50 text-red-600 rounded-lg text-sm border border-red-100 dark:bg-red-900/20 dark:text-red-400 dark:border-red-900/30\">\r\n                            {error}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* GPS Auto-fill Banner â€” shows only when form has lat/lng fields */}\r\n                    {hasGpsFields && (\r\n                        <div className=\"flex items-center justify-between bg-teal-50 border border-teal-200 rounded-xl px-4 py-3 dark:bg-teal-900/20 dark:border-teal-900/30\">\r\n                            <div className=\"flex items-center gap-2 text-teal-700 dark:text-teal-400\">\r\n                                <MapPin className=\"w-4 h-4 shrink-0\" />\r\n                                <span className=\"text-sm font-medium\">\r\n                                    {gpsSuccess ? 'âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.' : 'Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¢Ù„ÙŠØ§Ù‹ (GPS)'}\r\n                                </span>\r\n                            </div>\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={handleGPS}\r\n                                disabled={gpsLoading}\r\n                                className=\"btn-3d flex items-center gap-1.5 px-3 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-xs font-semibold rounded-lg transition-all disabled:opacity-70 shrink-0\"\r\n                            >\r\n                                {gpsLoading\r\n                                    ? <Loader2 className=\"w-3.5 h-3.5 animate-spin\" />\r\n                                    : <Navigation className=\"w-3.5 h-3.5\" />\r\n                                }\r\n                                {gpsLoading ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©...' : 'Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹'}\r\n                            </button>\r\n                        </div>\r\n                    )}\r\n\r\n                    {form_config.fields.map((field) => {\r\n                        // If in Assign Mode, only show assigned_to/technician_id fields\r\n                        if (isAssignMode && field.key !== 'assigned_to') return null;\r\n\r\n                        // Hide password field in Edit mode for profiles (passwords managed via Auth/Admin)\r\n                        if (isEdit && table_name === 'profiles' && field.key === 'password') return null;\r\n\r\n                        return (\r\n                            <div key={field.key} className={field.type === 'hidden' ? 'hidden' : 'block'}>\r\n                                <label className=\"block text-sm font-semibold text-surface-700 dark:text-surface-300 mb-1.5\">\r\n                                    {field.label} {field.required && <span className=\"text-red-500\">*</span>}\r\n                                </label>\r\n\r\n                                {field.type === 'text' || field.type === 'number' || field.type === 'email' || field.type === 'date' || field.type === 'datetime' || field.type === 'color' ? (\r\n                                    <div className=\"relative group/field\">\r\n                                        <input\r\n                                            type={field.type === 'datetime' ? 'datetime-local' : field.type}\r\n                                            required={field.required}\r\n                                            placeholder={field.placeholder}\r\n                                            value={formData[field.key] || ''}\r\n                                            onChange={(e) => handleChange(field.key, e.target.value)}\r\n                                            className={clsx(\r\n                                                \"w-full px-4 py-2.5 bg-surface-50 border border-surface-200 rounded-xl text-surface-900 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all font-bold dark:bg-surface-800/80 dark:border-surface-700 dark:text-white dark:placeholder-surface-500\",\r\n                                                field.scanable && \"pl-12\",\r\n                                                field.type === 'color' && \"h-12 p-1 cursor-pointer\"\r\n                                            )}\r\n                                        />\r\n                                        {field.scanable && (\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setActiveScannerField(field.key)}\r\n                                                className=\"absolute left-2 top-1/2 -translate-y-1/2 p-2 text-surface-500 hover:text-brand-blaban hover:bg-brand-blaban/10 rounded-lg transition-all\"\r\n                                                title=\"Ø§Ù…Ø³Ø­ QR Code\"\r\n                                            >\r\n                                                <QrCode className=\"w-5 h-5\" />\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                ) : field.type === 'checkbox' ? (\r\n                                    <label className=\"flex items-center gap-3 p-3 bg-surface-50 border border-surface-200 rounded-xl cursor-pointer hover:bg-surface-100 dark:bg-surface-800 dark:border-surface-700 dark:hover:bg-surface-700 transition-all\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={!!formData[field.key]}\r\n                                            onChange={(e) => handleChange(field.key, e.target.checked)}\r\n                                            className=\"w-5 h-5 rounded border-surface-600 text-brand-blaban focus:ring-brand-blaban bg-surface-900\"\r\n                                        />\r\n                                        <span className=\"text-sm font-black text-white\">{field.placeholder || field.label}</span>\r\n                                    </label>\r\n                                ) : field.type === 'textarea' ? (\r\n                                    <textarea\r\n                                        required={field.required}\r\n                                        placeholder={field.placeholder}\r\n                                        value={formData[field.key] || ''}\r\n                                        rows={4}\r\n                                        onChange={(e) => handleChange(field.key, e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-surface-50 border border-surface-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all text-surface-900 dark:bg-surface-800 dark:border-surface-700 dark:text-white dark:placeholder-surface-500\"\r\n                                    />\r\n                                ) : field.type === 'select' ? (\r\n                                    <select\r\n                                        required={field.required}\r\n                                        value={formData[field.key] || ''}\r\n                                        disabled={field.key === 'branch_id' && currentUserProfile?.role === 'manager' && settings.restrict_branch_submission === 'true'}\r\n                                        onChange={(e) => handleChange(field.key, e.target.value)}\r\n                                        className=\"w-full px-4 py-2.5 bg-surface-800/80 border border-surface-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-blaban/30 focus:border-brand-blaban transition-all text-white disabled:opacity-60\"\r\n                                    >\r\n                                        <option value=\"\" disabled>-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø®Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>\r\n                                        {field.dataSource && lookupData[field.key] ? (\r\n                                            lookupData[field.key].map(opt => (\r\n                                                <option key={opt[field.dataValue || 'id']} value={opt[field.dataValue || 'id']}>\r\n                                                    {opt[field.dataLabel || 'name'] || opt.full_name || opt.id}\r\n                                                </option>\r\n                                            ))\r\n                                        ) : field.options ? (\r\n                                            field.options.map(opt => (\r\n                                                <option key={opt.value} value={opt.value}>\r\n                                                    {opt.label}\r\n                                                </option>\r\n                                            ))\r\n                                        ) : null}\r\n                                    </select>\r\n                                ) : field.type === 'image' ? (\r\n                                    <div className=\"space-y-3\">\r\n                                        {formData[field.key] ? (\r\n                                            <div className=\"relative w-full aspect-video rounded-xl border border-surface-200 overflow-hidden bg-surface-50\">\r\n                                                <img src={formData[field.key]} alt={field.label} className=\"w-full h-full object-cover\" />\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => handleChange(field.key, null)}\r\n                                                    className=\"absolute top-2 right-2 p-1.5 bg-surface-900/80 hover:bg-surface-900 text-red-500 rounded-full shadow-md backdrop-blur-sm\"\r\n                                                >\r\n                                                    <X className=\"w-4 h-4\" />\r\n                                                </button>\r\n                                            </div>\r\n                                        ) : (\r\n                                            <div className=\"relative group\">\r\n                                                <input\r\n                                                    type=\"file\"\r\n                                                    accept=\"image/*\"\r\n                                                    capture=\"environment\"\r\n                                                    onChange={(e) => e.target.files?.[0] && handleImageUpload(field.key, e.target.files[0])}\r\n                                                    className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10\"\r\n                                                    disabled={!!uploading}\r\n                                                />\r\n                                                <div className=\"flex flex-col items-center justify-center p-8 border-2 border-dashed border-surface-200 group-hover:border-primary-400 bg-surface-50 rounded-2xl transition-all dark:bg-surface-800 dark:border-surface-700 dark:group-hover:border-primary-500\">\r\n                                                    {uploading === field.key ? (\r\n                                                        <Loader2 className=\"w-8 h-8 text-primary-500 animate-spin\" />\r\n                                                    ) : (\r\n                                                        <Upload className=\"w-8 h-8 text-surface-400 dark:text-surface-500 group-hover:text-primary-500 mb-2 transition-colors\" />\r\n                                                    )}\r\n                                                    <span className=\"text-sm text-surface-500 font-medium dark:text-surface-400\">\r\n                                                        {uploading === field.key ? 'Ù‚ÙŠØ¯ Ø¶ØºØ· ÙˆØ±ÙØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø±Ù‚Ù…ÙŠØ©...' : 'Ø§Ù„Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø¥Ø±ÙØ§Ù‚ Ø£Ùˆ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ØªÙˆØ«ÙŠÙ‚ÙŠØ©'}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                ) : null}\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </form>\r\n            </div>\r\n\r\n            <div className=\"mt-8 flex justify-end gap-3\">\r\n                <button\r\n                    type=\"button\"\r\n                    onClick={onClose}\r\n                    className=\"flex-1 px-6 py-4 bg-surface-800 text-white rounded-2xl font-black transition-all hover:bg-surface-700\"\r\n                >\r\n                    Ø¥Ù„ØºØ§Ø¡\r\n                </button>\r\n                <button\r\n                    type=\"submit\"\r\n                    form=\"sovereign-form\"\r\n                    disabled={loading}\r\n                    className=\"flex-1 px-6 py-4 bg-brand-blaban text-white rounded-2xl font-black shadow-xl shadow-brand-blaban/30 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 flex items-center justify-center gap-2\"\r\n                >\r\n                    {loading && <Loader2 className=\"w-5 h-5 animate-spin\" />}\r\n                    {isEdit ? 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    if (isMobile) {\r\n        return (\r\n            <BottomSheet isOpen={isOpen} onClose={onClose} title={title}>\r\n                {renderFormContent()}\r\n            </BottomSheet>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n            {/* Backdrop */}\r\n            <div className=\"absolute inset-0 bg-surface-900/40 backdrop-blur-sm\" onClick={onClose}></div>\r\n\r\n            {/* Modal Content */}\r\n            <div className=\"relative glass-premium w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] transition-colors duration-500\">\r\n                <div className=\"absolute inset-0 bg-white/40 dark:bg-surface-950/60 -z-10\" />\r\n                <div className=\"p-8 border-b border-white/10 flex justify-between items-center bg-transparent\">\r\n                    <h3 className=\"text-2xl font-black text-white font-outfit tracking-tight\">{title}</h3>\r\n                    <button onClick={onClose} className=\"p-2.5 text-surface-500 hover:text-brand-blaban hover:bg-brand-blaban/10 rounded-full transition-all\">\r\n                        <X className=\"w-6 h-6\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"overflow-y-auto p-6 text-right\">\r\n                    {renderFormContent()}\r\n                </div>\r\n            </div>\r\n\r\n            {/* QR Scanner Overlay */}\r\n            {activeScannerField && (\r\n                <QRScanner\r\n                    onScan={(text) => {\r\n                        handleChange(activeScannerField, text);\r\n                        setActiveScannerField(null);\r\n                    }}\r\n                    onClose={() => setActiveScannerField(null)}\r\n                    title={`Ù…Ø³Ø­ ÙƒÙˆØ¯: ${form_config.fields.find(f => f.key === activeScannerField)?.label} `}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignFilterPanel.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'tableName'. Either exclude it or remove the dependency array.","line":41,"column":8,"nodeType":"ArrayExpression","endLine":41,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [config]","fix":{"range":[1632,1651],"text":"[config]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { SOVEREIGN_REGISTRY } from '../../lib/sovereign';\r\nimport { X, Filter, RotateCcw, ChevronDown, Check } from 'lucide-react';\r\nimport clsx from 'clsx';\r\n\r\ninterface SovereignFilterPanelProps {\r\n    tableName: string;\r\n    filters: Record<string, any>;\r\n    onChange: (filters: Record<string, any>) => void;\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nexport default function SovereignFilterPanel({ tableName, filters, onChange, isOpen, onClose }: SovereignFilterPanelProps) {\r\n    const config = SOVEREIGN_REGISTRY[tableName];\r\n    const [lookupData, setLookupData] = useState<Record<string, any[]>>({});\r\n    const [localFilters, setLocalFilters] = useState<Record<string, any>>(filters);\r\n\r\n    // Sync local state with props when opened\r\n    useEffect(() => {\r\n        if (isOpen) setLocalFilters(filters);\r\n    }, [isOpen, filters]);\r\n\r\n    const fetchLookups = useCallback(async () => {\r\n        if (!config?.filterableColumns) return;\r\n\r\n        const lookupCols = config.filterableColumns.filter(c => c.type === 'select' && c.dataSource);\r\n\r\n        for (const col of lookupCols) {\r\n            if (!col.dataSource) continue;\r\n            try {\r\n                const { data } = await supabase.from(col.dataSource as any).select('*');\r\n                if (data) {\r\n                    setLookupData(prev => ({ ...prev, [col.key]: data }));\r\n                }\r\n            } catch (e) {\r\n                console.error(`Error fetching filter lookup for ${col.key}`, e);\r\n            }\r\n        }\r\n    }, [config, tableName]);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) fetchLookups();\r\n    }, [isOpen, fetchLookups]);\r\n\r\n    const handleApply = () => {\r\n        onChange(localFilters);\r\n        onClose();\r\n    };\r\n\r\n    const updateFilter = (key: string, value: any) => {\r\n        setLocalFilters(prev => ({ ...prev, [key]: value }));\r\n    };\r\n\r\n    const updateDateRange = (key: string, type: 'start' | 'end', value: string) => {\r\n        const currentRange = localFilters[key] || {};\r\n        const newRange = { ...currentRange, [type]: value };\r\n        if (!newRange.start && !newRange.end) {\r\n            setLocalFilters(prev => {\r\n                const updated = { ...prev };\r\n                delete updated[key];\r\n                return updated;\r\n            });\r\n        } else {\r\n            setLocalFilters(prev => ({\r\n                ...prev,\r\n                [key]: newRange\r\n            }));\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] flex justify-end\">\r\n            {/* Backdrop */}\r\n            <div\r\n                className=\"absolute inset-0 bg-surface-900/20 backdrop-blur-sm transition-opacity\"\r\n                onClick={onClose}\r\n            />\r\n\r\n            {/* Panel */}\r\n            <div className=\"relative w-full max-w-sm glass-premium h-full shadow-2xl flex flex-col animate-in slide-in-from-left sm:slide-in-from-right duration-500\">\r\n                <div className=\"absolute inset-0 bg-surface-950/80 -z-10\" />\r\n                <div className=\"p-6 border-b border-white/5 flex items-center justify-between bg-surface-900/50\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className=\"p-2.5 bg-brand-konafa text-white rounded-xl shadow-lg shadow-brand-konafa/30\">\r\n                            <Filter className=\"w-5 h-5\" />\r\n                        </div>\r\n                        <h3 className=\"text-2xl font-black text-surface-900 dark:text-white font-outfit tracking-tight\">ØªØ®ØµÙŠØµ Ø§Ù„Ø¨Ø­Ø«</h3>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"p-2 hover:bg-surface-800 rounded-full transition-colors\">\r\n                        <X className=\"w-6 h-6 text-surface-500\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"flex-1 overflow-y-auto p-6 space-y-8\">\r\n                    {config?.filterableColumns?.map((col) => (\r\n                        <div key={col.key} className=\"space-y-3\">\r\n                            <label className=\"text-sm font-bold text-surface-600 dark:text-surface-400 flex items-center gap-2\">\r\n                                {col.label}\r\n                                {localFilters[col.key] && (\r\n                                    <span className=\"w-2 h-2 bg-primary-500 rounded-full animate-pulse\" />\r\n                                )}\r\n                            </label>\r\n\r\n                            {col.type === 'status' ? (\r\n                                <div className=\"flex flex-wrap gap-2\">\r\n                                    {Object.entries(config.formatting?.statusLabels || {}).map(([val, label]) => {\r\n                                        const isSelected = localFilters[col.key] === val;\r\n                                        return (\r\n                                            <button\r\n                                                key={val}\r\n                                                onClick={() => updateFilter(col.key, isSelected ? null : val)}\r\n                                                className={clsx(\r\n                                                    \"px-3 py-1.5 rounded-lg text-sm font-medium border transition-all\",\r\n                                                    isSelected\r\n                                                        ? \"bg-brand-blaban text-white border-brand-blaban shadow-lg scale-105\"\r\n                                                        : \"bg-surface-800 text-surface-400 border-surface-700 hover:border-brand-blaban\"\r\n                                                )}\r\n                                            >\r\n                                                {label}\r\n                                            </button>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            ) : col.type === 'select' ? (\r\n                                <div className=\"relative group\">\r\n                                    <select\r\n                                        value={localFilters[col.key] || ''}\r\n                                        onChange={(e) => updateFilter(col.key, e.target.value)}\r\n                                        className=\"w-full pl-10 pr-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-blaban/30 focus:border-brand-blaban transition-all appearance-none cursor-pointer text-white\"\r\n                                    >\r\n                                        <option value=\"\">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>\r\n                                        {lookupData[col.key]?.map((item) => (\r\n                                            <option key={item.id} value={item.id} className=\"bg-surface-900 border-none\">\r\n                                                {item.name || item.full_name || item.label || item.id}\r\n                                            </option>\r\n                                        ))}\r\n                                    </select>\r\n                                    <ChevronDown className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-surface-500 pointer-events-none group-focus-within:rotate-180 transition-transform\" />\r\n                                </div>\r\n                            ) : col.type === 'date' ? (\r\n                                <div className=\"grid grid-cols-2 gap-3\">\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <span className=\"text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider pr-1\">Ù…Ù† ØªØ§Ø±ÙŠØ®</span>\r\n                                        <input\r\n                                            type=\"date\"\r\n                                            value={localFilters[col.key]?.start || ''}\r\n                                            onChange={(e) => updateDateRange(col.key, 'start', e.target.value)}\r\n                                            className=\"w-full px-3 py-2 bg-surface-800 border border-surface-700 rounded-xl text-xs focus:ring-2 focus:ring-brand-blaban/30 outline-none text-white\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-1.5\">\r\n                                        <span className=\"text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider pr-1\">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</span>\r\n                                        <input\r\n                                            type=\"date\"\r\n                                            value={localFilters[col.key]?.end || ''}\r\n                                            onChange={(e) => updateDateRange(col.key, 'end', e.target.value)}\r\n                                            className=\"w-full px-3 py-2 bg-surface-800 border border-surface-700 rounded-xl text-xs focus:ring-2 focus:ring-brand-blaban/30 outline-none text-white\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <input\r\n                                    type=\"text\"\r\n                                    placeholder={`Ø¨Ø­Ø« Ø¨Ù€ ${col.label}...`}\r\n                                    value={localFilters[col.key] || ''}\r\n                                    onChange={(e) => updateFilter(col.key, e.target.value)}\r\n                                    className=\"w-full px-4 py-2.5 bg-surface-800 border border-surface-700 rounded-xl text-sm focus:ring-2 focus:ring-brand-blaban/30 outline-none text-white placeholder:text-surface-500\"\r\n                                />\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                <div className=\"p-6 border-t border-white/5 bg-surface-900/50 flex flex-col gap-3\">\r\n                    <button\r\n                        onClick={handleApply}\r\n                        className=\"btn-3d w-full py-4 bg-brand-blaban text-white rounded-2xl font-black flex items-center justify-center gap-2 shadow-xl shadow-brand-blaban/30 transition-all active:scale-95 translate-y-0 hover:-translate-y-1\"\r\n                    >\r\n                        <Check className=\"w-5 h-5\" />\r\n                        <span>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>\r\n                    </button>\r\n                    <button\r\n                        onClick={() => onChange({})}\r\n                        className=\"w-full flex items-center justify-center gap-2 py-3 bg-surface-800 text-surface-400 rounded-xl text-sm font-bold hover:bg-surface-700 transition-all\"\r\n                    >\r\n                        <RotateCcw className=\"w-4 h-4\" />\r\n                        <span>Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignKPIBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignKPICard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchValue'. Either include it or remove the dependency array.","line":39,"column":40,"nodeType":"ArrayExpression","endLine":39,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [config, userId, profile, fetchValue]","fix":{"range":[2132,2157],"text":"[config, userId, profile, fetchValue]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { supabase } from '../../lib/supabase';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { TrendingUp, ArrowLeft } from 'lucide-react';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport * as LucideIcons from 'lucide-react';\r\nimport Skeleton from '../ui/Skeleton';\r\nimport { applyRBACFilter } from '../../lib/rbac';\r\n\r\nexport interface KPICardConfig {\r\n    label: string;\r\n    table: string;\r\n    aggregate: 'count' | 'sum' | 'avg';\r\n    aggregate_col?: string;          // for sum/avg\r\n    filter?: Record<string, any>; // e.g. { status: 'open' }\r\n    color: 'blue' | 'red' | 'green' | 'amber' | 'purple' | 'teal';\r\n    icon?: string;            // Lucide icon name\r\n    link_to?: string;            // route to navigate on click\r\n    description?: string;\r\n}\r\n\r\nconst COLOR_MAP: Record<string, { bg: string; icon: string; text: string; border: string; dot: string }> = {\r\n    blue: { bg: 'bg-blue-900/20', icon: 'text-blue-400', text: 'text-blue-100', border: 'border-blue-900/30', dot: 'bg-blue-500' },\r\n    red: { bg: 'bg-red-900/20', icon: 'text-red-400', text: 'text-red-100', border: 'border-red-900/30', dot: 'bg-red-500' },\r\n    green: { bg: 'bg-green-900/20', icon: 'text-green-400', text: 'text-green-100', border: 'border-green-900/30', dot: 'bg-emerald-500' },\r\n    amber: { bg: 'bg-amber-900/20', icon: 'text-amber-400', text: 'text-amber-100', border: 'border-amber-900/30', dot: 'bg-amber-500' },\r\n    purple: { bg: 'bg-purple-900/20', icon: 'text-purple-400', text: 'text-purple-100', border: 'border-purple-900/30', dot: 'bg-purple-500' },\r\n    teal: { bg: 'bg-teal-900/20', icon: 'text-teal-400', text: 'text-teal-100', border: 'border-teal-900/30', dot: 'bg-teal-500' },\r\n};\r\n\r\ninterface Props { config: KPICardConfig; userId?: string; }\r\n\r\nexport default function SovereignKPICard({ config, userId }: Props) {\r\n    const [value, setValue] = useState<number | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const navigate = useNavigate();\r\n    const { profile } = useAuth();\r\n\r\n    useEffect(() => { fetchValue(); }, [config, userId, profile]);\r\n\r\n    const fetchValue = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // â”€â”€â”€ RBAC Auto-Injection for KPIs â”€â”€â”€\r\n            let query = supabase.from(config.table).select('*', { count: 'exact', head: true });\r\n\r\n            // Apply standard filters from config\r\n            if (config.filter) {\r\n                for (const [col, val] of Object.entries(config.filter)) {\r\n                    query = query.eq(col, val === '$user_id' ? userId : val);\r\n                }\r\n            }\r\n\r\n            // Universal RBAC Filter\r\n            query = applyRBACFilter(query, config.table, profile as any);\r\n\r\n            const { count, error } = await query;\r\n\r\n            if (error) throw error;\r\n            setValue(Number(count) || 0);\r\n\r\n        } catch (e) {\r\n            console.error('KPI Fetch Error:', e);\r\n            setValue(null);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const colors = COLOR_MAP[config.color] || COLOR_MAP.blue;\r\n    const IconComp = config.icon ? (LucideIcons as any)[config.icon] : TrendingUp;\r\n\r\n    return (\r\n        <div\r\n            onClick={() => config.link_to && navigate(config.link_to)}\r\n            className={`glass-premium rounded-[2rem] border ${colors.border} p-6 flex items-center gap-5 transition-all relative overflow-hidden group\r\n                ${config.link_to ? 'cursor-pointer hover:shadow-2xl hover:-translate-y-1 hover:border-brand-blaban/50' : ''}`}\r\n        >\r\n            <div className={`w-16 h-16 ${colors.bg} ${colors.icon} rounded-2xl flex items-center justify-center shrink-0 border border-white/10 group-hover:scale-110 transition-transform duration-500 shadow-inner`}>\r\n                {IconComp && <IconComp className=\"w-8 h-8\" />}\r\n            </div>\r\n            <div className=\"flex-1 min-w-0\">\r\n                <div className=\"flex items-center gap-2 mb-0.5\">\r\n                    <div className={`w-1.5 h-1.5 rounded-full ${colors.dot} animate-pulse`} />\r\n                    <p className=\"text-xs font-bold text-surface-400 uppercase tracking-wider truncate\">{config.label}</p>\r\n                </div>\r\n                <h3 className={`text-3xl font-black ${colors.text} tracking-tighter font-outfit mt-1`}>\r\n                    {loading\r\n                        ? <Skeleton variant=\"rectangular\" width=\"4rem\" height=\"2rem\" />\r\n                        : (value?.toLocaleString('en-US') ?? 'â€”')\r\n                    }\r\n                </h3>\r\n                {config.description && <p className=\"text-[10px] text-surface-500 mt-1 font-medium\">{config.description}</p>}\r\n            </div>\r\n            {config.link_to && (\r\n                <div className=\"w-8 h-8 rounded-full bg-surface-800 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all translate-x-2 group-hover:translate-x-0\">\r\n                    <ArrowLeft className=\"w-4 h-4 text-brand-blaban rotate-180\" />\r\n                </div>\r\n            )}\r\n\r\n            {/* Decorative background element */}\r\n            <div className={`absolute -right-4 -bottom-4 w-20 h-20 ${colors.bg} rounded-full opacity-0 group-hover:opacity-20 transition-opacity blur-2xl`} />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\sovereign\\SovereignTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\ui\\BottomSheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\ui\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\ui\\QRScanner.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onClose' and 'onScan'. Either include them or remove the dependency array. If 'onScan' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":57,"column":8,"nodeType":"ArrayExpression","endLine":57,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [onClose, onScan]","fix":{"range":[1919,1921],"text":"[onClose, onScan]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState } from 'react';\r\nimport { Html5QrcodeScanner, Html5QrcodeSupportedFormats } from 'html5-qrcode';\r\nimport { X, Camera, RefreshCw } from 'lucide-react';\r\n\r\ninterface QRScannerProps {\r\n    onScan: (decodedText: string) => void;\r\n    onClose: () => void;\r\n    title?: string;\r\n}\r\n\r\nexport default function QRScanner({ onScan, onClose, title = 'Ù…Ø³Ø­ Ø±Ù…Ø² QR' }: QRScannerProps) {\r\n    const scannerRef = useRef<Html5QrcodeScanner | null>(null);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        // Initialize scanner\r\n        const scanner = new Html5QrcodeScanner(\r\n            \"reader\",\r\n            {\r\n                fps: 10,\r\n                qrbox: { width: 250, height: 250 },\r\n                aspectRatio: 1.0,\r\n                formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]\r\n            },\r\n            /* verbose= */ false\r\n        );\r\n\r\n        scanner.render(\r\n            (decodedText) => {\r\n                // Success\r\n                scanner.clear().then(() => {\r\n                    onScan(decodedText);\r\n                    onClose();\r\n                }).catch(err => {\r\n                    console.error(\"Failed to clear scanner\", err);\r\n                    onScan(decodedText);\r\n                    onClose();\r\n                });\r\n            },\r\n            (errorMessage) => {\r\n                // Silently ignore framing errors\r\n                if (errorMessage.includes(\"No MultiFormat Readers were able to detect the code\")) {\r\n                    return;\r\n                }\r\n                setError(errorMessage);\r\n            }\r\n        );\r\n\r\n        scannerRef.current = scanner;\r\n\r\n        // Cleanup on unmount\r\n        return () => {\r\n            if (scannerRef.current) {\r\n                scannerRef.current.clear().catch(err => console.error(\"Cleanup failed\", err));\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] bg-surface-900 flex flex-col items-center justify-center p-4\">\r\n            {/* Header */}\r\n            <div className=\"absolute top-0 left-0 right-0 p-6 flex justify-between items-center text-white z-10 bg-gradient-to-b from-black/50 to-transparent\">\r\n                <h3 className=\"text-xl font-bold\">{title}</h3>\r\n                <button\r\n                    onClick={onClose}\r\n                    className=\"p-2 bg-white/20 hover:bg-white/30 rounded-full backdrop-blur-md transition-all\"\r\n                >\r\n                    <X className=\"w-6 h-6\" />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Scanner Container */}\r\n            <div className=\"w-full max-w-sm aspect-square bg-surface-800 rounded-3xl overflow-hidden relative border-4 border-white/20 shadow-2xl\">\r\n                <div id=\"reader\" className=\"w-full h-full\"></div>\r\n\r\n                {/* Overlay UI */}\r\n                <div className=\"absolute inset-0 pointer-events-none flex flex-col items-center justify-center\">\r\n                    {/* Scanner Frame corner markers */}\r\n                    <div className=\"w-64 h-64 border-2 border-primary-400 rounded-2xl relative\">\r\n                        <div className=\"absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-primary-500 rounded-tl-lg\"></div>\r\n                        <div className=\"absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-primary-500 rounded-tr-lg\"></div>\r\n                        <div className=\"absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-primary-500 rounded-bl-lg\"></div>\r\n                        <div className=\"absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-primary-500 rounded-br-lg\"></div>\r\n\r\n                        {/* Scanning Line Animation */}\r\n                        <div className=\"absolute inset-x-4 top-0 h-1 bg-primary-500/50 shadow-[0_0_15px_rgba(20,184,166,0.8)] animate-scan-line\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Hint */}\r\n            <div className=\"mt-8 text-center text-white/70 space-y-4\">\r\n                <div className=\"flex items-center justify-center gap-2\">\r\n                    <Camera className=\"w-5 h-5 text-primary-400\" />\r\n                    <p className=\"text-sm font-medium\">Ø¶Ø¹ Ø±Ù…Ø² Ø§Ù„Ù€ QR Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ù„Ù„Ù…Ø³Ø­</p>\r\n                </div>\r\n                <button\r\n                    onClick={() => window.location.reload()}\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-white/10 rounded-xl text-xs hover:bg-white/20 transition-all mx-auto\"\r\n                >\r\n                    <RefreshCw className=\"w-3.5 h-3.5\" /> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§\r\n                </button>\r\n            </div>\r\n\r\n            {error && (\r\n                <div className=\"mt-4 p-3 bg-red-500/20 border border-red-500/50 text-red-200 text-sm rounded-xl backdrop-blur-sm\">\r\n                    {error}\r\n                </div>\r\n            )}\r\n\r\n            <style>{`\r\n                #reader { border: none !important; }\r\n                #reader video { \r\n                    object-fit: cover !important; \r\n                    width: 100% !important; \r\n                    height: 100% !important; \r\n                    border-radius: 1.5rem !important;\r\n                }\r\n                #reader__scan_region { background: transparent !important; }\r\n                #reader__dashboard { display: none !important; }\r\n                \r\n                @keyframes scan-line {\r\n                    0% { top: 0; }\r\n                    100% { top: 100%; }\r\n                }\r\n                .animate-scan-line {\r\n                    animation: scan-line 2s linear infinite;\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\ui\\Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\components\\ui\\ToastContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\contexts\\AuthContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":99,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":99,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useEffect, useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { User, Session } from '@supabase/supabase-js';\r\n\r\n// No email visible to user. Fake domain logic.\r\nexport const FAKE_DOMAIN = '@fsc-system.local';\r\n\r\ninterface Profile {\r\n    id: string;\r\n    employee_code: string;\r\n    full_name: string;\r\n    role: 'admin' | 'brand_ops_manager' | 'sector_manager' | 'area_manager' | 'manager' | 'maint_manager' | 'maint_supervisor' | 'technician';\r\n    branch_id?: string | null;\r\n    brand_id?: string | null;\r\n    sector_id?: string | null;\r\n    area_id?: string | null;\r\n    base_daily_rate?: number;\r\n    per_km_allowance?: number;\r\n    star_bonus_rate?: number;\r\n}\r\n\r\ninterface AuthContextType {\r\n    user: User | null;\r\n    session: Session | null;\r\n    profile: Profile | null;\r\n    isLoading: boolean;\r\n    signIn: (employeeCode: string, password: string) => Promise<{ error: Error | null }>;\r\n    signOut: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [user, setUser] = useState<User | null>(null);\r\n    const [session, setSession] = useState<Session | null>(null);\r\n    const [profile, setProfile] = useState<Profile | null>(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n\r\n    const fetchProfile = async (userId: string) => {\r\n        try {\r\n            const { data, error } = await supabase\r\n                .from('profiles')\r\n                .select('*')\r\n                .eq('id', userId)\r\n                .single();\r\n\r\n            if (data && !error) {\r\n                setProfile(data as Profile);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error fetching profile\", e);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        // Initial fetch\r\n        supabase.auth.getSession().then(({ data: { session } }) => {\r\n            setSession(session);\r\n            setUser(session?.user ?? null);\r\n            if (session?.user) fetchProfile(session.user.id);\r\n            setIsLoading(false);\r\n        });\r\n\r\n        // Listen to changes\r\n        const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n            (_event, session) => {\r\n                setSession(session);\r\n                setUser(session?.user ?? null);\r\n                if (session?.user) fetchProfile(session.user.id);\r\n                else setProfile(null);\r\n                setIsLoading(false);\r\n            }\r\n        );\r\n\r\n        return () => subscription.unsubscribe();\r\n    }, []);\r\n\r\n    const signIn = async (employeeCode: string, password: string) => {\r\n        // Hidden transformation bridging Employee Code to Email format internally\r\n        const email = `${employeeCode.trim()}${FAKE_DOMAIN}`;\r\n        const { error } = await supabase.auth.signInWithPassword({\r\n            email,\r\n            password,\r\n        });\r\n        return { error };\r\n    };\r\n\r\n    const signOut = async () => {\r\n        await supabase.auth.signOut();\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={{ user, session, profile, isLoading, signIn, signOut }}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useAuth = () => {\r\n    const context = useContext(AuthContext);\r\n    if (context === undefined) {\r\n        throw new Error('useAuth must be used within an AuthProvider');\r\n    }\r\n    return context;\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\contexts\\ToastContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":41,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":41,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useCallback, ReactNode } from 'react';\r\nimport ToastContainer from '../components/ui/ToastContainer';\r\n\r\nexport type ToastType = 'success' | 'error' | 'warning' | 'info';\r\n\r\ninterface Toast {\r\n    id: string;\r\n    message: string;\r\n    type: ToastType;\r\n}\r\n\r\ninterface ToastContextType {\r\n    showToast: (message: string, type: ToastType) => void;\r\n}\r\n\r\nconst ToastContext = createContext<ToastContextType | undefined>(undefined);\r\n\r\nexport function ToastProvider({ children }: { children: ReactNode }) {\r\n    const [toasts, setToasts] = useState<Toast[]>([]);\r\n\r\n    const showToast = useCallback((message: string, type: ToastType) => {\r\n        const id = Math.random().toString(36).substring(2, 9);\r\n        setToasts(prev => [...prev, { id, message, type }]);\r\n        setTimeout(() => {\r\n            setToasts(prev => prev.filter(t => t.id !== id));\r\n        }, 5000);\r\n    }, []);\r\n\r\n    const removeToast = useCallback((id: string) => {\r\n        setToasts(prev => prev.filter(t => t.id !== id));\r\n    }, []);\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ showToast }}>\r\n            {children}\r\n            <ToastContainer toasts={toasts} onRemove={removeToast} />\r\n        </ToastContext.Provider>\r\n    );\r\n}\r\n\r\nexport function useToast() {\r\n    const context = useContext(ToastContext);\r\n    if (!context) throw new Error('useToast must be used within a ToastProvider');\r\n    return context;\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\drive.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\geo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\image.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\offlineQueue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\power.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\rbac.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\sovereign-dictionary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\sovereign.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\auth\\pages\\Login.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\core\\hooks\\useSovereign.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'fetchMetrics'. Either include it or remove the dependency array.","line":173,"column":8,"nodeType":"ArrayExpression","endLine":173,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [tableName, fetchCount, fetchMetrics, loadPage]","fix":{"range":[6702,6735],"text":"[tableName, fetchCount, fetchMetrics, loadPage]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'applyFilters' and 'totalCount'. Either include them or remove the dependency array.","line":227,"column":8,"nodeType":"ArrayExpression","endLine":227,"endColumn":51,"suggestions":[{"desc":"Update the dependencies array to be: [totalCount, tableName, applyFilters, profile, data]","fix":{"range":[8916,8959],"text":"[totalCount, tableName, applyFilters, profile, data]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useCallback } from 'react';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { UISchema, ListConfig } from '@/types/schema';\r\n\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { applyRBACFilter, getSecureProfileSelect, getRBACSelect } from '@/lib/rbac';\r\nimport { SOVEREIGN_REGISTRY } from '@/lib/sovereign';\r\n\r\nconst PAGE_SIZE = 50;\r\n\r\nexport function useSovereign(tableName: string) {\r\n\r\n    const { profile } = useAuth();\r\n\r\n    const [schema, setSchema] = useState<UISchema | null>(null);\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [filters, setFilters] = useState<Record<string, any>>({});\r\n    const [metricsData, setMetricsData] = useState<Record<string, number>>({});\r\n\r\n    // â”€â”€â”€ Relation Joins â€” To show names instead of IDs â”€â”€â”€\r\n    const getSelectString = useCallback(() => {\r\n        const config = SOVEREIGN_REGISTRY[tableName];\r\n        if (tableName === 'profiles') {\r\n            return getSecureProfileSelect(profile?.role || '');\r\n        }\r\n        if (config) return config.selectString;\r\n        return '*';\r\n    }, [tableName, profile?.role]);\r\n\r\n    // â”€â”€â”€ Pagination State â”€â”€â”€\r\n    const [page, setPage] = useState(0); // 0-indexed\r\n    const [totalCount, setTotalCount] = useState(0);\r\n    const [schemaCache, setSchemaCache] = useState<ListConfig | null>(null);\r\n\r\n    const totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));\r\n\r\n    // â”€â”€â”€ Helper: Apply Active Filters â”€â”€â”€\r\n    const applyFilters = useCallback((query: any) => {\r\n        let q = query;\r\n        Object.entries(filters).forEach(([key, value]) => {\r\n            if (value === undefined || value === null || value === '') return;\r\n\r\n            if (typeof value === 'object' && ('start' in value || 'end' in value)) {\r\n                // Date Range\r\n                if (value.start) q = q.gte(key, value.start);\r\n                if (value.end) q = q.lte(key, value.end);\r\n            } else if (Array.isArray(value)) {\r\n                // Multi-select matches\r\n                if (value.length > 0) q = q.in(key, value);\r\n            } else {\r\n                // Exact match (Select/Status)\r\n                q = q.eq(key, value);\r\n            }\r\n        });\r\n        return q;\r\n    }, [filters]);\r\n\r\n    // â”€â”€â”€ Fetch Count â”€â”€â”€\r\n    const fetchCount = useCallback(async () => {\r\n        try {\r\n            // [RESCUE FIX] Use RBAC select string to ensure joins are present for filtering\r\n            let query = supabase.from(tableName as any).select(getRBACSelect(tableName), { count: 'exact', head: true });\r\n            query = query.eq('is_deleted', false);\r\n            query = applyFilters(query);\r\n            query = applyRBACFilter(query, tableName, profile);\r\n\r\n            const { count, error: countError } = await query;\r\n\r\n            if (countError) {\r\n                console.error('Count error:', countError);\r\n            } else {\r\n                setTotalCount(count || 0);\r\n            }\r\n        } catch { /* silent */ }\r\n    }, [tableName, profile, applyFilters]);\r\n\r\n    // â”€â”€â”€ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ (KPIs) - ØªØ­Ø¯ÙŠØ« QUANTUM Ù…Ø¬Ù…Ø¹ â”€â”€â”€\r\n    const fetchMetrics = useCallback(async (currentSchema?: UISchema) => {\r\n        const activeSchema = currentSchema || schema;\r\n        const config = SOVEREIGN_REGISTRY[tableName];\r\n        const metrics = config?.metrics || activeSchema?.page_config?.kpi_cards;\r\n\r\n        if (!metrics || metrics.length === 0) return;\r\n\r\n        try {\r\n            // [QUANTUM FIX] ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø·Ù„Ø¨ RPC ÙˆØ§Ø­Ø¯ Ù…Ø¬Ù…Ø¹ Ù„Ù…Ù†Ø¹ Ø§Ø³ØªÙ†Ø²Ø§Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\r\n            const { data: results, error: metricsError } = await supabase.rpc('get_table_metrics', {\r\n                p_table_name: tableName,\r\n                p_metrics: metrics\r\n            });\r\n\r\n            if (metricsError) throw metricsError;\r\n            setMetricsData(results || {});\r\n        } catch (e) {\r\n            console.error('Metrics RPC error', e);\r\n            // Fallback for safety\r\n            setMetricsData({});\r\n        }\r\n    }, [tableName, schema]);\r\n\r\n    // â”€â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø© (Pagination) â”€â”€â”€\r\n    const loadPage = useCallback(async (config: ListConfig, pageNum: number) => {\r\n        try {\r\n            const from = pageNum * PAGE_SIZE;\r\n            const to = from + PAGE_SIZE - 1;\r\n\r\n            // ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… select string Ù…Ø®Ø²ÙˆÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹\r\n            let query = supabase.from(tableName as any).select(getSelectString());\r\n\r\n            // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒÙŠ\r\n            query = query.eq('is_deleted', false);\r\n\r\n            // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©\r\n            query = applyFilters(query);\r\n\r\n            // ØªØ·Ø¨ÙŠÙ‚ Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (RBAC)\r\n            query = applyRBACFilter(query, tableName, profile);\r\n\r\n            // ØªØ­Ø³ÙŠÙ†: Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ø°ÙƒÙŠ\r\n            if (config.defaultSort) {\r\n                query = query.order(config.defaultSort.column, { ascending: config.defaultSort.ascending });\r\n            } else {\r\n                query = query.order('created_at', { ascending: false });\r\n            }\r\n\r\n            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„Ø¨Ùˆ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª\r\n            query = query.range(from, to);\r\n\r\n            const { data: rows, error: rowsError } = await query;\r\n\r\n            if (rowsError) {\r\n                throw rowsError;\r\n            } else {\r\n                setData(rows || []);\r\n            }\r\n        } catch (e: any) {\r\n            console.error(`Error loading data for ${tableName}:`, e);\r\n            throw e;\r\n        }\r\n    }, [tableName, profile, applyFilters, getSelectString]);\r\n\r\n    // â”€â”€â”€ Initial Fetch (Schema + First Page + Count) â”€â”€â”€\r\n    const fetchAll = useCallback(async () => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            // 1. Fetch Schema\r\n            const { data: schemaData, error: schemaError } = await supabase\r\n                .from('ui_schemas')\r\n                .select('*')\r\n                .eq('table_name', tableName)\r\n                .single();\r\n\r\n            if (schemaError) throw new Error(`Schema not found for table: ${tableName}`);\r\n            setSchema(schemaData as UISchema);\r\n            setSchemaCache(schemaData.list_config);\r\n\r\n            // 2. Fetch Count + Metrics + First Page in parallel\r\n            await Promise.all([\r\n                fetchCount(),\r\n                fetchMetrics(schemaData as UISchema),\r\n                loadPage(schemaData.list_config, 0),\r\n            ]);\r\n            setPage(0);\r\n\r\n        } catch (e: any) {\r\n            setError(e.message || 'Unknown error fetching sovereign data');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [tableName, loadPage, fetchCount]);\r\n\r\n    // â”€â”€â”€ Page Change Handler â”€â”€â”€\r\n    const goToPage = useCallback(async (newPage: number) => {\r\n        if (newPage < 0 || newPage >= totalPages || !schemaCache) return;\r\n        setLoading(true);\r\n        try {\r\n            await loadPage(schemaCache, newPage);\r\n            setPage(newPage);\r\n        } catch (e: any) {\r\n            setError(e.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [totalPages, schemaCache, loadPage]);\r\n\r\n    // â”€â”€â”€ Fetch ALL rows (Chunked for Memory Safety) â”€â”€â”€\r\n    const fetchAllRows = useCallback(async (): Promise<any[]> => {\r\n        const MAX_EXPORT_LIMIT = 10000; // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù†ÙØ¬Ø§Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø©\r\n        try {\r\n            if (totalCount > MAX_EXPORT_LIMIT) {\r\n                alert(`ØªÙ†Ø¨ÙŠÙ‡: Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${totalCount.toLocaleString('ar-EG')} Ø³Ø¬Ù„). Ø³ÙŠØªÙ… ØªØµØ¯ÙŠØ± Ø£ÙˆÙ„ ${MAX_EXPORT_LIMIT.toLocaleString('ar-EG')} Ø³Ø¬Ù„ ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­.`);\r\n            }\r\n\r\n            let allRows: any[] = [];\r\n            let hasMore = true;\r\n            let offset = 0;\r\n            const CHUNK_SIZE = 1000;\r\n\r\n            while (hasMore) {\r\n                let query = supabase.from(tableName as any).select(getRBACSelect(tableName));\r\n                query = query.eq('is_deleted', false);\r\n                query = applyFilters(query);\r\n                query = applyRBACFilter(query, tableName, profile);\r\n                query = query.order('created_at', { ascending: false });\r\n                query = query.range(offset, offset + CHUNK_SIZE - 1);\r\n\r\n                const { data: rows, error: rowsError } = await query;\r\n\r\n                if (rowsError) throw rowsError;\r\n\r\n                if (rows && rows.length > 0) {\r\n                    allRows = [...allRows, ...rows];\r\n                    offset += CHUNK_SIZE;\r\n                    if (rows.length < CHUNK_SIZE || allRows.length >= MAX_EXPORT_LIMIT) hasMore = false;\r\n                } else {\r\n                    hasMore = false;\r\n                }\r\n            }\r\n            return allRows;\r\n        } catch (e) {\r\n            console.error('Export Error:', e);\r\n            return data; // fallback to current page data\r\n        }\r\n    }, [tableName, data, profile, getSelectString]);\r\n\r\n\r\n    useEffect(() => {\r\n        fetchAll();\r\n\r\n        // Systemic Realtime Upgrade: Auto-sync any data changes globally\r\n        const channel = supabase.channel(`sovereign-live-${tableName}`)\r\n            .on('postgres_changes', { event: '*', schema: 'public', table: tableName }, () => {\r\n                // Debounce/Throttle is handled inside the Realtime callback if needed\r\n                fetchAll();\r\n            })\r\n            .subscribe();\r\n\r\n        return () => {\r\n            channel.unsubscribe();\r\n        };\r\n    }, [tableName, fetchAll]); // filters removed as they are used inside fetchAll which is already debounced/stabilized\r\n\r\n    return {\r\n        schema,\r\n        data,\r\n        loading,\r\n        error,\r\n        refetch: fetchAll,\r\n        filters,\r\n        setFilters,\r\n        metricsData,\r\n        setData,\r\n        // Pagination\r\n        page,\r\n        totalPages,\r\n        totalCount,\r\n        pageSize: PAGE_SIZE,\r\n        goToPage,\r\n        fetchAllRows,\r\n    };\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\dashboard\\pages\\Dashboard.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'debouncedLoadStats', 'loadKPICards', and 'loadStats'. Either include them or remove the dependency array.","line":86,"column":8,"nodeType":"ArrayExpression","endLine":86,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [debouncedLoadStats, loadKPICards, loadStats, profile]","fix":{"range":[5669,5678],"text":"[debouncedLoadStats, loadKPICards, loadStats, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport SovereignKPICard, { KPICardConfig } from '@/components/sovereign/SovereignKPICard';\r\nimport { Users, Clock, ClipboardList, Timer, Map, Wrench, Package, AlertTriangle } from 'lucide-react';\r\nimport ShiftStatus from '@/components/layout/ShiftStatus';\r\nimport Skeleton from '@/components/ui/Skeleton';\r\n\r\n// Fallback static KPI cards if no schema defines them\r\nconst DEFAULT_ADMIN_KPIS: KPICardConfig[] = [\r\n    { label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª', table: 'tickets', aggregate: 'count', color: 'blue', icon: 'Wrench', link_to: '/manage/tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', table: 'tickets', aggregate: 'count', filter: { status: 'in_progress' }, color: 'amber', icon: 'Activity', link_to: '/manage/tickets' },\r\n    { label: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨ÙŠ', table: 'tickets', aggregate: 'count', filter: { status: 'resolved' }, color: 'red', icon: 'AlertTriangle', link_to: '/manage/tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', table: 'tickets', aggregate: 'count', filter: { status: 'closed' }, color: 'green', icon: 'CheckCircle', link_to: '/manage/tickets' },\r\n];\r\nconst DEFAULT_MANAGER_KPIS: (userId: string) => KPICardConfig[] = (uid) => [\r\n    { label: 'Ø³Ø¬Ù„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„ÙØ±Ø¹', table: 'tickets', aggregate: 'count', filter: { manager_id: uid }, color: 'blue', icon: 'Wrench', link_to: '/my-tickets' },\r\n    { label: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', table: 'tickets', aggregate: 'count', filter: { manager_id: uid, status: 'resolved' }, color: 'red', icon: 'AlertTriangle', link_to: '/my-tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', table: 'tickets', aggregate: 'count', filter: { manager_id: uid, status: 'in_progress' }, color: 'amber', icon: 'Activity', link_to: '/my-tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª Ù…Ù†Ø¬Ø²Ø© ØªÙ…Ø§Ù…Ø§Ù‹', table: 'tickets', aggregate: 'count', filter: { manager_id: uid, status: 'closed' }, color: 'green', icon: 'CheckCircle', link_to: '/my-tickets' },\r\n];\r\nconst DEFAULT_TECH_KPIS: (userId: string) => KPICardConfig[] = (uid) => [\r\n    { label: 'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø©', table: 'tickets', aggregate: 'count', filter: { assigned_to: uid, status: 'assigned' }, color: 'blue', icon: 'Wrench', link_to: '/tech-tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„', table: 'tickets', aggregate: 'count', filter: { assigned_to: uid, status: 'in_progress' }, color: 'amber', icon: 'Activity', link_to: '/tech-tickets' },\r\n    { label: 'Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ÙŠÙˆÙ…', table: 'tickets', aggregate: 'count', filter: { assigned_to: uid, status: 'resolved' }, color: 'green', icon: 'CheckCircle', link_to: '/tech-tickets' },\r\n];\r\nconst DEFAULT_MAINT_KPIS: KPICardConfig[] = [\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ© Ù†Ø´Ø·Ø©', table: 'tickets', aggregate: 'count', filter: { status: 'open' }, color: 'blue', icon: 'Wrench', link_to: '/maint-dashboard' },\r\n    { label: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„ÙÙ†ÙŠ', table: 'tickets', aggregate: 'count', filter: { status: 'open' }, color: 'amber', icon: 'AlertTriangle', link_to: '/maint-dashboard' },\r\n    { label: 'Ø¹Ù…Ù„ÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', table: 'tickets', aggregate: 'count', filter: { status: 'in_progress' }, color: 'purple', icon: 'Activity', link_to: '/maint-dashboard' },\r\n    { label: 'Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©', table: 'tickets', aggregate: 'count', filter: { status: 'closed' }, color: 'green', icon: 'CheckCircle', link_to: '/maint-dashboard' },\r\n];\r\nconst DEFAULT_OPS_KPIS: KPICardConfig[] = [\r\n    { label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª', table: 'tickets', aggregate: 'count', color: 'blue', icon: 'Wrench', link_to: '/manage/tickets' },\r\n    { label: 'Ø¨Ù„Ø§ØºØ§Øª ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', table: 'tickets', aggregate: 'count', filter: { status: 'in_progress' }, color: 'amber', icon: 'Activity', link_to: '/manage/tickets' },\r\n    { label: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹', table: 'branches', aggregate: 'count', color: 'purple', icon: 'Building', link_to: '/manage/branches' },\r\n];\r\n// Custom debounce to avoid extra dependencies\r\nfunction debounce(fn: (...args: any[]) => void, delay: number) {\r\n    let timeoutId: any;\r\n    const debounced = (...args: any[]) => {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = setTimeout(() => fn(...args), delay);\r\n    };\r\n    debounced.cancel = () => clearTimeout(timeoutId);\r\n    return debounced;\r\n}\r\n\r\nexport default function Dashboard() {\r\n    const { profile } = useAuth();\r\n    const navigate = useNavigate();\r\n\r\n    // Create a debounced loadStats to prevent rapid re-fetching\r\n    const debouncedLoadStats = debounce(() => {\r\n        loadStats();\r\n    }, 2000);\r\n\r\n    const [stats, setStats] = useState({\r\n        open: 0,\r\n        assigned: 0,\r\n        inProgress: 0,\r\n        resolved: 0,\r\n        availableTechs: 0,\r\n        faultyAssets: 0,\r\n        lowStock: 0,\r\n        pendingClosure: 0,\r\n        loading: true\r\n    });\r\n    const [kpiCards, setKpiCards] = useState<KPICardConfig[]>([]);\r\n\r\n    useEffect(() => {\r\n        if (!profile) return;\r\n        loadKPICards();\r\n        loadStats();\r\n        const subscription = supabase.channel('dashboard-stats')\r\n            .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, () => debouncedLoadStats())\r\n            .on('postgres_changes', { event: '*', schema: 'public', table: 'technician_attendance' }, () => debouncedLoadStats())\r\n            .on('postgres_changes', { event: '*', schema: 'public', table: 'maintenance_assets' }, () => debouncedLoadStats())\r\n            .subscribe();\r\n        return () => {\r\n            supabase.removeChannel(subscription);\r\n            debouncedLoadStats.cancel();\r\n        };\r\n    }, [profile]);\r\n\r\n    const loadStats = async () => {\r\n        if (!profile) return;\r\n        try {\r\n            // [QUANTUM OPTIMIZATION] Single-trip RPC to replace 7 parallel select requests\r\n            const { data, error } = await supabase.rpc('get_dashboard_stats', { p_profile_id: profile.id });\r\n\r\n            if (error) throw error;\r\n\r\n            setStats({\r\n                open: data.open || 0,\r\n                assigned: data.assigned || 0,\r\n                inProgress: data.in_progress || 0,\r\n                resolved: data.resolved || 0,\r\n                availableTechs: data.available_techs || 0,\r\n                faultyAssets: data.faulty_assets || 0,\r\n                lowStock: data.low_stock || 0,\r\n                pendingClosure: (profile.role === 'manager' ? data.resolved : 0) || 0,\r\n                loading: false\r\n            });\r\n\r\n        } catch (error) {\r\n            console.error('Error loading dashboard stats:', error);\r\n            setStats(prev => ({ ...prev, loading: false }));\r\n        }\r\n    };\r\n\r\n    // Aggregated KPI cards from all schemas\r\n    const loadKPICards = async () => {\r\n        const { data } = await supabase\r\n            .from('ui_schemas' as any)\r\n            .select('table_name, list_config, page_config, nav_config');\r\n\r\n        if (!data) return;\r\n\r\n        // Collect all KPIs from all tables\r\n        let aggregatedKPIs: KPICardConfig[] = [];\r\n        data.forEach(s => {\r\n            const configs = (s as any).page_config?.kpi_cards || [];\r\n            // Filter by role if defined in nav_config or config itself (SaaS logic)\r\n            const allowedRoles = s.nav_config?.roles || [];\r\n            if (allowedRoles.length === 0 || allowedRoles.includes(profile?.role)) {\r\n                aggregatedKPIs = [...aggregatedKPIs, ...configs];\r\n            }\r\n        });\r\n\r\n        if (aggregatedKPIs.length > 0) {\r\n            setKpiCards(aggregatedKPIs);\r\n        } else {\r\n            // Fallback to static defaults if absolutely nothing is defined\r\n            if (profile?.role === 'admin') setKpiCards(DEFAULT_ADMIN_KPIS);\r\n            else if (profile?.role === 'manager') setKpiCards(DEFAULT_MANAGER_KPIS(profile.id));\r\n            else if (profile?.role === 'technician') setKpiCards(DEFAULT_TECH_KPIS(profile.id));\r\n            else if (profile?.role === 'maint_manager' || profile?.role === 'maint_supervisor') setKpiCards(DEFAULT_MAINT_KPIS);\r\n            else if (['brand_ops_manager', 'sector_manager', 'area_manager'].includes(profile?.role || '')) setKpiCards(DEFAULT_OPS_KPIS);\r\n        }\r\n    };\r\n\r\n    const shortcuts =\r\n        profile?.role === 'manager' ? [\r\n            { icon: ClipboardList, label: 'ØªØ³Ø¬ÙŠÙ„ Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯', desc: 'Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø¹Ø·Ù„ ÙÙ†ÙŠ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', path: '/my-tickets', color: 'bg-brand-konafa' },\r\n            { icon: Map, label: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©', desc: 'ØªØªØ¨Ø¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', path: '/map', color: 'bg-accent-sky' },\r\n        ] :\r\n            profile?.role === 'technician' ? [\r\n                { icon: Timer, label: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©', desc: 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³Ù†Ø¯Ø©', path: '/tech-tickets', color: 'bg-brand-blaban' },\r\n            ] :\r\n                (profile?.role === 'maint_manager' || profile?.role === 'maint_supervisor') ? [\r\n                    { icon: Wrench, label: 'Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©', desc: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©', path: '/maint-dashboard', color: 'bg-brand-blaban' },\r\n                    { icon: Map, label: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©', desc: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ ÙˆÙ†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ Ù„Ù„ÙÙ†ÙŠÙŠÙ†', path: '/map', color: 'bg-accent-sky' },\r\n                ] :\r\n                    ['brand_ops_manager', 'sector_manager', 'area_manager'].includes(profile?.role || '') ? [\r\n                        { icon: Wrench, label: 'Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¹Ø§Ù…', desc: 'Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ ÙƒØ§ÙØ© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©', path: '/manage/tickets', color: 'bg-brand-blaban' },\r\n                        { icon: Map, label: 'ØªØºØ·ÙŠØ© Ø§Ù„ÙØ±ÙˆØ¹', desc: 'Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ§Ø¨Ø¹Ø©', path: '/map', color: 'bg-accent-sky' },\r\n                    ] : [\r\n                        { icon: Wrench, label: 'Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§ÙØ© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª', desc: 'Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ³ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª', path: '/manage/tickets', color: 'bg-brand-blaban' },\r\n                        { icon: Map, label: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©', desc: 'Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠØ©', path: '/map', color: 'bg-accent-sky' },\r\n                        { icon: Users, label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ø¨Ø´Ø±ÙŠØ©', desc: 'Ø¶Ø¨Ø· ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', path: '/manage/profiles', color: 'bg-brand-basbosa' },\r\n                    ];\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"fixed inset-0 -z-10 mesh-gradient opacity-30 dark:opacity-20 pointer-events-none\" />\r\n            <ShiftStatus />\r\n            <div className=\"mb-8 relative\">\r\n                <h2 className=\"text-4xl font-black text-white transition-colors font-outfit tracking-tight\">\r\n                    Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ø§Ù„Ø²Ù…ÙŠÙ„ {profile?.full_name} â€” Ø´Ø±ÙŠÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­ ğŸ‘‹\r\n                </h2>\r\n                <p className=\"text-surface-500 mt-2 text-lg transition-colors font-medium opacity-80 backdrop-blur-sm inline-block\">\r\n                    {profile?.role === 'admin' && 'Ù…Ù†ØµØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ Ù„Ù„Ù†Ø¸Ø§Ù… â€” Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„'}\r\n                    {profile?.role === 'manager' && 'Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¹Ù…Ù„'}\r\n                    {profile?.role === 'technician' && 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠ â€” ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ ÙˆØ¥Ù†Ø¬Ø§Ø² Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©'}\r\n                    {profile?.role === 'maint_manager' && 'Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© â€” Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©ØŒ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©'}\r\n                    {profile?.role === 'maint_supervisor' && 'Ø®Ù„Ø§ØµØ© Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆØ­Ø±ÙƒØ© Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„ÙÙ†ÙŠØ©'}\r\n                    {['brand_ops_manager', 'sector_manager', 'area_manager'].includes(profile?.role || '') && 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠØ© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© â€” ØªØ­Ù„ÙŠÙ„ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…'}\r\n                </p>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8\">\r\n                {kpiCards.map((card, i) => (\r\n                    <SovereignKPICard key={i} config={card} userId={profile?.id} />\r\n                ))}\r\n\r\n                {/* Low Stock KPI (Critical for Maintenance) */}\r\n                {(profile?.role === 'admin' || profile?.role === 'maint_manager' || profile?.role === 'maint_supervisor') && stats.lowStock > 0 && (\r\n                    <div\r\n                        onClick={() => navigate('/manage/inventory')}\r\n                        className=\"bg-surface-900 p-6 rounded-2xl border border-amber-900/30 shadow-sm relative overflow-hidden group hover:border-amber-400 transition-all cursor-pointer\"\r\n                    >\r\n                        <div className=\"flex items-center gap-4 mb-2 text-amber-600\">\r\n                            <Package className=\"w-5 h-5\" />\r\n                            <span className=\"text-sm font-bold\">Ø±ØµØ¯ Ø¹Ø¬Ø² Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</span>\r\n                        </div>\r\n                        <div className=\"text-3xl font-bold text-white\">\r\n                            {stats.loading ? <Skeleton variant=\"rectangular\" width=\"4rem\" height=\"2rem\" /> : stats.lowStock}\r\n                        </div>\r\n                        <p className=\"text-xs text-surface-500 mt-1\">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù†Ù‰</p>\r\n                        <div className=\"absolute top-0 right-0 w-24 h-24 bg-amber-50 dark:bg-amber-900/20 rounded-full -mr-12 -mt-12 group-hover:scale-110 transition-transform opacity-50\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Manager Pending Action Alert */}\r\n            {profile?.role === 'manager' && stats.pendingClosure > 0 && (\r\n                <div className=\"bg-gradient-to-r from-red-900/10 to-orange-900/10 border border-red-900/30 rounded-2xl p-5 mb-8 flex items-center gap-4 animate-pulse\">\r\n                    <div className=\"w-12 h-12 bg-red-600 text-white rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-red-500/20\">\r\n                        <AlertTriangle className=\"w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-sm font-bold text-red-400\">Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø¯Ø§Ø±ÙŠ: Ù…Ù‡Ø§Ù… Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</p>\r\n                        ØªÙ… Ø±ØµØ¯ {stats.pendingClosure} Ù…Ù‡Ù…Ø© Ø¹Ù…Ù„ Ù…ÙƒØªÙ…Ù„Ø© ÙÙ†ÙŠØ§Ù‹ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ù† Ø·Ø±ÙÙƒÙ….\r\n                    </div>\r\n                    <button onClick={() => navigate('/my-tickets')} className=\"mr-auto px-6 py-2.5 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-xl transition-all shadow-md shadow-red-500/10\">\r\n                        ÙØ­Øµ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n\r\n            {profile?.role !== 'technician' && (\r\n                <div className=\"bg-gradient-to-r from-emerald-900/10 to-teal-900/10 border border-emerald-900/30 rounded-2xl p-5 mb-8 flex items-center gap-4\">\r\n                    <div className=\"w-12 h-12 bg-emerald-500 text-white rounded-xl flex items-center justify-center shrink-0\">\r\n                        <Users className=\"w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-sm font-medium text-emerald-400\">Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ§Ù‹</p>\r\n                        <p className=\"text-2xl font-bold text-emerald-50\">\r\n                            {stats.loading ? <Skeleton variant=\"rectangular\" width=\"6rem\" height=\"2rem\" /> : `${stats.availableTechs} ÙÙ†ÙŠ Ø¨Ø§Ø´Ø± Ù…Ù‡Ø§Ù…Ù‡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©`}\r\n                        </p>\r\n                    </div>\r\n                    <button onClick={() => navigate('/map')} className=\"mr-auto px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-semibold rounded-xl transition-colors\">\r\n                        Ø§Ø³ØªØ¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            <h3 className=\"font-bold text-surface-300 mb-4 flex items-center gap-2\">\r\n                <Clock className=\"w-5 h-5 text-surface-400\" /> Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©\r\n            </h3>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                {shortcuts.map(s => (\r\n                    <button key={s.path} onClick={() => navigate(s.path)} className=\"bg-surface-900 border border-surface-800 rounded-2xl p-6 text-right hover:shadow-md hover:border-brand-blaban/30 transition-all group flex items-center gap-4\">\r\n                        <div className={`w-12 h-12 ${s.color} text-white rounded-xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform`}>\r\n                            <s.icon className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"font-bold text-white text-sm\">{s.label}</p>\r\n                            <p className=\"text-xs text-surface-400 mt-0.5\">{s.desc}</p>\r\n                        </div>\r\n                    </button>\r\n                ))}\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\hr\\pages\\AttendanceDashboardPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAttendance'. Either include it or remove the dependency array.","line":24,"column":8,"nodeType":"ArrayExpression","endLine":24,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAttendance, profile]","fix":{"range":[1180,1189],"text":"[fetchAttendance, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { Users, Clock, MapPin, Search, TrendingUp, Calendar, ArrowUpRight } from 'lucide-react';\r\nimport { format, formatDistanceToNow, eachDayOfInterval, subDays, isSameDay } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport Skeleton from '@/components/ui/Skeleton';\r\nimport { ResponsiveContainer, AreaChart, Area, XAxis, Tooltip, CartesianGrid } from 'recharts';\r\nimport clsx from 'clsx';\r\n\r\nexport default function AttendanceDashboardPage() {\r\n    const { profile } = useAuth();\r\n    const [attendance, setAttendance] = useState<any[]>([]);\r\n    const [history, setHistory] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [dailyTrends, setDailyTrends] = useState<any[]>([]);\r\n\r\n    useEffect(() => {\r\n        fetchAttendance();\r\n        const interval = setInterval(fetchAttendance, 60000); // Live refresh\r\n        return () => clearInterval(interval);\r\n    }, [profile]);\r\n\r\n    const fetchAttendance = async () => {\r\n        if (!profile) return;\r\n        setLoading(true);\r\n        try {\r\n            const GLOBAL_ROLES = ['admin', 'maint_manager', 'maint_supervisor'];\r\n            const needsFiltering = !GLOBAL_ROLES.includes(profile.role);\r\n\r\n            // 1. Live Attendance (Active)\r\n            let activeQuery = supabase\r\n                .from('technician_attendance')\r\n                .select('*, profiles!inner(full_name, branch_id, area_id, sector_id, brand_id, employee_code, branches!inner(name))')\r\n                .is('clock_out', null)\r\n                .order('clock_in', { ascending: false });\r\n\r\n            // 2. Historical Data (Last 7 Days) for Trends\r\n            let historyQuery = supabase\r\n                .from('technician_attendance')\r\n                .select('clock_in, clock_out')\r\n                .gte('clock_in', subDays(new Date(), 7).toISOString());\r\n\r\n            if (needsFiltering) {\r\n                if (profile.branch_id) {\r\n                    activeQuery = activeQuery.eq('profiles.branch_id', profile.branch_id);\r\n                    historyQuery = historyQuery.eq('branch_id', profile.branch_id);\r\n                } else if (profile.area_id) {\r\n                    activeQuery = activeQuery.eq('profiles.area_id', profile.area_id);\r\n                    historyQuery = historyQuery.eq('area_id', profile.area_id);\r\n                }\r\n            }\r\n\r\n            const [activeRes, historyRes] = await Promise.all([activeQuery, historyQuery]);\r\n\r\n            setAttendance(activeRes.data || []);\r\n            setHistory(historyRes.data || []);\r\n\r\n            // Process Trends\r\n            const days = eachDayOfInterval({\r\n                start: subDays(new Date(), 6),\r\n                end: new Date()\r\n            });\r\n\r\n            const trends = days.map(day => ({\r\n                date: format(day, 'MM/dd'),\r\n                count: (historyRes.data || []).filter(a => isSameDay(new Date(a.clock_in), day)).length\r\n            }));\r\n            setDailyTrends(trends);\r\n\r\n        } catch (e) {\r\n            console.error('Error fetching attendance data:', e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const filtered = attendance.filter(a =>\r\n        a.profiles?.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        a.profiles?.employee_code?.toLowerCase().includes(searchTerm.toLowerCase())\r\n    );\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"flex flex-col gap-6\">\r\n                <div className=\"flex justify-between items-center animate-in fade-in slide-in-from-top-4 duration-500\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-black text-white\">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</h2>\r\n                        <p className=\"text-surface-400 font-medium mt-1\">Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ù„Ø­Ø¸ÙŠØ© Ù„Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 animate-in fade-in slide-in-from-bottom-4 duration-700\">\r\n                    <AttendanceKPI\r\n                        title=\"Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹\"\r\n                        value={attendance.length}\r\n                        icon={Users}\r\n                        color=\"text-emerald-400\"\r\n                        loading={loading}\r\n                    />\r\n                    <AttendanceKPI\r\n                        title=\"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹\"\r\n                        value={history.length}\r\n                        icon={Calendar}\r\n                        color=\"text-blue-400\"\r\n                        loading={loading}\r\n                    />\r\n                    <AttendanceKPI\r\n                        title=\"Ù…ØªÙˆØ³Ø· Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„\"\r\n                        value=\"8.4\"\r\n                        icon={Clock}\r\n                        color=\"text-amber-400\"\r\n                        loading={loading}\r\n                        suffix=\"Ø³\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"bg-surface-900 border border-surface-800 rounded-3xl p-6 shadow-xl animate-in fade-in duration-1000\">\r\n                    <div className=\"flex items-center justify-between mb-8\">\r\n                        <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\r\n                            <TrendingUp className=\"w-5 h-5 text-brand-blaban\" /> ÙƒØ«Ø§ÙØ© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØªØ´Ø§Ø± (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)\r\n                        </h3>\r\n                    </div>\r\n                    <div className=\"h-[200px] w-full\">\r\n                        {loading ? <Skeleton className=\"h-full w-full rounded-2xl\" /> : (\r\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                <AreaChart data={dailyTrends}>\r\n                                    <defs>\r\n                                        <linearGradient id=\"colorCount\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                            <stop offset=\"5%\" stopColor=\"#004aad\" stopOpacity={0.2} />\r\n                                            <stop offset=\"95%\" stopColor=\"#004aad\" stopOpacity={0} />\r\n                                        </linearGradient>\r\n                                    </defs>\r\n                                    <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#1e293b\" vertical={false} />\r\n                                    <XAxis dataKey=\"date\" stroke=\"#64748b\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                    <Tooltip\r\n                                        contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                        itemStyle={{ color: '#fff', fontSize: '12px', fontWeight: 'bold' }}\r\n                                    />\r\n                                    <Area type=\"monotone\" dataKey=\"count\" name=\"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±\" stroke=\"#004aad\" strokeWidth={3} fillOpacity={1} fill=\"url(#colorCount)\" />\r\n                                </AreaChart>\r\n                            </ResponsiveContainer>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex flex-col md:flex-row items-center gap-4 bg-surface-900/50 backdrop-blur-xl border border-surface-800 p-4 rounded-2xl\">\r\n                    <div className=\"relative flex-1 w-full\">\r\n                        <Search className=\"w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-surface-500\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¹Ù† ÙÙ†ÙŠ...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                            className=\"w-full pl-4 pr-12 py-3 bg-surface-950 border border-surface-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 px-4 py-3 bg-emerald-900/20 text-emerald-400 rounded-xl border border-emerald-900/30 font-bold whitespace-nowrap\">\r\n                        <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\r\n                        Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª\r\n                    </div>\r\n                </div>\r\n\r\n                {loading && attendance.length === 0 ? (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                        {[1, 2, 3, 4, 5, 6].map(i => <Skeleton key={i} className=\"h-[180px] rounded-3xl\" />)}\r\n                    </div>\r\n                ) : filtered.length === 0 ? (\r\n                    <div className=\"bg-surface-900 rounded-[2.5rem] border border-dashed border-surface-800 p-20 text-center\">\r\n                        <Users className=\"w-20 h-20 text-surface-800 mx-auto mb-6\" />\r\n                        <h4 className=\"text-xl font-bold text-surface-400 mb-2\">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…ÙŠØ¯Ø§Ù†ÙŠ</h4>\r\n                        <p className=\"text-surface-600\">Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø£ÙŠ ØªÙˆØ§Ø¬Ø¯ Ù„Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø®ØªØ§Ø±</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n                        {filtered.map(a => (\r\n                            <div key={a.id} className=\"group relative bg-surface-900 p-6 rounded-[2rem] border border-surface-800 transition-all hover:border-brand-blaban hover:shadow-2xl hover:shadow-brand-blaban/5 overflow-hidden\">\r\n                                <div className=\"absolute top-0 left-0 w-2 h-full bg-emerald-500/50 opacity-0 group-hover:opacity-100 transition-all\" />\r\n\r\n                                <div className=\"flex items-start justify-between mb-6\">\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className=\"w-14 h-14 bg-surface-800 rounded-2xl flex items-center justify-center text-brand-blaban font-black text-xl border border-surface-700 shadow-inner group-hover:bg-brand-blaban group-hover:text-white transition-all\">\r\n                                            {a.profiles?.full_name?.charAt(0)}\r\n                                        </div>\r\n                                        <div>\r\n                                            <p className=\"font-black text-white text-lg leading-tight\">{a.profiles?.full_name}</p>\r\n                                            <p className=\"text-xs text-surface-500 font-bold mt-1 uppercase tracking-widest\">{a.profiles?.employee_code}</p>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"p-2.5 bg-surface-800 rounded-xl border border-surface-700 text-surface-400 group-hover:text-emerald-400 transition-all\">\r\n                                        <MapPin className=\"w-5 h-5\" />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-4 pt-4 border-t border-surface-800/50\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <span className=\"text-xs font-bold text-surface-500 flex items-center gap-2\">\r\n                                            <Clock className=\"w-4 h-4\" /> Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ\r\n                                        </span>\r\n                                        <span className=\"text-sm font-black text-white\">\r\n                                            {format(new Date(a.clock_in), 'hh:mm a', { locale: ar })}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"flex flex-col gap-1\">\r\n                                        <span className=\"text-[10px] font-black text-surface-600 uppercase tracking-tighter\">Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</span>\r\n                                        <span className=\"text-sm font-bold text-brand-blaban\">\r\n                                            Ù…Ù†Ø° {formatDistanceToNow(new Date(a.clock_in), { locale: ar })}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className=\"pt-2\">\r\n                                        <div className=\"px-3 py-1.5 bg-surface-800/50 rounded-lg border border-surface-800 inline-flex items-center gap-2\">\r\n                                            <span className=\"text-[10px] font-black text-surface-500\">ğŸ¢</span>\r\n                                            <span className=\"text-xs font-bold text-surface-300\">{a.profiles?.branches?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n\r\nfunction AttendanceKPI({ title, value, icon: Icon, color, loading, suffix = \"\" }: any) {\r\n    return (\r\n        <div className=\"bg-surface-900 border border-surface-800 p-6 rounded-[2rem] relative overflow-hidden group hover:border-surface-700 transition-all\">\r\n            <div className={clsx(\"absolute top-0 right-0 w-32 h-32 rounded-full -mr-16 -mt-16 bg-current opacity-[0.03] transition-transform group-hover:scale-110\", color)} />\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n                <div className={clsx(\"p-3 rounded-2xl bg-surface-800 border border-surface-700 shadow-inner\", color)}>\r\n                    <Icon className=\"w-6 h-6\" />\r\n                </div>\r\n                <ArrowUpRight className=\"w-5 h-5 text-surface-700\" />\r\n            </div>\r\n            {loading ? <Skeleton variant=\"text\" width=\"60%\" className=\"h-10\" /> : (\r\n                <>\r\n                    <div className=\"flex items-baseline gap-1\">\r\n                        <span className=\"text-4xl font-black text-white tracking-tighter\">{value}</span>\r\n                        {suffix && <span className=\"text-sm font-bold text-surface-500\">{suffix}</span>}\r\n                    </div>\r\n                    <p className=\"text-xs font-black text-surface-500 mt-2 uppercase tracking-widest\">{title}</p>\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\hr\\pages\\TechnicianSalaryPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchPayrollData'. Either include it or remove the dependency array.","line":19,"column":8,"nodeType":"ArrayExpression","endLine":19,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPayrollData, profile]","fix":{"range":[730,739],"text":"[fetchPayrollData, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { Wallet, TrendingUp, Star, History, Loader2, Calendar, AlertCircle } from 'lucide-react';\r\nimport { format } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\n\r\nexport default function TechnicianSalaryPage() {\r\n    const { profile } = useAuth();\r\n    const [stats, setStats] = useState<any>(null);\r\n    const [history, setHistory] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        if (profile) {\r\n            fetchPayrollData();\r\n        }\r\n    }, [profile]);\r\n\r\n    const fetchPayrollData = async () => {\r\n        try {\r\n            // Get today's earnings\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const { data: todayData } = await supabase\r\n                .from('payroll_logs' as any)\r\n                .select('*')\r\n                .eq('profile_id', profile?.id)\r\n                .eq('date', today)\r\n                .maybeSingle();\r\n\r\n            setStats(todayData);\r\n\r\n            // Get last 7 days history\r\n            const { data: historyData } = await supabase\r\n                .from('payroll_logs' as any)\r\n                .select('*')\r\n                .eq('profile_id', profile?.id)\r\n                .order('date', { ascending: false })\r\n                .limit(7);\r\n\r\n            setHistory(historyData || []);\r\n        } catch (e) {\r\n            console.error('Error fetching payroll', e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <DashboardLayout>\r\n                <div className=\"flex items-center justify-center h-[60vh]\">\r\n                    <Loader2 className=\"w-8 h-8 animate-spin text-primary-600\" />\r\n                </div>\r\n            </DashboardLayout>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"mb-8\">\r\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-bold text-surface-900 dark:text-white flex items-center gap-3 transition-colors\">\r\n                            <Wallet className=\"w-8 h-8 text-primary-600 dark:text-primary-400\" />\r\n                            Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„ÙÙ†ÙŠÙŠÙ†\r\n                        </h2>\r\n                        <p className=\"text-surface-500 dark:text-surface-400 mt-1 transition-colors\">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆÙ…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ</p>\r\n                    </div>\r\n                    <button className=\"flex items-center gap-2 px-5 py-2.5 bg-surface-900 border border-surface-800 text-surface-300 rounded-2xl text-sm font-bold hover:bg-surface-800 transition-all shadow-xl\">\r\n                        <AlertCircle className=\"w-4 h-4 text-amber-500\" />\r\n                        Ø·Ù„Ø¨ ØªØ¯Ù‚ÙŠÙ‚ Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¯ÙØ¹Ø©\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Today's Summary Card */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8\">\r\n                <div className=\"bg-gradient-to-br from-primary-600 to-primary-700 rounded-3xl p-6 text-white shadow-xl shadow-primary-500/20 col-span-1 md:col-span-2\">\r\n                    <div className=\"flex justify-between items-start mb-4\">\r\n                        <div>\r\n                            <p className=\"text-primary-100 text-sm font-medium\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)</p>\r\n                            <h3 className=\"text-4xl font-black mt-1\">\r\n                                {stats?.net_earning ? Number(stats.net_earning).toLocaleString() : '0'} <span className=\"text-lg font-normal\">Ø¬Ù†ÙŠÙ‡</span>\r\n                            </h3>\r\n                        </div>\r\n                        <TrendingUp className=\"w-8 h-8 text-primary-200 opacity-50\" />\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-primary-500/30\">\r\n                        <div>\r\n                            <p className=\"text-primary-200 text-xs\">Ø¨Ø¯Ù„Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ (Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ§Øª)</p>\r\n                            <p className=\"font-bold text-lg\">{stats?.total_allowance || 0} Ø¬.Ù…</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-primary-200 text-xs\">Ø­ÙˆØ§ÙØ² Ù…Ø¤Ø´Ø± Ø§Ù„Ø¬ÙˆØ¯Ø© (ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¬ÙˆÙ…)</p>\r\n                            <p className=\"font-bold text-lg\">{stats?.total_star_bonus || 0} Ø¬.Ù…</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"bg-surface-900 border border-surface-800 rounded-3xl p-6 flex flex-col justify-between transition-colors shadow-2xl\">\r\n                    <div className=\"flex items-center gap-3 text-white font-bold mb-4\">\r\n                        <div className=\"p-2 bg-amber-900/20 rounded-xl\">\r\n                            <Star className=\"w-5 h-5 text-amber-400 fill-amber-400\" />\r\n                        </div>\r\n                        Ø®Ù„Ø§ØµØ© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ\r\n                    </div>\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"flex justify-between items-center text-sm\">\r\n                            <span className=\"text-surface-400\">Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª</span>\r\n                            <span className=\"font-bold text-white\">{stats?.base_salary || profile?.base_daily_rate || 100} Ø¬.Ù…</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between items-center text-sm\">\r\n                            <span className=\"text-surface-400\">Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</span>\r\n                            <span className=\"text-green-400 font-semibold\">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª</span>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"mt-6 p-3 bg-surface-950 rounded-2xl text-center border border-surface-800\">\r\n                        <p className=\"text-xs text-surface-500\">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© ÙÙˆØ± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙÙ†ÙŠØ©</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* History Table */}\r\n            <div className=\"bg-surface-900 border border-surface-800 rounded-3xl overflow-hidden shadow-2xl transition-colors\">\r\n                <div className=\"p-6 border-b border-surface-800 flex items-center justify-between bg-surface-800/50\">\r\n                    <h3 className=\"font-bold text-white flex items-center gap-2\">\r\n                        <History className=\"w-5 h-5 text-surface-500\" /> Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©\r\n                    </h3>\r\n                    <Calendar className=\"w-5 h-5 text-surface-600\" />\r\n                </div>\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-right\">\r\n                        <thead>\r\n                            <tr className=\"bg-surface-800/50 text-surface-400 text-xs uppercase tracking-wider transition-colors\">\r\n                                <th className=\"px-6 py-4 font-bold\">Ø¨ÙŠØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\r\n                                <th className=\"px-6 py-4 font-bold\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>\r\n                                <th className=\"px-6 py-4 font-bold\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§ÙØ²</th>\r\n                                <th className=\"px-6 py-4 font-bold\">ØµØ§ÙÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>\r\n                                <th className=\"px-6 py-4 font-bold text-center\">Ø­Ø§Ù„Ø© Ø§Ù„ØµØ±Ù</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-surface-100 dark:divide-surface-800\">\r\n                            {history.length > 0 ? history.map((day, idx) => (\r\n                                <tr key={idx} className=\"hover:bg-surface-800 transition-colors\">\r\n                                    <td className=\"px-6 py-4 font-semibold text-white\">\r\n                                        {format(new Date(day.date), 'EEEE, d MMMM', { locale: ar })}\r\n                                    </td>\r\n                                    <td className=\"px-6 py-4 text-surface-400\">{day.total_allowance} Ø¬.Ù…</td>\r\n                                    <td className=\"px-6 py-4 text-amber-400 font-medium\">+{day.total_star_bonus} Ø¬.Ù…</td>\r\n                                    <td className=\"px-6 py-4 font-bold text-white\">{day.net_earning} Ø¬.Ù…</td>\r\n                                    <td className=\"px-6 py-4 text-center\">\r\n                                        <span className={`px-3 py-1 rounded-full text-[10px] font-bold ${day.is_paid ? 'bg-green-900/30 text-green-400' : 'bg-blue-900/30 text-blue-400'}`}>\r\n                                            {day.is_paid ? 'ØªÙ… ØªØ³ÙˆÙŠØ© Ø§Ù„ØµØ±Ù' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚'}\r\n                                        </span>\r\n                                    </td>\r\n                                </tr>\r\n                            )) : (\r\n                                <tr>\r\n                                    <td colSpan={5} className=\"px-6 py-12 text-center text-surface-400 italic\">\r\n                                        Ù„Ø§ ØªØªÙˆÙØ± Ø³Ø¬Ù„Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹\r\n                                    </td>\r\n                                </tr>\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Support Box */}\r\n            <div className=\"mt-8 p-6 bg-blue-900/20 border border-blue-900/30 rounded-3xl flex items-start gap-4 transition-colors\">\r\n                <div className=\"p-3 bg-surface-800 rounded-2xl shadow-lg border border-white/5\">\r\n                    <History className=\"w-6 h-6 text-blue-400\" />\r\n                </div>\r\n                <div>\r\n                    <h4 className=\"font-bold text-blue-300\">Ø³ÙŠØ§Ø³Ø§Øª Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</h4>\r\n                    <p className=\"text-sm text-blue-400/80 mt-1 leading-relaxed\">\r\n                        ØªÙØ¹ØªÙ…Ø¯ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© Ø¢Ù„ÙŠØ§Ù‹ ÙˆÙÙ‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¨ÙŠÙ† Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.\r\n                        ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ \"Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©\" Ùˆ\"Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²\" Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ù„Ù„ÙØ±Ø¹ (Geofencing) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ©.\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\inventory\\pages\\MasterDataPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\maintenance\\components\\TicketFlow.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchKPIData'. Either include it or remove the dependency array.","line":65,"column":8,"nodeType":"ArrayExpression","endLine":65,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [ticket.status, profile, fetchKPIData]","fix":{"range":[2839,2863],"text":"[ticket.status, profile, fetchKPIData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from 'react';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { getGeoLocation } from '@/lib/geo';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport {\r\n    MapPin, Play, CheckCircle, Star, Package, Loader2, AlertCircle, Camera, Eye,\r\n    X, Save, QrCode, ClipboardList, ShieldCheck, Zap,\r\n    History, UserCog, HardHat, Wrench\r\n} from 'lucide-react';\r\nimport clsx from 'clsx';\r\nimport { format } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport { compressImage } from '@/lib/image';\r\nimport { uploadToDrive } from '@/lib/drive';\r\nimport BottomSheet from '@/components/ui/BottomSheet';\r\nimport QRScanner from '@/components/ui/QRScanner';\r\nimport { OfflineQueue } from '@/lib/offlineQueue';\r\n\r\ninterface TicketFlowProps {\r\n    ticket: any;\r\n    onUpdate: () => void;\r\n}\r\n\r\nexport default function TicketFlow({ ticket, onUpdate }: TicketFlowProps) {\r\n    const { profile } = useAuth();\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);\r\n    const [isResolveSheetOpen, setIsResolveSheetOpen] = useState(false);\r\n    const [isRateSheetOpen, setIsRateSheetOpen] = useState(false);\r\n    const [isAssetScannerOpen, setIsAssetScannerOpen] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const handleResize = () => setIsMobile(window.innerWidth < 768);\r\n        window.addEventListener('resize', handleResize);\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    // States for Technician Parts Used\r\n    const [inventory, setInventory] = useState<any[]>([]);\r\n    const [selectedPart, setSelectedPart] = useState('');\r\n    const [quantity, setQuantity] = useState(1);\r\n    const [partsUsed, setPartsUsed] = useState<{ part_id: string, name: string, qty: number }[]>([]);\r\n\r\n    // States for Manager Evaluation\r\n    const [rating, setRating] = useState(5);\r\n    const [comment, setComment] = useState('');\r\n\r\n    // State for Technician Repair Photo\r\n    const [resolvedImageUrl, setResolvedImageUrl] = useState<string | null>(null);\r\n    const [uploading, setUploading] = useState(false);\r\n\r\n    // KPI Readiness States\r\n    const [categories, setCategories] = useState<any[]>([]);\r\n    const [selectedCategory, setSelectedCategory] = useState('');\r\n    const [assets, setAssets] = useState<any[]>([]);\r\n    const [selectedAsset, setSelectedAsset] = useState(ticket.asset_id || '');\r\n    const [downtimeStart, setDowntimeStart] = useState(ticket.downtime_start || '');\r\n\r\n    useEffect(() => {\r\n        if (ticket.status === 'in_progress' && (profile?.role === 'technician' || profile?.role === 'maint_supervisor')) {\r\n            fetchInventory();\r\n            fetchKPIData();\r\n        }\r\n    }, [ticket.status, profile]);\r\n\r\n    const fetchInventory = async () => {\r\n        const { data } = await supabase.from('inventory').select('*').gt('quantity', 0);\r\n        if (data) setInventory(data);\r\n    };\r\n\r\n    const fetchKPIData = async () => {\r\n        const { data: cats } = await supabase.from('maintenance_categories').select('*').order('name');\r\n        if (cats) setCategories(cats);\r\n\r\n        const { data: asts } = await supabase.from('maintenance_assets').select('*').eq('branch_id', ticket.branch_id).order('name');\r\n        if (asts) setAssets(asts);\r\n    };\r\n\r\n    const addPart = () => {\r\n        if (!selectedPart || quantity <= 0) return;\r\n        const part = inventory.find(p => p.id === selectedPart);\r\n        if (part) {\r\n            if (quantity > part.quantity) {\r\n                setError(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ù‡ÙŠ ${part.quantity} ÙˆØ­Ø¯Ø© ÙÙ‚Ø·.`);\r\n                return;\r\n            }\r\n            setPartsUsed([...partsUsed, { part_id: part.id, name: part.name, qty: quantity }]);\r\n            setSelectedPart('');\r\n            setQuantity(1);\r\n            setError(null);\r\n        }\r\n    };\r\n\r\n    const removePart = (index: number) => {\r\n        setPartsUsed(partsUsed.filter((_, i) => i !== index));\r\n    };\r\n\r\n    const handleImageUpload = async (file: File) => {\r\n        setUploading(true);\r\n        setError(null);\r\n        try {\r\n            const compressed = await compressImage(file);\r\n            const url = await uploadToDrive(compressed as File);\r\n            setResolvedImageUrl(url);\r\n        } catch (e: any) {\r\n            setError('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ' + e.message);\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    const renderResolutionForm = () => (\r\n        <div className=\"space-y-6\">\r\n            <h4 className=\"font-bold text-white flex items-center gap-2\">\r\n                <CheckCircle className=\"w-5 h-5 text-teal-400\" />\r\n                Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙÙ†ÙŠØ©\r\n            </h4>\r\n\r\n            {/* Inventory / Parts Consumption */}\r\n            <div className=\"bg-surface-900 rounded-2xl p-5 border border-surface-800 space-y-5\">\r\n                <div className=\"flex items-center gap-2 text-white border-b border-surface-800 pb-3\">\r\n                    <Package className=\"w-5 h-5 text-surface-500\" />\r\n                    <h4 className=\"font-semibold\">Ø¯Ø±Ø§Ø³Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>\r\n                </div>\r\n\r\n                <div className=\"flex flex-col gap-3\">\r\n                    <select\r\n                        className=\"w-full bg-surface-800 border border-surface-700 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-brand-blaban/30 text-white\"\r\n                        value={selectedPart}\r\n                        onChange={(e) => setSelectedPart(e.target.value)}\r\n                    >\r\n                        <option value=\"\">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ...</option>\r\n                        {inventory.map(p => <option key={p.id} value={p.id}>{p.name} (Ø§Ù„Ù…ØªÙˆÙØ±: {p.quantity})</option>)}\r\n                    </select>\r\n                    <div className=\"flex gap-2\">\r\n                        <input\r\n                            type=\"number\"\r\n                            min=\"1\"\r\n                            value={quantity}\r\n                            onChange={(e) => setQuantity(Number(e.target.value))}\r\n                            className=\"w-24 bg-surface-800 border border-surface-700 rounded-xl px-4 py-2 text-sm text-white\"\r\n                        />\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={addPart}\r\n                            className=\"flex-1 px-4 py-2 bg-surface-700 text-white rounded-xl font-bold hover:bg-surface-600 transition-colors\"\r\n                        >\r\n                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {partsUsed.length > 0 && (\r\n                    <ul className=\"space-y-2\">\r\n                        {partsUsed.map((pt, i) => (\r\n                            <li key={i} className=\"flex justify-between items-center bg-surface-800 border border-surface-700 p-3 rounded-xl text-sm shadow-sm\">\r\n                                <span className=\"text-white\">{pt.name} <span className=\"text-surface-500 mx-2\">Ã—</span> <span className=\"font-black text-brand-blaban\">{pt.qty}</span></span>\r\n                                <button type=\"button\" onClick={() => removePart(i)} className=\"text-red-400 font-bold hover:bg-red-400/10 p-1.5 rounded-lg transition-colors\">Ø¥Ø²Ø§Ù„Ø©</button>\r\n                            </li>\r\n                        ))}\r\n                    </ul>\r\n                )}\r\n            </div>\r\n\r\n            {/* Image Upload for Resolution */}\r\n            <div className=\"space-y-3\">\r\n                <label className=\"text-sm font-bold text-white flex items-center gap-1\">\r\n                    <Camera className=\"w-4 h-4 text-brand-blaban\" /> ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (ØµÙˆØ±Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©)\r\n                </label>\r\n                {resolvedImageUrl ? (\r\n                    <div className=\"relative w-full aspect-video rounded-xl border border-surface-700 overflow-hidden group\">\r\n                        <img src={resolvedImageUrl} className=\"w-full h-full object-cover\" alt=\"Repair\" />\r\n                        <button\r\n                            onClick={() => setResolvedImageUrl('')}\r\n                            className=\"absolute top-2 right-2 p-1.5 bg-surface-900/80 text-red-400 rounded-full shadow-md backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                        >\r\n                            <X className=\"w-4 h-4\" />\r\n                        </button>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"relative group\">\r\n                        <input\r\n                            type=\"file\"\r\n                            accept=\"image/*\"\r\n                            capture=\"environment\"\r\n                            onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0])}\r\n                            className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10\"\r\n                        />\r\n                        <div className=\"flex flex-col items-center justify-center p-8 border-2 border-dashed border-surface-800 group-hover:border-brand-blaban/30 bg-surface-950 rounded-2xl transition-all\">\r\n                            {uploading ? (\r\n                                <Loader2 className=\"w-8 h-8 text-brand-blaban animate-spin\" />\r\n                            ) : (\r\n                                <Camera className=\"w-8 h-8 text-surface-600 group-hover:text-brand-blaban mb-2 transition-colors\" />\r\n                            )}\r\n                            <span className=\"text-sm text-surface-400 font-medium text-center\">\r\n                                {uploading ? 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø©...' : 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø¯Ø© Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                    <label className=\"text-sm font-bold text-white flex items-center gap-1\">\r\n                        <Star className=\"w-4 h-4 text-amber-500\" /> ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„ÙÙ†ÙŠ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)\r\n                    </label>\r\n                    <select\r\n                        className=\"w-full bg-surface-800 border border-surface-700 rounded-xl px-4 py-2 text-sm text-white\"\r\n                        value={selectedCategory}\r\n                        onChange={(e) => setSelectedCategory(e.target.value)}\r\n                    >\r\n                        <option value=\"\">ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ù…ÙƒØªØ´Ù...</option>\r\n                        {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\r\n                    </select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <label className=\"text-sm font-bold text-white flex items-center gap-1\">\r\n                        <Package className=\"w-4 h-4 text-teal-400\" /> Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙÙ†ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø© (Ø§Ù„Ø£ØµÙ„)\r\n                    </label>\r\n                    <div className=\"flex gap-2\">\r\n                        <select\r\n                            className=\"flex-1 bg-surface-800 border border-surface-700 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-brand-blaban/30 text-white\"\r\n                            value={selectedAsset}\r\n                            onChange={(e) => setSelectedAsset(e.target.value)}\r\n                        >\r\n                            <option value=\"\">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø£ØµÙˆÙ„...</option>\r\n                            {assets.map(a => <option key={a.id} value={a.id}>{a.name} ({a.serial_number || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ'})</option>)}\r\n                        </select>\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => setIsAssetScannerOpen(true)}\r\n                            className=\"p-2 bg-surface-800 border border-surface-700 rounded-xl text-surface-400 hover:text-brand-blaban hover:border-brand-blaban/30 transition-all shadow-sm\"\r\n                            title=\"Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (QR)\"\r\n                        >\r\n                            <QrCode className=\"w-5 h-5\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2 sm:col-span-2\">\r\n                    <label className=\"text-sm font-bold text-white\">ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ø© (Downtime)</label>\r\n                    <input\r\n                        type=\"datetime-local\"\r\n                        className=\"w-full bg-surface-800 border border-surface-700 rounded-xl px-4 py-2 text-sm text-white\"\r\n                        value={downtimeStart ? format(new Date(downtimeStart), \"yyyy-MM-dd'T'HH:mm\") : ''}\r\n                        onChange={(e) => setDowntimeStart(e.target.value)}\r\n                    />\r\n                    <p className=\"text-[10px] text-surface-500\">ÙŠØ±Ø¬Ù‰ Ø¯Ù‚Ø© ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ‚Ù Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ù…Ø¹Ø§ÙŠÙŠØ± ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª (OEE).</p>\r\n                </div>\r\n            </div>\r\n\r\n            <p className=\"text-xs text-surface-500 flex items-center gap-1\"><MapPin className=\"w-3 h-3\" /> Ø³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù„Ùƒ Ù„Ø¥Ø«Ø¨Ø§Øª Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ Ù…ÙˆÙ‚Ø¹ÙŠØ§Ù‹</p>\r\n\r\n            <button\r\n                onClick={() => handleAction('resolve')}\r\n                disabled={loading || !resolvedImageUrl || uploading || !selectedCategory}\r\n                className=\"flex items-center justify-center gap-2 w-full px-6 py-5 bg-brand-blaban hover:bg-brand-blaban/90 text-white rounded-2xl font-black shadow-2xl shadow-brand-blaban/30 transition-all disabled:opacity-70 active:scale-95\"\r\n            >\r\n                {loading ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <CheckCircle className=\"w-5 h-5\" />}\r\n                <span>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©</span>\r\n            </button>\r\n        </div>\r\n    );\r\n\r\n    const renderRateForm = () => (\r\n        <div className=\"bg-brand-blaban/5 rounded-2xl p-6 border border-brand-blaban/20 space-y-6\">\r\n            <h4 className=\"font-bold text-white border-b border-surface-800 pb-3 flex items-center gap-2 text-lg\">\r\n                <CheckCircle className=\"w-6 h-6 text-teal-400\" />\r\n                Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø©\r\n            </h4>\r\n\r\n            {/* Display Technician's Repair Photo for Manager */}\r\n            {ticket.resolved_image_url && (\r\n                <div className=\"space-y-2\">\r\n                    <p className=\"text-sm font-bold text-brand-blaban\">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙ†ÙŠ:</p>\r\n                    <a href={ticket.resolved_image_url} target=\"_blank\" rel=\"noreferrer\" className=\"block relative group overflow-hidden rounded-xl aspect-video w-full bg-surface-900 border border-surface-800 shadow-sm\">\r\n                        <img src={ticket.resolved_image_url} className=\"w-full h-full object-cover\" alt=\"Repair Complete\" />\r\n                        <div className=\"absolute inset-0 bg-brand-blaban/10 flex items-center justify-center group-hover:bg-brand-blaban/20 transition-all\">\r\n                            <Eye className=\"w-8 h-8 text-brand-blaban opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                        </div>\r\n                    </a>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"bg-surface-900 p-5 rounded-2xl border border-surface-800 shadow-sm space-y-5\">\r\n                <div>\r\n                    <label className=\"block text-sm font-semibold text-brand-blaban mb-3\">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>\r\n                    <div className=\"flex gap-3 text-3xl\" dir=\"ltr\">\r\n                        {[1, 2, 3, 4, 5].map(v => (\r\n                            <button key={v} onClick={() => setRating(v)} className={clsx(\"transition-transform hover:scale-110 active:scale-95\", rating >= v ? \"text-amber-400\" : \"text-surface-700\")}>\r\n                                <Star className={clsx(\"w-9 h-9\", rating >= v ? \"fill-current\" : \"\")} />\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n                <div>\r\n                    <label className=\"block text-sm font-semibold text-brand-blaban mb-2\">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>\r\n                    <textarea\r\n                        value={comment}\r\n                        onChange={(e) => setComment(e.target.value)}\r\n                        placeholder=\"ÙŠØ±Ø¬Ù‰ ØªØ¯ÙˆÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆÙ†Ø¸Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„...\"\r\n                        className=\"w-full bg-surface-800 border border-surface-700 rounded-xl p-4 focus:ring-4 focus:ring-brand-blaban/10 focus:border-brand-blaban transition-all text-white\"\r\n                        rows={3}\r\n                    />\r\n                </div>\r\n\r\n                <button\r\n                    onClick={() => handleAction('close')}\r\n                    disabled={loading || !comment.trim()}\r\n                    className=\"flex items-center justify-center w-full px-6 py-5 bg-brand-blaban hover:bg-brand-blaban/90 text-white rounded-2xl font-black shadow-2xl shadow-brand-blaban/30 transition-all disabled:opacity-70 active:scale-95\"\r\n                >\r\n                    {loading ? <Loader2 className=\"w-6 h-6 animate-spin\" /> : <Save className=\"w-6 h-6 ml-2\" />}\r\n                    <span>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const handleAction = async (action: 'start_work' | 'resolve' | 'close') => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            // 1. Capture GeoLocation for critical steps\r\n            const coords = await getGeoLocation();\r\n            let updatePayload: any = {};\r\n\r\n            if (action === 'start_work') {\r\n                // â”€â”€â”€ Stage 3: Dynamic Geofencing for Start Work â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n                const { data: rawSettings } = await supabase.from('system_settings').select('*');\r\n                const settings = rawSettings?.reduce((acc, s) => ({ ...acc, [s.key]: s.value }), {} as any) || {};\r\n\r\n                const isGeofenceEnabled = settings.geofencing_enabled === 'true';\r\n                const radius = parseInt(settings.geofencing_radius || '100');\r\n\r\n                if (isGeofenceEnabled) {\r\n                    const { data: branch } = await supabase.from('branches').select('latitude, longitude, name').eq('id', ticket.branch_id).single();\r\n                    if (!branch?.latitude || !branch?.longitude) {\r\n                        throw new Error(`ğŸš« ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ: Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„ÙØ±Ø¹: ${branch?.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}) ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØµØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©.`);\r\n                    }\r\n\r\n                    const { calculateDistance } = await import('@/lib/geo');\r\n                    const dist = calculateDistance(coords.lat, coords.lng, branch.latitude, branch.longitude);\r\n                    if (dist > radius) {\r\n                        throw new Error(`ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ: ÙŠØªØ·Ù„Ø¨ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„ÙØ±Ø¹ (Ø£Ù‚Ù„ Ù…Ù† ${radius}Ù…). Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${Math.round(dist)} Ù…ØªØ±.`);\r\n                    }\r\n                }\r\n\r\n                // â”€â”€â”€ Shift Enforcement â”€â”€â”€\r\n                const { data: activeShift } = await supabase\r\n                    .from('technician_attendance')\r\n                    .select('id')\r\n                    .eq('profile_id', profile?.id)\r\n                    .is('clock_out', null)\r\n                    .maybeSingle();\r\n\r\n                if (!activeShift) {\r\n                    throw new Error('ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Clock-in). ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.');\r\n                }\r\n\r\n\r\n                updatePayload = {\r\n                    status: 'in_progress',\r\n                    started_at: new Date().toISOString(),\r\n                    started_lat: coords.lat,\r\n                    started_lng: coords.lng\r\n                };\r\n\r\n                // â”€â”€â”€ Automated HR Mission Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n                // [QUANTUM FIX] Mission Idempotency Key to prevent Ghost Data duplicates\r\n                const submissionId = `mission-${ticket.id}-${profile?.id}-${Date.now()}`;\r\n                const { error: missionError } = await supabase.rpc('log_technician_mission', {\r\n                    p_ticket_id: ticket.id,\r\n                    p_to_branch_id: ticket.branch_id,\r\n                    p_submission_id: submissionId\r\n                });\r\n                if (missionError) {\r\n                    console.error('HR Mission Log failed:', missionError);\r\n                    // We don't block the repair for mission logging errors, but we log it\r\n                }\r\n            }\r\n            else if (action === 'resolve') {\r\n                // â”€â”€â”€ Operational Excellence: Atomic Inventory Deduction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n                if (partsUsed.length > 0) {\r\n                    const submissionId = `inv-${ticket.id}-${Date.now()}`; // Unique ID for this deduction\r\n                    const { error: invError } = await supabase.rpc('deduct_inventory_atomic', {\r\n                        p_ticket_id: ticket.id,\r\n                        p_technician_id: profile?.id,\r\n                        p_items: partsUsed.map(p => ({ part_id: p.part_id, qty: p.qty })),\r\n                        p_submission_id: submissionId\r\n                    });\r\n                    if (invError) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØµØ±Ù Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±: ' + invError.message);\r\n                }\r\n\r\n\r\n                updatePayload = {\r\n                    status: 'resolved',\r\n                    resolved_lat: coords.lat,\r\n                    resolved_lng: coords.lng,\r\n                    resolved_at: new Date().toISOString(),\r\n                    resolved_image_url: resolvedImageUrl,\r\n                    fault_type_id: selectedCategory || null,\r\n                    asset_id: selectedAsset || ticket.asset_id,\r\n                    downtime_start: downtimeStart || ticket.downtime_start,\r\n                    updated_at: new Date().toISOString()\r\n                };\r\n\r\n                // Update asset status back to operational if linked\r\n                if (selectedAsset || ticket.asset_id) {\r\n                    await supabase.from('maintenance_assets').update({\r\n                        status: 'operational',\r\n                        last_maintenance_at: new Date().toISOString()\r\n                    }).eq('id', selectedAsset || ticket.asset_id);\r\n                }\r\n            }\r\n            else if (action === 'close') {\r\n                // â”€â”€â”€ Stage 5: Mandatory Evaluation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n                if (!rating || !comment.trim()) {\r\n                    throw new Error('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØªØ¯ÙˆÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ø¥ØªÙ…Ø§Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº.');\r\n                }\r\n\r\n                updatePayload = {\r\n                    status: 'closed',\r\n                    rating_score: rating,\r\n                    rating_comment: comment,\r\n                    updated_at: new Date().toISOString()\r\n                };\r\n            }\r\n\r\n            // Update Ticket\r\n            const { error: updateError } = await supabase\r\n                .from('tickets')\r\n                .update(updatePayload)\r\n                .eq('id', ticket.id);\r\n\r\n            if (updateError) {\r\n                // Check if it's a network error\r\n                if (!navigator.onLine || updateError.message?.includes('Fetch')) {\r\n                    OfflineQueue.enqueue({\r\n                        table: 'tickets',\r\n                        action: 'update',\r\n                        data: updatePayload,\r\n                        filter: { column: 'id', value: ticket.id }\r\n                    });\r\n                    setError('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„). Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¢Ù„ÙŠØ§Ù‹ ÙÙˆØ± Ø¹ÙˆØ¯Ø© Ø§Ù„Ø´Ø¨ÙƒØ©.');\r\n                    onUpdate();\r\n                    return;\r\n                }\r\n                throw updateError;\r\n            }\r\n            onUpdate();\r\n\r\n        } catch (e: any) {\r\n            console.error('Ticket Action Error:', e);\r\n            setError(e.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©.');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // â”€â”€â”€ Shift Check for UI Logic â”€â”€â”€\r\n    const [activeShiftId, setActiveShiftId] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        const checkShift = async () => {\r\n            if (!profile?.id) return;\r\n            const { data } = await supabase\r\n                .from('technician_attendance')\r\n                .select('id')\r\n                .eq('profile_id', profile.id)\r\n                .is('clock_out', null)\r\n                .maybeSingle();\r\n            setActiveShiftId(data?.id || null);\r\n        };\r\n        checkShift();\r\n    }, [profile?.id, ticket.status]);\r\n\r\n    // Memoize the timeline events for the ledger view\r\n    const ledgerEvents = useMemo(() => {\r\n        const events = [\r\n            { id: 'created', label: 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº', time: ticket.created_at, icon: ClipboardList, status: 'completed', desc: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©' },\r\n            { id: 'assigned', label: 'ØªØ®ØµÙŠØµ Ø§Ù„ÙØ±ÙŠÙ‚', time: ticket.assigned_at, icon: UserCog, status: ticket.assigned_to ? 'completed' : 'pending', desc: ticket.assigned_to ? 'ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø®ØªØµ' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ®ØµÙŠØµ Ø§Ù„ÙƒÙˆØ§Ø¯ Ø§Ù„ÙÙ†ÙŠØ©' },\r\n            { id: 'started', label: 'Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©', time: ticket.started_at, icon: HardHat, status: ticket.started_at ? 'completed' : (ticket.status === 'assigned' ? 'active' : 'pending'), desc: ticket.started_at ? 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠØ©' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± ÙˆØµÙˆÙ„ Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ù…ÙˆÙ‚Ø¹' },\r\n            { id: 'resolved', label: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', time: ticket.resolved_at, icon: Wrench, status: ticket.resolved_at ? 'completed' : (ticket.status === 'in_progress' ? 'active' : 'pending'), desc: ticket.resolved_at ? 'ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø·Ù„ ÙˆØªÙˆØ«ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„' : 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' },\r\n            { id: 'closed', label: 'Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ', time: ticket.closed_at, icon: ShieldCheck, status: ticket.closed_at ? 'completed' : (ticket.status === 'resolved' ? 'active' : 'pending'), desc: ticket.closed_at ? 'ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' },\r\n        ];\r\n        return events;\r\n    }, [ticket]);\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-8 animate-in fade-in zoom-in-95 duration-500\">\r\n            {/* Field Ops Ledger Header */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                <div className=\"lg:col-span-2 space-y-6\">\r\n                    <div className=\"glass-premium rounded-3xl border border-surface-800 p-8 shadow-inner bg-surface-950/40\">\r\n                        <div className=\"flex justify-between items-start mb-6\">\r\n                            <div>\r\n                                <div className=\"flex items-center gap-3 mb-2\">\r\n                                    <span className=\"px-3 py-1 bg-brand-blaban/10 text-brand-blaban text-[10px] font-black uppercase tracking-[0.2em] rounded-lg border border-brand-blaban/20\">Ticket ID: #{ticket.id.slice(0, 8)}</span>\r\n                                    {ticket.is_emergency && <span className=\"px-3 py-1 bg-red-500/10 text-red-500 text-[10px] font-black uppercase tracking-[0.2em] rounded-lg border border-red-500/20 animate-pulse\">Critical Priority</span>}\r\n                                </div>\r\n                                <h3 className=\"text-2xl font-black text-white mb-2\">{ticket.asset_name || 'Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ'}</h3>\r\n                                <p className=\"text-surface-400 font-medium leading-relaxed\">{ticket.description}</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 border-t border-surface-800/50 pt-6\">\r\n                            <div className=\"space-y-1\">\r\n                                <p className=\"text-[10px] font-black text-surface-600 uppercase tracking-widest\">ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¨Ù„Ø§Øº</p>\r\n                                <p className=\"text-xs font-bold text-white\">{format(new Date(ticket.created_at), 'PPP Â· p', { locale: ar })}</p>\r\n                            </div>\r\n                            <div className=\"space-y-1\">\r\n                                <p className=\"text-[10px] font-black text-surface-600 uppercase tracking-widest\">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</p>\r\n                                <p className=\"text-xs font-bold text-brand-blaban\">{ticket.branches?.name || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±Ù'}</p>\r\n                            </div>\r\n                            {ticket.reported_lat && (\r\n                                <div className=\"space-y-1\">\r\n                                    <p className=\"text-[10px] font-black text-surface-600 uppercase tracking-widest\">Coordinates Status</p>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <div className=\"w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]\" />\r\n                                        <p className=\"text-xs font-bold text-emerald-500/80\">GPS Validated</p>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Operational Actions */}\r\n                    {error && (\r\n                        <div className=\"p-4 bg-red-900/20 border border-red-900/30 rounded-2xl flex items-center gap-3 text-red-400 text-sm font-bold animate-in shake\">\r\n                            <AlertCircle className=\"w-5 h-5 shrink-0\" />\r\n                            {error}\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"space-y-4\">\r\n                        {/* Technician Actions */}\r\n                        {ticket.status === 'assigned' && (profile?.role === 'technician' || profile?.role === 'maint_supervisor') && (\r\n                            <div className=\"glass-premium p-6 rounded-3xl border border-brand-blaban/30 bg-brand-blaban/5 shadow-2xl\">\r\n                                <div className=\"flex items-center gap-4 mb-6\">\r\n                                    <div className=\"w-12 h-12 rounded-2xl bg-brand-blaban/10 flex items-center justify-center text-brand-blaban\">\r\n                                        <Play className=\"w-6 h-6 fill-current\" />\r\n                                    </div>\r\n                                    <div>\r\n                                        <h4 className=\"text-lg font-black text-white\">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</h4>\r\n                                        <p className=\"text-xs text-surface-500 font-bold uppercase tracking-wider\">Field Presence Verification Required</p>\r\n                                    </div>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => handleAction('start_work')}\r\n                                    disabled={loading || !activeShiftId}\r\n                                    className=\"w-full py-4 bg-brand-blaban text-white font-black uppercase tracking-[0.2em] rounded-2xl shadow-xl shadow-brand-blaban/30 hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-50 disabled:grayscale\"\r\n                                >\r\n                                    {loading ? <Loader2 className=\"w-5 h-5 animate-spin mx-auto\" /> : 'Confirm Presence & Start Repair'}\r\n                                </button>\r\n                                {!activeShiftId && (\r\n                                    <p className=\"mt-4 text-[10px] text-red-500 font-black text-center uppercase tracking-widest animate-pulse\">Critical: Active Shift Required to Process Field Data</p>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {ticket.status === 'in_progress' && (profile?.role === 'technician' || profile?.role === 'maint_supervisor') && (\r\n                            <div className=\"glass-premium p-8 rounded-[2.5rem] border border-surface-800 bg-surface-950/50 shadow-2xl\">\r\n                                {isMobile ? (\r\n                                    <button onClick={() => setIsResolveSheetOpen(true)} className=\"w-full py-5 bg-emerald-600 text-white font-black uppercase tracking-[0.2em] rounded-2xl shadow-xl shadow-emerald-500/20\">Resolve & Document</button>\r\n                                ) : renderResolutionForm()}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Manager Actions */}\r\n                        {ticket.status === 'resolved' && (profile?.role === 'manager' || profile?.role === 'maint_manager') && (\r\n                            <div className=\"glass-premium p-8 rounded-[2.5rem] border border-surface-800 bg-surface-950/50 shadow-2xl\">\r\n                                {isMobile ? (\r\n                                    <button onClick={() => setIsRateSheetOpen(true)} className=\"w-full py-5 bg-brand-blaban text-white font-black uppercase tracking-[0.2em] rounded-2xl shadow-xl shadow-brand-blaban/30\">Review & Approve</button>\r\n                                ) : renderRateForm()}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Vertical Timeline (Operational Ledger) */}\r\n                <div className=\"space-y-6\">\r\n                    <div className=\"glass-premium rounded-3xl border border-surface-800 p-6 flex flex-col gap-8 relative overflow-hidden\">\r\n                        <div className=\"absolute top-0 left-10 bottom-0 w-px bg-surface-800 z-0\" />\r\n                        <h4 className=\"flex items-center gap-3 text-xs font-black text-surface-500 uppercase tracking-[0.3em] z-10\">\r\n                            <History className=\"w-4 h-4 text-brand-blaban\" />\r\n                            Operational Progress\r\n                        </h4>\r\n\r\n                        <div className=\"space-y-10 relative z-10\">\r\n                            {ledgerEvents.map((event) => (\r\n                                <div key={event.id} className=\"flex gap-6 group\">\r\n                                    <div className={clsx(\r\n                                        \"w-8 h-8 rounded-xl flex items-center justify-center shrink-0 border transition-all duration-500 group-hover:scale-110\",\r\n                                        event.status === 'completed' ? \"bg-brand-blaban/20 border-brand-blaban/40 text-brand-blaban\" :\r\n                                            event.status === 'active' ? \"bg-amber-500/10 border-amber-500/40 text-amber-500 animate-pulse\" :\r\n                                                \"bg-surface-900 border-surface-800 text-surface-600\"\r\n                                    )}>\r\n                                        <event.icon className=\"w-4 h-4\" />\r\n                                    </div>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <div className=\"flex justify-between items-baseline mb-1\">\r\n                                            <h5 className={clsx(\"text-sm font-black tracking-tight\", event.status === 'completed' ? \"text-white\" : \"text-surface-500\")}>{event.label}</h5>\r\n                                            {event.time && !isNaN(new Date(event.time).getTime()) && <span className=\"text-[9px] font-black text-surface-600 uppercase tracking-widest\">{format(new Date(event.time), 'hh:mm a', { locale: ar })}</span>}\r\n                                        </div>\r\n                                        <p className=\"text-[10px] font-bold text-surface-500 leading-relaxed uppercase tracking-wider\">{event.desc}</p>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Operational Insights */}\r\n                    <div className=\"glass-premium rounded-3xl border border-surface-800 p-6 bg-surface-950/40\">\r\n                        <h4 className=\"flex items-center gap-3 text-xs font-black text-surface-500 uppercase tracking-[0.3em] mb-6\">\r\n                            <Zap className=\"w-4 h-4 text-amber-500\" />\r\n                            System Intelligence\r\n                        </h4>\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"flex items-center justify-between p-3 bg-surface-900 rounded-xl border border-surface-800/50\">\r\n                                <span className=\"text-[10px] font-black text-surface-600 uppercase\">Responders</span>\r\n                                <div className=\"flex -space-x-2\">\r\n                                    <div className=\"w-6 h-6 rounded-full bg-brand-blaban/20 border border-brand-blaban/30\" />\r\n                                    <div className=\"w-6 h-6 rounded-full bg-surface-800 border border-surface-700\" />\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"p-4 bg-surface-900 rounded-2xl border border-surface-800/50\">\r\n                                <div className=\"flex justify-between items-center mb-2\">\r\n                                    <span className=\"text-[10px] font-black text-surface-500 uppercase\">Operational Status</span>\r\n                                    <span className=\"text-[10px] font-black text-emerald-500 uppercase tracking-widest\">Live Flow</span>\r\n                                </div>\r\n                                <div className=\"h-1.5 bg-surface-800 rounded-full overflow-hidden\">\r\n                                    <div\r\n                                        className=\"h-full bg-brand-blaban rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(33,150,243,0.5)]\"\r\n                                        style={{ width: `${(ledgerEvents.filter(e => e.status === 'completed').length / ledgerEvents.length) * 100}%` }}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Bottom Sheets for Mobile Integration */}\r\n            <BottomSheet isOpen={isResolveSheetOpen} onClose={() => setIsResolveSheetOpen(false)} title=\"Operational Resolve Documentation\">\r\n                <div className=\"p-4\">{renderResolutionForm()}</div>\r\n            </BottomSheet>\r\n            <BottomSheet isOpen={isRateSheetOpen} onClose={() => setIsRateSheetOpen(false)} title=\"Managerial Review & Quality Audit\">\r\n                <div className=\"p-4\">{renderRateForm()}</div>\r\n            </BottomSheet>\r\n\r\n            {isAssetScannerOpen && (\r\n                <QRScanner\r\n                    onScan={(text: string) => {\r\n                        const foundAsset = assets.find(a => a.id === text || a.serial_number === text);\r\n                        if (foundAsset) {\r\n                            setSelectedAsset(foundAsset.id);\r\n                            setIsAssetScannerOpen(false);\r\n                        } else {\r\n                            setError('Asset Authentication Failed: Data mismatch in current branch registry.');\r\n                            setIsAssetScannerOpen(false);\r\n                        }\r\n                    }}\r\n                    onClose={() => setIsAssetScannerOpen(false)}\r\n                    title=\"Asset Intelligence Scanner\"\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\maintenance\\pages\\MaintenanceDashboardPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAll'. Either include it or remove the dependency array.","line":51,"column":8,"nodeType":"ArrayExpression","endLine":51,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAll, profile]","fix":{"range":[3070,3079],"text":"[fetchAll, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport TicketFlow from '@/modules/maintenance/components/TicketFlow';\r\nimport Skeleton from '@/components/ui/Skeleton';\r\nimport { Wrench, Users, AlertTriangle, CheckCircle, Clock, Loader2, ChevronDown, ChevronUp, Star, Filter, TrendingUp } from 'lucide-react';\r\nimport { format, eachDayOfInterval, subDays, isSameDay } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport clsx from 'clsx';\r\nimport {\r\n    XAxis, Tooltip, ResponsiveContainer,\r\n    AreaChart, Area, CartesianGrid, BarChart, Bar, Cell\r\n} from 'recharts';\r\nimport { Shield, Activity, Sparkles, Zap, TrendingDown } from 'lucide-react';\r\n\r\nconst STATUS_LABELS: Record<string, { label: string; color: string }> = {\r\n    open: { label: 'Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚)', color: 'bg-blue-900/30 text-blue-400 border-blue-900/50' },\r\n    assigned: { label: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©)', color: 'bg-amber-900/30 text-amber-400 border-amber-900/50' },\r\n    in_progress: { label: 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ', color: 'bg-purple-900/30 text-purple-400 border-purple-900/50' },\r\n    resolved: { label: 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯)', color: 'bg-teal-900/30 text-teal-400 border-teal-900/50' },\r\n    closed: { label: 'Ø¨Ù„Ø§Øº Ù…ØºÙ„Ù‚ (Ù…ÙƒØªÙ…Ù„) âœ“', color: 'bg-surface-800 text-surface-500 border-surface-700' },\r\n};\r\n\r\nconst PRIORITY_OPTIONS = [\r\n    { value: 'normal', label: 'Ø¹Ø§Ø¯ÙŠ', color: 'bg-surface-800 text-surface-400 border-surface-700' },\r\n    { value: 'high', label: 'Ù…Ø±ØªÙØ¹', color: 'bg-amber-900/30 text-amber-400 border-amber-900/50' },\r\n    { value: 'urgent', label: 'Ø¹Ø§Ø¬Ù„', color: 'bg-orange-900/30 text-orange-400 border-orange-900/50' },\r\n    { value: 'critical', label: 'Ø­Ø±Ø¬', color: 'bg-red-900/30 text-red-400 border-red-900/50' },\r\n];\r\n\r\nexport default function MaintenanceDashboardPage() {\r\n    const { profile } = useAuth();\r\n    const [tickets, setTickets] = useState<any[]>([]);\r\n    const [technicians, setTechnicians] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [expandedId, setExpandedId] = useState<string | null>(null);\r\n    const [filter, setFilter] = useState<'all' | 'open' | 'assigned' | 'in_progress' | 'resolved' | 'closed'>('all');\r\n    const [assigning, setAssigning] = useState<string | null>(null); // ticket id being assigned\r\n    const [selectedTech, setSelectedTech] = useState('');\r\n    const [updatingPriority, setUpdatingPriority] = useState<string | null>(null);\r\n    const [techPerformance, setTechPerformance] = useState<any[]>([]);\r\n    const [criticalAssets, setCriticalAssets] = useState<any[]>([]);\r\n    const [showIntelligence, setShowIntelligence] = useState(false);\r\n    const [dailyTrends, setDailyTrends] = useState<any[]>([]);\r\n    const [branchHealth, setBranchHealth] = useState<any[]>([]);\r\n    const [financialImpact, setFinancialImpact] = useState<any[]>([]);\r\n\r\n    useEffect(() => {\r\n        fetchAll();\r\n    }, [profile]);\r\n\r\n    const fetchAll = async () => {\r\n        if (!profile) return;\r\n        setLoading(true);\r\n\r\n        const GLOBAL_ROLES = ['admin', 'maint_manager', 'maint_supervisor'];\r\n        const needsFiltering = !GLOBAL_ROLES.includes(profile.role);\r\n\r\n        let query = supabase\r\n            .from('tickets')\r\n            .select('*, branches(name, area_id), maintenance_categories(name)')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (needsFiltering) {\r\n            if (profile.branch_id) {\r\n                query = query.eq('branch_id', profile.branch_id);\r\n            } else if (profile.area_id) {\r\n                query = query.select('*, branches!inner(name, area_id), maintenance_categories(name)')\r\n                    .eq('branches.area_id', profile.area_id);\r\n            } else if (profile.sector_id) {\r\n                query = query.select('*, branches!inner(name, area_id, areas!inner(sector_id)), maintenance_categories(name)')\r\n                    .eq('branches.areas.sector_id', profile.sector_id);\r\n            } else if (profile.brand_id) {\r\n                query = query.select('*, branches!inner(name, area_id, areas!inner(sector_id, sectors!inner(brand_id))), maintenance_categories(name)')\r\n                    .eq('branches.areas.sectors.brand_id', profile.brand_id);\r\n            }\r\n        }\r\n\r\n        const { data: ticketData } = await query;\r\n        const processedTickets = ticketData || [];\r\n        setTickets(processedTickets);\r\n\r\n        // Process Daily Trends for the last 7 days\r\n        const days = eachDayOfInterval({\r\n            start: subDays(new Date(), 6),\r\n            end: new Date()\r\n        });\r\n        const trends = days.map(day => ({\r\n            date: format(day, 'MM/dd'),\r\n            count: processedTickets.filter(t => isSameDay(new Date(t.created_at), day)).length,\r\n            resolved: processedTickets.filter(t => t.resolved_at && isSameDay(new Date(t.resolved_at), day)).length\r\n        }));\r\n        setDailyTrends(trends);\r\n\r\n        // Load Intelligence Data\r\n        const { data: perfData } = await supabase.from('v_technician_performance').select('*').limit(5);\r\n        setTechPerformance(perfData || []);\r\n\r\n        const { data: assetData } = await supabase.from('v_critical_assets_report').select('*').limit(5);\r\n        setCriticalAssets(assetData || []);\r\n\r\n        try {\r\n            const { data: techData } = await supabase\r\n                .from('profiles')\r\n                .select('id, full_name, employee_code')\r\n                .in('role', ['technician', 'maint_supervisor']);\r\n            setTechnicians(techData || []);\r\n\r\n            const { data: healthData } = await supabase.from('v_branch_health_index').select('*').limit(3);\r\n            setBranchHealth(healthData || []);\r\n\r\n            const { data: financeData } = await supabase.from('v_financial_impact_report').select('*').limit(3);\r\n            setFinancialImpact(financeData || []);\r\n        } catch (e) { console.error(\"Error loading intelligence data\", e); }\r\n\r\n        setLoading(false);\r\n    };\r\n\r\n    const handleAssign = async (ticketId: string) => {\r\n        if (!selectedTech || !profile) return;\r\n        setAssigning(ticketId);\r\n        try {\r\n            const { error } = await supabase\r\n                .from('tickets')\r\n                .update({\r\n                    assigned_to: selectedTech,\r\n                    assigned_by: profile.id,\r\n                    status: 'assigned',\r\n                    updated_at: new Date().toISOString(),\r\n                })\r\n                .eq('id', ticketId);\r\n            if (error) throw error;\r\n            setSelectedTech('');\r\n            fetchAll();\r\n        } catch (e: any) {\r\n            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ' + e.message);\r\n        } finally {\r\n            setAssigning(null);\r\n        }\r\n    };\r\n\r\n    const handlePriorityChange = async (ticketId: string, newPriority: string) => {\r\n        if (profile?.role !== 'maint_manager' && profile?.role !== 'admin') return;\r\n        setUpdatingPriority(ticketId);\r\n        try {\r\n            const { error } = await supabase\r\n                .from('tickets')\r\n                .update({ priority: newPriority, updated_at: new Date().toISOString() })\r\n                .eq('id', ticketId);\r\n            if (error) throw error;\r\n            fetchAll();\r\n        } catch (e: any) {\r\n            alert('Ø®Ø·Ø£: ' + e.message);\r\n        } finally {\r\n            setUpdatingPriority(null);\r\n        }\r\n    };\r\n\r\n    const filtered = tickets.filter(t => {\r\n        if (filter === 'all') return true;\r\n        return t.status === filter;\r\n    });\r\n\r\n    const counts = {\r\n        all: tickets.length,\r\n        open: tickets.filter(t => t.status === 'open').length,\r\n        assigned: tickets.filter(t => t.status === 'assigned').length,\r\n        in_progress: tickets.filter(t => t.status === 'in_progress').length,\r\n        resolved: tickets.filter(t => t.status === 'resolved').length,\r\n        closed: tickets.filter(t => t.status === 'closed').length,\r\n    };\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            {/* Header */}\r\n            <div className=\"mb-6\">\r\n                <h2 className=\"text-2xl font-bold text-white\">\r\n                    {profile?.role === 'admin' ? 'ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§)' :\r\n                        profile?.role === 'maint_manager' ? 'ğŸ› ï¸ Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠØ© (Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©)' : 'ğŸ”§ Ù…Ù†ØµØ© Ø§Ù„Ø¥Ø´Ø±Ø§Ù ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©'}\r\n                </h2>\r\n                <p className=\"text-surface-400 text-sm mt-1\">\r\n                    {profile?.role === 'admin' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„ÙŠØ§ Ù„ÙƒØ§ÙØ© Ø¨Ù„Ø§ØºØ§Øª ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…' :\r\n                        profile?.role === 'maint_manager'\r\n                            ? 'Ø­ÙˆÙƒÙ…Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§ØªØŒ Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠØ©ØŒ Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯ØŒ ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©'\r\n                            : 'Ø¥Ø¯Ø§Ø±Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ'}\r\n                </p>\r\n            </div>\r\n\r\n            {/* KPI Summary */}\r\n            <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-8\">\r\n                {([\r\n                    { key: 'all', label: 'Ø§Ù„ÙƒÙ„', icon: Wrench, color: 'bg-surface-900 border-surface-800 text-surface-400' },\r\n                    { key: 'open', label: 'Ø¬Ø¯ÙŠØ¯', icon: AlertTriangle, color: 'bg-blue-900/10 border-blue-900/30 text-blue-400' },\r\n                    { key: 'assigned', label: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯', icon: Users, color: 'bg-amber-900/10 border-amber-900/30 text-amber-400' },\r\n                    { key: 'in_progress', label: 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', icon: Clock, color: 'bg-purple-900/10 border-purple-900/30 text-purple-400' },\r\n                    { key: 'resolved', label: 'ÙŠÙ†ØªØ¸Ø± Ø§Ø¹ØªÙ…Ø§Ø¯', icon: Star, color: 'bg-teal-900/10 border-teal-900/30 text-teal-400' },\r\n                    { key: 'closed', label: 'Ù…ÙƒØªÙ…Ù„', icon: CheckCircle, color: 'bg-green-900/10 border-green-900/30 text-green-400' },\r\n                ] as const).map(item => (\r\n                    <button\r\n                        key={item.key}\r\n                        onClick={() => setFilter(item.key)}\r\n                        className={`p-4 rounded-2xl border text-right transition-all ${item.color} ${filter === item.key ? 'ring-2 ring-brand-blaban shadow-md' : 'hover:shadow-sm'}`}\r\n                    >\r\n                        <item.icon className=\"w-5 h-5 mb-1 opacity-60\" />\r\n                        <p className=\"text-2xl font-bold text-white\">{counts[item.key]}</p>\r\n                        <p className=\"text-xs font-medium mt-0.5\">{item.label}</p>\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Daily Performance Trend */}\r\n            <div className=\"bg-surface-900 border border-surface-800 rounded-3xl p-6 mb-8 shadow-sm\">\r\n                <div className=\"flex items-center justify-between mb-6\">\r\n                    <h3 className=\"text-lg font-bold text-white flex items-center gap-2\">\r\n                        <TrendingUp className=\"w-5 h-5 text-brand-blaban\" /> ÙƒØ«Ø§ÙØ© ÙˆØªØ¯ÙÙ‚ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)\r\n                    </h3>\r\n                    <div className=\"flex items-center gap-4 text-[10px] uppercase tracking-widest font-bold\">\r\n                        <div className=\"flex items-center gap-1.5\"><div className=\"w-2 h-2 rounded-full bg-brand-blaban\" /> Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>\r\n                        <div className=\"flex items-center gap-1.5\"><div className=\"w-2 h-2 rounded-full bg-teal-400\" /> Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"h-[200px] w-full\">\r\n                    {loading ? <Skeleton className=\"h-full w-full rounded-2xl\" /> : (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <AreaChart data={dailyTrends}>\r\n                                <defs>\r\n                                    <linearGradient id=\"colorCount\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                        <stop offset=\"5%\" stopColor=\"#004aad\" stopOpacity={0.2} />\r\n                                        <stop offset=\"95%\" stopColor=\"#004aad\" stopOpacity={0} />\r\n                                    </linearGradient>\r\n                                    <linearGradient id=\"colorResolved\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                        <stop offset=\"5%\" stopColor=\"#2dd4bf\" stopOpacity={0.2} />\r\n                                        <stop offset=\"95%\" stopColor=\"#2dd4bf\" stopOpacity={0} />\r\n                                    </linearGradient>\r\n                                </defs>\r\n                                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#1e293b\" vertical={false} />\r\n                                <XAxis dataKey=\"date\" stroke=\"#64748b\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                <Tooltip\r\n                                    contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                    itemStyle={{ fontSize: '12px', fontWeight: 'bold' }}\r\n                                />\r\n                                <Area type=\"monotone\" dataKey=\"count\" name=\"Ø¬Ø¯ÙŠØ¯\" stroke=\"#004aad\" strokeWidth={3} fillOpacity={1} fill=\"url(#colorCount)\" />\r\n                                <Area type=\"monotone\" dataKey=\"resolved\" name=\"Ù…Ù†Ø¬Ø²\" stroke=\"#2dd4bf\" strokeWidth={3} fillOpacity={1} fill=\"url(#colorResolved)\" />\r\n                            </AreaChart>\r\n                        </ResponsiveContainer>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Intelligence Highlights Toggle */}\r\n            <div className=\"mb-6\">\r\n                <button\r\n                    onClick={() => setShowIntelligence(!showIntelligence)}\r\n                    className=\"flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-brand-blaban to-brand-blaban/80 text-white rounded-2xl shadow-lg shadow-brand-blaban/20 hover:shadow-xl transition-all font-bold\"\r\n                >\r\n                    <Star className={clsx(\"w-5 h-5\", showIntelligence && \"fill-white\")} />\r\n                    <span>{showIntelligence ? 'Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ (Sovereign Intelligence)' : 'Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ØªÙ†Ø¨Ø¤ÙŠØ© (Sovereign Intelligence)'}</span>\r\n                </button>\r\n            </div>\r\n\r\n            {showIntelligence && (\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 animate-in fade-in slide-in-from-top-4 duration-500\">\r\n                    {loading ? (\r\n                        <>\r\n                            <div className=\"bg-white dark:bg-surface-900 rounded-3xl border border-surface-200 dark:border-surface-800 p-8 h-[400px]\">\r\n                                <Skeleton variant=\"text\" width=\"60%\" height=\"2rem\" className=\"mb-8\" />\r\n                                <div className=\"space-y-6\">\r\n                                    {[1, 2, 3].map(i => <Skeleton key={i} variant=\"rectangular\" width=\"100%\" height=\"3rem\" className=\"rounded-2xl\" />)}\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"bg-white dark:bg-surface-900 rounded-3xl border border-surface-200 dark:border-surface-800 p-8 h-[400px]\">\r\n                                <Skeleton variant=\"text\" width=\"40%\" height=\"2rem\" className=\"mb-8\" />\r\n                                <div className=\"space-y-4\">\r\n                                    {[1, 2, 3, 4].map(i => <Skeleton key={i} variant=\"rectangular\" width=\"100%\" height=\"4rem\" className=\"rounded-2xl\" />)}\r\n                                </div>\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            {/* Economic Impact - Total Cost of Failures */}\r\n                            <div className=\"bg-surface-900 rounded-3xl border border-surface-800 p-6 shadow-sm relative overflow-hidden\">\r\n                                <div className=\"absolute top-0 right-0 w-32 h-32 bg-red-500/5 rounded-full -mr-16 -mt-16 blur-2xl\" />\r\n                                <div className=\"flex items-center justify-between mb-8 relative\">\r\n                                    <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                                        <TrendingDown className=\"w-5 h-5 text-red-500\" /> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù„Ù„Ø£Ø¹Ø·Ø§Ù„ (Economic Impact)\r\n                                    </h3>\r\n                                    <span className=\"text-[10px] font-bold text-red-400 bg-red-900/20 px-3 py-1 rounded-full border border-red-900/30\">ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø®Ø³Ø§Ø¦Ø±</span>\r\n                                </div>\r\n                                <div className=\"space-y-4\">\r\n                                    {financialImpact.map((item, i) => (\r\n                                        <div key={i} className=\"p-4 bg-surface-800/50 rounded-2xl border border-surface-800 hover:border-red-900/30 transition-all group\">\r\n                                            <div className=\"flex justify-between items-start mb-3\">\r\n                                                <div>\r\n                                                    <p className=\"font-bold text-white text-sm\">{item.asset_name}</p>\r\n                                                    <p className=\"text-[10px] text-surface-500\">ğŸ“ {item.branch_name}</p>\r\n                                                </div>\r\n                                                <div className=\"text-left\">\r\n                                                    <p className=\"text-sm font-black text-red-400\">{Number(item.total_economic_impact).toLocaleString()} Ø¬.Ù…</p>\r\n                                                    <p className=\"text-[9px] text-surface-500 uppercase\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø³Ø§Ø¦Ø±</p>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div className=\"grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-surface-800\">\r\n                                                <div>\r\n                                                    <p className=\"text-[9px] text-surface-500\">Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</p>\r\n                                                    <p className=\"text-xs font-bold text-white\">{Number(item.direct_parts_cost).toLocaleString()} Ø¬.Ù…</p>\r\n                                                </div>\r\n                                                <div className=\"text-left\">\r\n                                                    <p className=\"text-[9px] text-surface-500\">Ø®Ø³Ø§Ø¦Ø± Ø§Ù„ØªÙˆÙ‚Ù</p>\r\n                                                    <p className=\"text-xs font-bold text-amber-500\">{Number(item.estimated_downtime_loss).toLocaleString()} Ø¬.Ù…</p>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Branch Health Index - Strategic Map Representation */}\r\n                            <div className=\"bg-surface-900 rounded-3xl border border-surface-800 p-6 shadow-sm relative overflow-hidden lg:col-span-2\">\r\n                                <div className=\"absolute top-0 left-0 w-64 h-64 bg-brand-blaban/5 rounded-full -ml-32 -mt-32 blur-3xl\" />\r\n                                <div className=\"flex items-center justify-between mb-8 relative\">\r\n                                    <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                                        <Shield className=\"w-5 h-5 text-brand-blaban\" /> ÙƒØ´Ø§ÙØ© Ø§Ù„ØµØ­Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© Ù„Ù„ÙØ±ÙˆØ¹ (Branch Health Index)\r\n                                    </h3>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <div className=\"flex items-center gap-1\"><div className=\"w-2 h-2 rounded-full bg-green-500\" /> <span className=\"text-[9px] text-surface-500\">Ù…Ø³ØªÙ‚Ø±</span></div>\r\n                                        <div className=\"flex items-center gap-1\"><div className=\"w-2 h-2 rounded-full bg-orange-500\" /> <span className=\"text-[9px] text-surface-500\">Ù…ØªØ­ÙØ²</span></div>\r\n                                        <div className=\"flex items-center gap-1\"><div className=\"w-2 h-2 rounded-full bg-red-500\" /> <span className=\"text-[9px] text-surface-500\">Ø­Ø±Ø¬</span></div>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                                    {branchHealth.map((branch, i) => (\r\n                                        <div key={i} className=\"relative p-6 bg-surface-800/30 rounded-3xl border border-surface-800 hover:bg-surface-800/50 transition-all group overflow-hidden\">\r\n                                            <div className={clsx(\r\n                                                \"absolute top-0 right-0 w-16 h-16 opacity-10 -mr-8 -mt-8 rounded-full\",\r\n                                                branch.health_score > 80 ? \"bg-green-500\" : branch.health_score > 60 ? \"bg-orange-500\" : \"bg-red-500\"\r\n                                            )} />\r\n                                            <div className=\"flex flex-col items-center text-center\">\r\n                                                <div className=\"relative mb-4\">\r\n                                                    <svg className=\"w-24 h-24 transform -rotate-90\">\r\n                                                        <circle cx=\"48\" cy=\"48\" r=\"42\" className=\"stroke-surface-800 fill-none\" strokeWidth=\"8\" />\r\n                                                        <circle\r\n                                                            cx=\"48\" cy=\"48\" r=\"42\"\r\n                                                            className={clsx(\r\n                                                                \"fill-none transition-all duration-1000\",\r\n                                                                branch.health_score > 80 ? \"stroke-green-500\" : branch.health_score > 60 ? \"stroke-orange-500\" : \"stroke-red-500\"\r\n                                                            )}\r\n                                                            strokeWidth=\"8\"\r\n                                                            strokeDasharray={264}\r\n                                                            strokeDashoffset={264 - (branch.health_score * 2.64)}\r\n                                                            strokeLinecap=\"round\"\r\n                                                        />\r\n                                                    </svg>\r\n                                                    <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\r\n                                                        <span className=\"text-2xl font-black text-white\">{Math.round(branch.health_score)}%</span>\r\n                                                        <span className=\"text-[8px] font-bold text-surface-500 uppercase tracking-tighter\">Health</span>\r\n                                                    </div>\r\n                                                </div>\r\n                                                <h4 className=\"font-bold text-white mb-1\">{branch.branch_name}</h4>\r\n                                                <div className=\"flex items-center gap-1.5 px-2 py-0.5 bg-surface-900 rounded-full border border-surface-800\">\r\n                                                    <Activity className=\"w-3 h-3 text-brand-blaban\" />\r\n                                                    <span className=\"text-[10px] text-surface-400\">{branch.tickets_count} Ø¨Ù„Ø§Øº Ù†Ø´Ø·</span>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Predictive Maintenance & Technician Efficiency */}\r\n                            <div className=\"bg-surface-900 rounded-3xl border border-surface-800 p-6 shadow-sm relative overflow-hidden lg:col-span-2\">\r\n                                <div className=\"flex items-center justify-between mb-8 relative\">\r\n                                    <h3 className=\"text-xl font-bold text-white flex items-center gap-2\">\r\n                                        <Sparkles className=\"w-5 h-5 text-amber-500\" /> ØªØ­Ù„ÙŠÙ„ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ÙÙ†ÙŠØ© (Technician Efficiency Matrix)\r\n                                    </h3>\r\n                                    <button className=\"text-xs text-brand-blaban font-bold flex items-center gap-1\">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ <Zap className=\"w-3 h-3\" /></button>\r\n                                </div>\r\n                                <div className=\"h-[250px] w-full\">\r\n                                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                        <BarChart data={techPerformance}>\r\n                                            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#1e293b\" vertical={false} />\r\n                                            <XAxis dataKey=\"technician_name\" stroke=\"#64748b\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                            <Tooltip\r\n                                                contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                                itemStyle={{ fontSize: '12px', fontWeight: 'bold' }}\r\n                                            />\r\n                                            <Bar dataKey=\"avg_repair_hours\" name=\"Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø³)\" radius={[6, 6, 0, 0]} barSize={40}>\r\n                                                {techPerformance.map((_, index) => (\r\n                                                    <Cell key={`cell-${index}`} fill={index % 2 === 0 ? '#004aad' : '#f58220'} fillOpacity={0.8} />\r\n                                                ))}\r\n                                            </Bar>\r\n                                        </BarChart>\r\n                                    </ResponsiveContainer>\r\n                                </div>\r\n                            </div>\r\n                            {/* MTBF Analysis - Critical Assets Reliability */}\r\n                            <div className=\"bg-surface-900 rounded-3xl border border-surface-800 p-6 shadow-sm relative overflow-hidden lg:col-span-2\">\r\n                                <h3 className=\"text-xl font-bold text-white flex items-center gap-2 mb-6\">\r\n                                    <AlertTriangle className=\"w-5 h-5 text-orange-500\" /> ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© (Asset Reliability - MTBF)\r\n                                </h3>\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                                    {criticalAssets.map((asset, i) => (\r\n                                        <div key={i} className=\"p-4 bg-surface-800/30 rounded-2xl border border-surface-800 hover:border-orange-500/30 transition-all text-center\">\r\n                                            <p className=\"text-xs font-bold text-white mb-2 truncate\">{asset.asset_name}</p>\r\n                                            <div className=\"text-xl font-black text-orange-500 mb-1\">{asset.failure_count}</div>\r\n                                            <p className=\"text-[9px] text-surface-500 uppercase\">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</p>\r\n                                            <div className=\"mt-3 pt-3 border-t border-surface-800\">\r\n                                                <p className=\"text-[10px] text-surface-400\">Downtime: {asset.total_downtime_hours}h</p>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* Tickets List */}\r\n            {loading ? (\r\n                <div className=\"flex justify-center py-20\"><Loader2 className=\"w-8 h-8 animate-spin text-primary-400\" /></div>\r\n            ) : filtered.length === 0 ? (\r\n                <div className=\"bg-surface-900 rounded-2xl border border-surface-800 p-16 text-center text-surface-500\">\r\n                    <Filter className=\"w-12 h-12 mx-auto mb-3 text-surface-700\" />\r\n                    <p className=\"font-medium\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ© Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø§Ù„ÙŠØ§Ù‹</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"space-y-3\">\r\n                    {filtered.map(ticket => {\r\n                        const st = STATUS_LABELS[ticket.status] || { label: ticket.status, color: 'bg-surface-100 text-surface-500 border-surface-200' };\r\n                        const isExpanded = expandedId === ticket.id;\r\n                        const assignedTech = technicians.find(t => t.id === ticket.assigned_to);\r\n\r\n                        return (\r\n                            <div key={ticket.id} className=\"bg-surface-900 rounded-2xl border border-surface-800 shadow-sm overflow-hidden\">\r\n                                {/* Ticket Header */}\r\n                                <button\r\n                                    onClick={() => setExpandedId(isExpanded ? null : ticket.id)}\r\n                                    className=\"w-full flex items-center justify-between p-5 text-right hover:bg-surface-800 transition-colors\"\r\n                                >\r\n                                    <div className=\"flex items-center gap-3 flex-wrap\">\r\n                                        <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${st.color}`}>{st.label}</span>\r\n                                        {ticket.priority && ticket.priority !== 'normal' && (\r\n                                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${ticket.priority === 'critical' ? 'bg-red-900/30 text-red-400 border border-red-900/50' :\r\n                                                ticket.priority === 'urgent' ? 'bg-orange-900/30 text-orange-400 border border-orange-900/50' :\r\n                                                    'bg-amber-900/30 text-amber-400 border border-amber-900/50'\r\n                                                }`}>\r\n                                                {ticket.priority === 'critical' ? 'ğŸ”´ Ø­Ø±Ø¬' : ticket.priority === 'urgent' ? 'ğŸŸ  Ø¹Ø§Ø¬Ù„' : 'ğŸŸ¡ Ù…Ø±ØªÙØ¹'}\r\n                                            </span>\r\n                                        )}\r\n                                        <div className=\"text-right\">\r\n                                            <p className=\"font-semibold text-white truncate max-w-[200px]\">{ticket.asset_name || 'Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø©'}</p>\r\n                                            <div className=\"flex items-center gap-3 mt-1 text-[10px] text-surface-500\">\r\n                                                <span className=\"flex items-center gap-1 text-brand-blaban font-bold\">\r\n                                                    ğŸ¢ {ticket.branches?.name || 'ÙØ±Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\r\n                                                </span>\r\n                                                <span className=\"flex items-center gap-1\">\r\n                                                    <Clock className=\"w-3 h-3\" />\r\n                                                    {ticket.created_at ? format(new Date(ticket.created_at), 'PPP - hh:mm a', { locale: ar }) : 'â€”'}\r\n                                                </span>\r\n                                                {assignedTech && (\r\n                                                    <span className=\"text-brand-blaban font-medium\">ğŸ‘¤ {assignedTech.full_name}</span>\r\n                                                )}\r\n                                                {ticket.rating_score && (\r\n                                                    <span className=\"text-amber-500\">â­ {ticket.rating_score}/5</span>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    {isExpanded ? <ChevronUp className=\"w-5 h-5 text-surface-400\" /> : <ChevronDown className=\"w-5 h-5 text-surface-400\" />}\r\n                                </button>\r\n\r\n                                {/* Expanded Details */}\r\n                                {isExpanded && (\r\n                                    <div className=\"border-t border-surface-800 p-5 space-y-4\">\r\n                                        {/* Assignment Section */}\r\n                                        {(ticket.status === 'open' || ticket.status === 'assigned') && (\r\n                                            <div className=\"bg-brand-blaban/5 rounded-xl p-4 border border-brand-blaban/20 space-y-3\">\r\n                                                <h4 className=\"font-bold text-brand-blaban flex items-center gap-2\">\r\n                                                    <Users className=\"w-5 h-5\" /> Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙÙ†ÙŠØ© Ù„Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ù…Ø®ØªØµØ©\r\n                                                </h4>\r\n                                                <div className=\"flex gap-3\">\r\n                                                    <select\r\n                                                        value={selectedTech}\r\n                                                        onChange={(e) => setSelectedTech(e.target.value)}\r\n                                                        className=\"flex-1 bg-surface-800 border border-surface-700 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-blaban/30 text-white\"\r\n                                                    >\r\n                                                        <option value=\"\">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø®ØªØµ...</option>\r\n                                                        {technicians.map(t => (\r\n                                                            <option key={t.id} value={t.id}>\r\n                                                                {t.full_name} ({t.employee_code})\r\n                                                            </option>\r\n                                                        ))}\r\n                                                    </select>\r\n                                                    <button\r\n                                                        onClick={() => handleAssign(ticket.id)}\r\n                                                        disabled={!selectedTech || assigning === ticket.id}\r\n                                                        className=\"px-5 py-2 bg-brand-blaban hover:bg-opacity-90 text-white rounded-xl font-semibold text-sm disabled:opacity-50 transition-all shadow-md shadow-brand-blaban/20\"\r\n                                                    >\r\n                                                        {assigning === ticket.id ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯'}\r\n                                                    </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* Priority Change (maint_manager and admin) */}\r\n                                        {(profile?.role === 'maint_manager' || profile?.role === 'admin') && ticket.status !== 'closed' && (\r\n                                            <div className=\"bg-amber-900/10 rounded-xl p-4 border border-amber-900/20 space-y-3\">\r\n                                                <h4 className=\"font-bold text-amber-400 flex items-center gap-2\">\r\n                                                    <AlertTriangle className=\"w-5 h-5\" /> ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©\r\n                                                </h4>\r\n                                                <div className=\"flex flex-wrap gap-2\">\r\n                                                    {PRIORITY_OPTIONS.map(opt => (\r\n                                                        <button\r\n                                                            key={opt.value}\r\n                                                            onClick={() => handlePriorityChange(ticket.id, opt.value)}\r\n                                                            disabled={updatingPriority === ticket.id}\r\n                                                            className={`px-4 py-1.5 rounded-lg text-sm font-medium border transition-all ${opt.color} ${ticket.priority === opt.value ? 'ring-2 ring-offset-1 ring-offset-surface-900 ring-brand-blaban' : 'hover:shadow-sm'\r\n                                                                }`}\r\n                                                        >\r\n                                                            {opt.label}\r\n                                                        </button>\r\n                                                    ))}\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* Rating Display for closed tickets */}\r\n                                        {ticket.status === 'closed' && ticket.rating_score && (\r\n                                            <div className=\"bg-green-900/10 rounded-xl p-4 border border-green-900/20\">\r\n                                                <h4 className=\"font-bold text-green-400 flex items-center gap-2 mb-2\">\r\n                                                    <Star className=\"w-5 h-5\" /> Ù…Ø¤Ø´Ø± Ø±Ø¶Ø§ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø© (Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹)\r\n                                                </h4>\r\n                                                <div className=\"flex items-center gap-2 text-xl mb-1\" dir=\"ltr\">\r\n                                                    {[1, 2, 3, 4, 5].map(v => (\r\n                                                        <Star key={v} className={`w-6 h-6 ${ticket.rating_score >= v ? 'text-amber-400 fill-amber-400' : 'text-surface-700'}`} />\r\n                                                    ))}\r\n                                                    <span className=\"text-sm text-green-400 font-bold mr-2\">{ticket.rating_score}/5</span>\r\n                                                </div>\r\n                                                {ticket.rating_comment && (\r\n                                                    <p className=\"text-sm text-green-200 mt-2 bg-green-900/20 rounded-lg p-3 border border-green-900/30 italic\">\"{ticket.rating_comment}\"</p>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* Standard TicketFlow for technician actions */}\r\n                                        <TicketFlow ticket={ticket} onUpdate={fetchAll} />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            )}\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\maintenance\\pages\\ManagerTicketsPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchBranchResources' and 'fetchTickets'. Either include them or remove the dependency array.","line":64,"column":8,"nodeType":"ArrayExpression","endLine":64,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchBranchResources, fetchTickets, profile]","fix":{"range":[3486,3495],"text":"[fetchBranchResources, fetchTickets, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport TicketFlow from '@/modules/maintenance/components/TicketFlow';\r\nimport { MapPin, Clock, CheckCircle, AlertCircle, Loader2, ChevronDown, ChevronUp, Plus, Camera, X, Ticket, FileText, ShieldCheck, Zap, Wrench } from 'lucide-react';\r\nimport clsx from 'clsx';\r\nimport { format } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport { getGeoLocation } from '@/lib/geo';\r\nimport { compressImage } from '@/lib/image';\r\nimport { uploadToDrive } from '@/lib/drive';\r\n\r\nconst STATUS_LABELS: Record<string, { label: string; color: string }> = {\r\n    open: { label: 'Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ)', color: 'bg-blue-900/30 text-blue-400 border border-blue-900/50' },\r\n    assigned: { label: 'ØªÙƒÙ„ÙŠÙ ØªØ´ØºÙŠÙ„ÙŠ (Ù…Ø³Ù†Ø¯ Ù„Ù„ÙØ±ÙŠÙ‚)', color: 'bg-amber-900/30 text-amber-400 border border-amber-900/50' },\r\n    in_progress: { label: 'Ù…Ø¨Ø§Ø´Ø±Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°)', color: 'bg-purple-900/30 text-purple-400 border border-purple-900/50' },\r\n    resolved: { label: 'ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯)', color: 'bg-teal-900/30 text-teal-400 border border-teal-900/50 font-bold' },\r\n    closed: { label: 'Ù…ÙƒØªÙ…Ù„ (ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ Ø¨Ù†Ø¬Ø§Ø­) âœ“', color: 'bg-surface-800 text-surface-500 border border-surface-700' },\r\n};\r\n\r\nexport default function ManagerTicketsPage() {\r\n    const { profile } = useAuth();\r\n    const [tickets, setTickets] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [expandedId, setExpandedId] = useState<string | null>(null);\r\n    const [filter, setFilter] = useState<'all' | 'pending' | 'closed'>('all');\r\n    const [showForm, setShowForm] = useState(false);\r\n\r\n    // New ticket form\r\n    const [assets, setAssets] = useState<any[]>([]);\r\n    const [categories, setCategories] = useState<any[]>([]);\r\n    const [selectedAssetId, setSelectedAssetId] = useState('');\r\n    const [selectedCategoryId, setSelectedCategoryId] = useState('');\r\n    const [isEmergency, setIsEmergency] = useState(false);\r\n    const [newAssetName, setNewAssetName] = useState('');\r\n    const [newDesc, setNewDesc] = useState('');\r\n    const [submitting, setSubmitting] = useState(false);\r\n    const [uploading, setUploading] = useState(false);\r\n    const [reportedImageUrl, setReportedImageUrl] = useState<string | null>(null);\r\n    const [formError, setFormError] = useState<string | null>(null);\r\n\r\n    // Reporter Details (Manual)\r\n    const [reporterName, setReporterName] = useState('');\r\n    const [reporterJob, setReporterJob] = useState('');\r\n    const [reporterPhone, setReporterPhone] = useState('');\r\n    // [STABILITY FIX] Safely generate local ISO string without timezone drift\r\n    const getLocalISOString = () => {\r\n        const now = new Date();\r\n        const year = now.getFullYear();\r\n        const month = String(now.getMonth() + 1).padStart(2, '0');\r\n        const day = String(now.getDate()).padStart(2, '0');\r\n        const hours = String(now.getHours()).padStart(2, '0');\r\n        const minutes = String(now.getMinutes()).padStart(2, '0');\r\n        return `${year}-${month}-${day}T${hours}:${minutes}`;\r\n    };\r\n    const [breakdownTime, setBreakdownTime] = useState(getLocalISOString());\r\n\r\n    useEffect(() => {\r\n        fetchTickets();\r\n        if (profile?.branch_id) {\r\n            fetchBranchResources();\r\n        }\r\n    }, [profile]);\r\n\r\n    const fetchBranchResources = async () => {\r\n        // Fetch assets for this branch\r\n        const { data: assetData } = await supabase\r\n            .from('maintenance_assets')\r\n            .select('*')\r\n            .eq('branch_id', profile?.branch_id)\r\n            .order('name');\r\n        setAssets(assetData || []);\r\n\r\n        // Fetch categories\r\n        const { data: catData } = await supabase\r\n            .from('maintenance_categories')\r\n            .select('*')\r\n            .order('name');\r\n        setCategories(catData || []);\r\n    };\r\n\r\n    const fetchTickets = async () => {\r\n        if (!profile) return;\r\n        setLoading(true);\r\n        const { data } = await supabase\r\n            .from('tickets')\r\n            .select('*')\r\n            .eq('manager_id', profile.id)\r\n            .order('created_at', { ascending: false });\r\n        if (data) setTickets(data);\r\n        setLoading(false);\r\n    };\r\n\r\n    const handleImageUpload = async (file: File) => {\r\n        setUploading(true);\r\n        setFormError(null);\r\n        try {\r\n            const compressed = await compressImage(file);\r\n            const url = await uploadToDrive(compressed as File);\r\n            setReportedImageUrl(url);\r\n        } catch (e: any) {\r\n            setFormError('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„: ' + e.message);\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    const handleNewTicket = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n\r\n        // Validation\r\n        const finalAssetName = selectedAssetId ? assets.find(a => a.id === selectedAssetId)?.name : newAssetName;\r\n        if (!profile || !finalAssetName?.trim()) {\r\n            setFormError('ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø£Ùˆ ØªØ¯ÙˆÙŠÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.');\r\n            return;\r\n        }\r\n\r\n        // branch_id is required â€” must be set on the manager's profile\r\n        if (!profile.branch_id) {\r\n            setFormError('Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©Ø› Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ (Ø§Ù„ÙØ±Ø¹) Ø¨Ù…Ø¤Ø´Ø± ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ.');\r\n            return;\r\n        }\r\n\r\n        setSubmitting(true);\r\n        setFormError(null);\r\n        try {\r\n            // Attempt GPS (optional â€” don't block on failure)\r\n            let coords: { lat: number; lng: number } | null = null;\r\n            try { coords = await getGeoLocation(); } catch { /* GPS optional */ }\r\n\r\n            const { error } = await supabase.from('tickets').insert([{\r\n                asset_id: selectedAssetId || null,\r\n                asset_name: finalAssetName.trim(),\r\n                category_id: selectedCategoryId || null,\r\n                is_emergency: isEmergency,\r\n                description: newDesc.trim(),\r\n                status: 'open',\r\n                manager_id: profile.id,\r\n                branch_id: profile.branch_id,\r\n                reported_at: new Date().toISOString(),\r\n                reported_image_url: reportedImageUrl,\r\n                downtime_start: new Date(breakdownTime).toISOString(),\r\n                reporter_name: reporterName.trim(),\r\n                reporter_job: reporterJob.trim(),\r\n                reporter_phone: reporterPhone.trim(),\r\n                breakdown_time: new Date(breakdownTime).toISOString(),\r\n                ...(coords ? { reported_lat: coords.lat, reported_lng: coords.lng } : {}),\r\n            }]);\r\n            if (error) throw error;\r\n\r\n            // Reset form\r\n            setNewAssetName('');\r\n            setSelectedAssetId('');\r\n            setSelectedCategoryId('');\r\n            setIsEmergency(false);\r\n            setNewDesc('');\r\n            setReporterName('');\r\n            setReporterJob('');\r\n            setReporterPhone('');\r\n            setBreakdownTime(getLocalISOString());\r\n            setReportedImageUrl(null);\r\n            setShowForm(false);\r\n            fetchTickets();\r\n        } catch (e: any) {\r\n            setFormError(e.message);\r\n        } finally {\r\n            setSubmitting(false);\r\n        }\r\n    };\r\n\r\n    const filtered = tickets.filter(t => {\r\n        if (filter === 'pending') return t.status === 'resolved';\r\n        if (filter === 'closed') return t.status === 'closed';\r\n        return true;\r\n    });\r\n\r\n\r\n    const stats = {\r\n        total: tickets.length,\r\n        pending: tickets.filter(t => t.status === 'open' || t.status === 'assigned' || t.status === 'in_progress').length,\r\n        resolved: tickets.filter(t => t.status === 'resolved').length,\r\n        emergency: tickets.filter(t => t.is_emergency && t.status !== 'closed').length\r\n    };\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"flex flex-col gap-6\">\r\n                {/* Header */}\r\n                <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-black text-white flex items-center gap-3\">\r\n                            <div className=\"p-3 rounded-2xl bg-surface-900 border border-surface-800 shadow-2xl\">\r\n                                <Ticket className=\"w-8 h-8 text-brand-blaban\" />\r\n                            </div>\r\n                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø¨Ø§Ù„ÙØ±Ø¹\r\n                        </h2>\r\n                        <p className=\"text-surface-400 font-medium mt-1\">Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„ÙÙ†ÙŠØ©ØŒ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => setShowForm(v => !v)}\r\n                        className=\"flex items-center gap-2 px-6 py-3.5 bg-brand-blaban hover:bg-opacity-90 text-white font-bold rounded-2xl shadow-xl shadow-brand-blaban/20 transition-all active:scale-95\"\r\n                    >\r\n                        {showForm ? <X className=\"w-5 h-5\" /> : <Plus className=\"w-5 h-5\" />}\r\n                        {showForm ? 'Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ù„Ø§Øº' : 'ÙØªØ­ Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯'}\r\n                    </button>\r\n                </div>\r\n\r\n                {/* KPI Bar */}\r\n                <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-surface-800 flex items-center gap-4 group\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-surface-800 flex items-center justify-center text-surface-400 group-hover:text-brand-blaban transition-colors shadow-inner\">\r\n                            <FileText className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.total}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-surface-800 flex items-center gap-4 group\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-amber-500/10 flex items-center justify-center text-amber-500 shadow-inner\">\r\n                            <Clock className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.pending}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-surface-800 flex items-center gap-4 group\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-500 shadow-inner\">\r\n                            <CheckCircle className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</p>\r\n                            <p className=\"text-2xl font-black text-white tracking-tight\">{stats.resolved}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-red-500/10 flex items-center gap-4 group animate-pulse-premium\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-red-500/20 flex items-center justify-center text-red-500 shadow-inner\">\r\n                            <AlertCircle className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-red-500/70 uppercase tracking-widest\">Ø¨Ù„Ø§ØºØ§Øª Ø­Ø±Ø¬Ø©</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.emergency}</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* New Ticket Form (Modern Glass) */}\r\n                {showForm && (\r\n                    <div className=\"glass-premium rounded-[2.5rem] border border-brand-blaban/20 p-8 shadow-2xl animate-in fade-in slide-in-from-top-6 duration-500\">\r\n                        <form onSubmit={handleNewTicket} className=\"space-y-6\">\r\n                            <div className=\"flex items-center justify-between mb-4\">\r\n                                <h3 className=\"text-xl font-black text-white flex items-center gap-3\">\r\n                                    <div className=\"w-10 h-10 rounded-xl bg-brand-blaban/10 flex items-center justify-center text-brand-blaban\">\r\n                                        <Plus className=\"w-6 h-6\" />\r\n                                    </div>\r\n                                    ØªÙˆØµÙŠÙ Ù…Ø£Ù…ÙˆØ±ÙŠØ© ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©\r\n                                </h3>\r\n                                <div className=\"px-4 py-2 bg-surface-950 rounded-xl border border-surface-800 flex items-center gap-2\">\r\n                                    <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\r\n                                    <span className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">GPS Tracking Active</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {formError && (\r\n                                <div className=\"flex items-center gap-3 p-4 bg-red-900/20 text-red-400 rounded-2xl text-sm border border-red-900/30 animate-in shake duration-300\">\r\n                                    <AlertCircle className=\"w-5 h-5 shrink-0\" />\r\n                                    <span className=\"font-bold\">{formError}</span>\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1\">Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙˆÙ„</label>\r\n                                    <select\r\n                                        value={selectedAssetId}\r\n                                        onChange={e => setSelectedAssetId(e.target.value)}\r\n                                        className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white focus:border-brand-blaban outline-none transition-all appearance-none cursor-pointer\"\r\n                                    >\r\n                                        <option value=\"\">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ --</option>\r\n                                        {assets.map(a => (\r\n                                            <option key={a.id} value={a.id}>{a.name} ({a.model_number || 'S/N: Not Specified'})</option>\r\n                                        ))}\r\n                                        <option value=\"manual\">-- ØªØ¯ÙˆÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© --</option>\r\n                                    </select>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1\">ØªØµÙ†ÙŠÙ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ÙÙ†ÙŠ</label>\r\n                                    <select\r\n                                        required\r\n                                        value={selectedCategoryId}\r\n                                        onChange={e => setSelectedCategoryId(e.target.value)}\r\n                                        className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white focus:border-brand-blaban outline-none transition-all appearance-none cursor-pointer\"\r\n                                    >\r\n                                        <option value=\"\">-- Ø­Ø¯Ø¯ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙÙ†ÙŠ --</option>\r\n                                        {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {(selectedAssetId === 'manual' || (selectedAssetId === '' && assets.length === 0)) && (\r\n                                <div className=\"animate-in fade-in slide-in-from-top-2\">\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1 mb-2\">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø¯Ø© / Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø§Ù„ÙŠ</label>\r\n                                    <input\r\n                                        required\r\n                                        value={newAssetName}\r\n                                        onChange={e => setNewAssetName(e.target.value)}\r\n                                        placeholder=\"Ù…Ø«Ø§Ù„: ØªØ¹Ø·Ù„ Ø¶Ø§ØºØ· Ø§Ù„ØªØ¨Ø±ÙŠØ¯ Ø±Ù‚Ù… 4\"\r\n                                        className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white focus:border-brand-blaban outline-none transition-all\"\r\n                                    />\r\n                                </div>\r\n                            )}\r\n\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                                <div>\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1 mb-2\">Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>\r\n                                    <input required value={reporterName} onChange={e => setReporterName(e.target.value)} placeholder=\"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„\" className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white\" />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1 mb-2\">Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</label>\r\n                                    <input required value={reporterJob} onChange={e => setReporterJob(e.target.value)} placeholder=\"Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\" className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white\" />\r\n                                </div>\r\n                                <div>\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1 mb-2\">Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</label>\r\n                                    <input required value={reporterPhone} onChange={e => setReporterPhone(e.target.value)} placeholder=\"01XXXXXXXXX\" className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white font-outfit\" />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 items-end\">\r\n                                <div className=\"space-y-4\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1\">ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„ÙØ¹Ù„ÙŠ</label>\r\n                                        <input\r\n                                            type=\"datetime-local\"\r\n                                            required\r\n                                            value={breakdownTime}\r\n                                            onChange={e => setBreakdownTime(e.target.value)}\r\n                                            className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white font-outfit\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-4 p-4 bg-red-950/20 border border-red-900/30 rounded-2xl\">\r\n                                        <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                                            <input type=\"checkbox\" checked={isEmergency} onChange={e => setIsEmergency(e.target.checked)} className=\"sr-only peer\" />\r\n                                            <div className=\"w-12 h-6 bg-surface-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600 shadow-inner\"></div>\r\n                                        </label>\r\n                                        <div>\r\n                                            <p className=\"text-sm font-black text-red-500\">Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ (Ø­Ø±Ø¬ Ù„Ù„ØºØ§ÙŠØ©)</p>\r\n                                            <p className=\"text-[10px] text-red-500/70 font-bold uppercase tracking-wider\">High-Priority Operational Outage</p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-4\">\r\n                                    <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1\">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>\r\n                                    {reportedImageUrl ? (\r\n                                        <div className=\"relative group rounded-2xl overflow-hidden border border-surface-800 bg-surface-950 aspect-[2/1]\">\r\n                                            <img src={reportedImageUrl} className=\"w-full h-full object-cover grayscale-[0.2] group-hover:grayscale-0 transition-all duration-500\" />\r\n                                            <button type=\"button\" onClick={() => setReportedImageUrl(null)} className=\"absolute top-4 right-4 p-2 bg-red-600 text-white rounded-xl shadow-xl hover:scale-110 transition-transform\"><X className=\"w-4 h-4\" /></button>\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"relative group aspect-[2/1]\">\r\n                                            <input\r\n                                                type=\"file\"\r\n                                                accept=\"image/*\"\r\n                                                capture=\"environment\"\r\n                                                onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0])}\r\n                                                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10\"\r\n                                                disabled={uploading}\r\n                                            />\r\n                                            <div className=\"h-full flex flex-col items-center justify-center border-2 border-dashed border-surface-800 hover:border-brand-blaban/50 rounded-2xl bg-surface-950/50 hover:bg-surface-900 transition-all group\">\r\n                                                {uploading ? <Loader2 className=\"w-10 h-10 text-brand-blaban animate-spin\" /> : <Camera className=\"w-10 h-10 text-surface-700 group-hover:text-brand-blaban transition-colors\" />}\r\n                                                <p className=\"text-xs font-black text-surface-500 mt-3 uppercase tracking-widest\">Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</p>\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-xs font-black text-surface-500 uppercase tracking-widest block px-1\">Ø§Ù„ØªÙˆØµÙŠÙ Ø§Ù„ÙÙ†ÙŠ Ù„Ù„Ø¹Ø¬Ø²/Ø§Ù„Ø¹Ø·Ù„</label>\r\n                                <textarea\r\n                                    value={newDesc}\r\n                                    onChange={e => setNewDesc(e.target.value)}\r\n                                    rows={3}\r\n                                    placeholder=\"ÙŠØ±Ø¬Ù‰ ÙˆØµÙ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø¨Ø¯Ù‚Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ÙÙ†ÙŠØ©...\"\r\n                                    className=\"w-full bg-surface-950 border border-surface-800 rounded-2xl px-5 py-4 text-white focus:border-brand-blaban outline-none transition-all\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"flex items-center justify-end gap-4 pt-4 border-t border-surface-800\">\r\n                                <button type=\"button\" onClick={() => setShowForm(false)} className=\"px-8 py-4 text-surface-500 font-black uppercase tracking-widest hover:text-white transition-colors\">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø±</button>\r\n                                <button\r\n                                    type=\"submit\"\r\n                                    disabled={submitting}\r\n                                    className=\"px-10 py-4 bg-brand-blaban text-white font-black uppercase tracking-widest rounded-2xl shadow-2xl shadow-brand-blaban/30 flex items-center gap-3 disabled:opacity-50 hover:scale-[1.02] active:scale-95 transition-all\"\r\n                                >\r\n                                    {submitting ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <ShieldCheck className=\"w-5 h-5\" />}\r\n                                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±ØµØ¯\r\n                                </button>\r\n                            </div>\r\n                        </form>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Filter and Content */}\r\n                <div className=\"space-y-6\">\r\n                    <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                        <div className=\"flex gap-2 p-1.5 bg-surface-900 rounded-2xl border border-surface-800 w-fit\">\r\n                            {[\r\n                                { id: 'all', label: 'ÙƒØ§ÙØ© Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ§Øª' },\r\n                                { id: 'pending', label: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯' },\r\n                                { id: 'closed', label: 'Ø§Ù„Ù…Ø¤Ø±Ø´Ù ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠ' },\r\n                            ].map(f => (\r\n                                <button\r\n                                    key={f.id}\r\n                                    onClick={() => setFilter(f.id as any)}\r\n                                    className={clsx(\r\n                                        \"px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-widest transition-all\",\r\n                                        filter === f.id ? \"bg-surface-800 text-brand-blaban shadow-inner\" : \"text-surface-500 hover:text-surface-300\"\r\n                                    )}\r\n                                >\r\n                                    {f.label}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {loading ? (\r\n                        <div className=\"flex flex-col items-center justify-center py-32 opacity-20\">\r\n                            <Loader2 className=\"w-16 h-16 animate-spin text-brand-blaban mb-4\" />\r\n                            <p className=\"text-xs font-black uppercase tracking-[0.3em]\">Synchronizing Operations...</p>\r\n                        </div>\r\n                    ) : filtered.length === 0 ? (\r\n                        <div className=\"glass-premium rounded-[3rem] border border-surface-800 p-24 text-center\">\r\n                            <div className=\"w-20 h-20 bg-surface-800/50 rounded-full flex items-center justify-center mx-auto mb-6 text-surface-700\">\r\n                                <FileText className=\"w-10 h-10\" />\r\n                            </div>\r\n                            <h3 className=\"text-xl font-black text-white mb-2\">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹</h3>\r\n                            <p className=\"text-surface-500 font-bold max-w-sm mx-auto\">Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø¨Ù„Ø§ØºØ§Øª Ù„Ù„ØµÙŠØ§Ù†Ø© Ø£Ùˆ Ù…Ù‡Ø§Ù… Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ ÙÙŠ Ù†Ø·Ø§Ù‚ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-1 gap-4\">\r\n                            {filtered.map(ticket => {\r\n                                const st = STATUS_LABELS[ticket.status] || { label: ticket.status, color: 'bg-surface-800 text-surface-500' };\r\n                                const isExpanded = expandedId === ticket.id;\r\n                                return (\r\n                                    <div\r\n                                        key={ticket.id}\r\n                                        className={clsx(\r\n                                            \"glass-premium rounded-3xl border transition-all duration-300 overflow-hidden\",\r\n                                            isExpanded ? \"border-brand-blaban/30 shadow-2xl bg-surface-900/60\" : \"border-surface-800 hover:border-surface-700 shadow-sm\"\r\n                                        )}\r\n                                    >\r\n                                        <button\r\n                                            onClick={() => setExpandedId(isExpanded ? null : ticket.id)}\r\n                                            className=\"w-full flex items-center gap-6 p-6 text-right group\"\r\n                                        >\r\n                                            <div className={clsx(\r\n                                                \"w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 transition-transform group-hover:scale-110\",\r\n                                                ticket.is_emergency ? \"bg-red-500/10 text-red-500\" : \"bg-surface-800 text-surface-400\"\r\n                                            )}>\r\n                                                {ticket.is_emergency ? <Zap className=\"w-6 h-6 animate-pulse\" /> : <Wrench className=\"w-6 h-6\" />}\r\n                                            </div>\r\n\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"flex items-center gap-3 mb-1\">\r\n                                                    <span className={clsx(\"px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider border\", st.color)}>\r\n                                                        {st.label}\r\n                                                    </span>\r\n                                                    {ticket.is_emergency && <span className=\"bg-red-500/20 text-red-500 text-[9px] font-black px-2 py-1 rounded-lg border border-red-500/20\">EMERGENCY</span>}\r\n                                                </div>\r\n                                                <h4 className=\"text-lg font-black text-white truncate\">{ticket.asset_name || 'Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© Ø¹Ø§Ù…'}</h4>\r\n                                                <div className=\"flex items-center gap-4 mt-1.5\">\r\n                                                    <div className=\"flex items-center gap-1.5 text-xs text-surface-500 font-bold\">\r\n                                                        <Clock className=\"w-3.5 h-3.5\" />\r\n                                                        {format(new Date(ticket.reported_at), 'PPP Â· p', { locale: ar })}\r\n                                                    </div>\r\n                                                    {ticket.reported_lat && (\r\n                                                        <div className=\"flex items-center gap-1.5 text-xs text-emerald-500/70 font-black uppercase\">\r\n                                                            <MapPin className=\"w-3.5 h-3.5\" /> GPS Verified\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            <div className=\"flex flex-col items-end gap-2\">\r\n                                                <div className=\"flex -space-x-3 rtl:space-x-reverse opacity-40\">\r\n                                                    <div className=\"w-8 h-8 rounded-full border-2 border-surface-900 bg-surface-800\" />\r\n                                                    <div className=\"w-8 h-8 rounded-full border-2 border-surface-900 bg-brand-blaban/20\" />\r\n                                                </div>\r\n                                                <div className={clsx(\"p-2 rounded-xl border border-surface-800 transition-colors\", isExpanded ? \"bg-brand-blaban text-white\" : \"bg-surface-800 text-surface-500\")}>\r\n                                                    {isExpanded ? <ChevronUp className=\"w-4 h-4\" /> : <ChevronDown className=\"w-4 h-4\" />}\r\n                                                </div>\r\n                                            </div>\r\n                                        </button>\r\n\r\n                                        {isExpanded && (\r\n                                            <div className=\"border-t border-surface-800 p-8 animate-in fade-in zoom-in-95 duration-300\">\r\n                                                <TicketFlow ticket={ticket} onUpdate={fetchTickets} />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\maintenance\\pages\\TechnicianTicketsPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTickets'. Either include it or remove the dependency array.","line":26,"column":42,"nodeType":"ArrayExpression","endLine":26,"endColumn":51,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTickets, profile]","fix":{"range":[1521,1530],"text":"[fetchTickets, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport TicketFlow from '@/modules/maintenance/components/TicketFlow';\r\nimport { Clock, ChevronDown, ChevronUp, Wrench, Zap, CheckCircle, MapPin, ClipboardCheck, ArrowUpRight } from 'lucide-react';\r\nimport { format } from 'date-fns';\r\nimport { ar } from 'date-fns/locale';\r\nimport ShiftStatus from '@/components/layout/ShiftStatus';\r\nimport Skeleton from '@/components/ui/Skeleton';\r\nimport clsx from 'clsx';\r\n\r\nconst STATUS_LABELS: Record<string, { label: string; color: string }> = {\r\n    open: { label: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ', color: 'bg-blue-900/30 text-blue-400 border border-blue-900/50' },\r\n    assigned: { label: 'ØªÙƒÙ„ÙŠÙ ØªØ´ØºÙŠÙ„ÙŠ (Ø¥Ø¨Ø¯Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯)', color: 'bg-amber-900/30 text-amber-400 border border-amber-900/50' },\r\n    in_progress: { label: 'Ù…Ø¨Ø§Ø´Ø±Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø±Ø¹Ø§ÙŠØªÙƒÙ…)', color: 'bg-purple-900/30 text-purple-400 border border-purple-900/50' },\r\n    resolved: { label: 'ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)', color: 'bg-teal-900/30 text-teal-400 border border-teal-900/50' },\r\n};\r\n\r\nexport default function TechnicianTicketsPage() {\r\n    const { profile } = useAuth();\r\n    const [tickets, setTickets] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [expandedId, setExpandedId] = useState<string | null>(null);\r\n\r\n    useEffect(() => { fetchTickets(); }, [profile]);\r\n\r\n    const fetchTickets = async () => {\r\n        if (!profile) return;\r\n        setLoading(true);\r\n        const { data } = await supabase\r\n            .from('tickets')\r\n            .select('*, branches(name), maintenance_categories(name)')\r\n            .eq('assigned_to', profile.id)\r\n            .in('status', ['assigned', 'in_progress'])\r\n            .order('created_at', { ascending: false });\r\n        if (data) setTickets(data);\r\n        setLoading(false);\r\n    };\r\n\r\n    const stats = {\r\n        total: tickets.length,\r\n        inProgress: tickets.filter(t => t.status === 'in_progress').length,\r\n        emergency: tickets.filter(t => t.is_emergency).length,\r\n    };\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"flex flex-col gap-6\">\r\n                <ShiftStatus />\r\n\r\n                {/* Header Section */}\r\n                <div className=\"flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-surface-800/50 pb-6\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-black text-white flex items-center gap-3\">\r\n                            <div className=\"p-3 rounded-2xl bg-surface-900 border border-surface-800 shadow-xl\">\r\n                                <ClipboardCheck className=\"w-8 h-8 text-brand-blaban\" />\r\n                            </div>\r\n                            Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©\r\n                        </h2>\r\n                        <p className=\"text-surface-400 font-medium mt-1\">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒÙ…</p>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-4\">\r\n                        <div className=\"px-5 py-3 bg-surface-900 rounded-2xl border border-surface-800 flex items-center gap-3 shadow-sm\">\r\n                            <div className=\"flex -space-x-3 rtl:space-x-reverse\">\r\n                                <div className=\"w-8 h-8 rounded-full border-2 border-surface-900 bg-brand-blaban/20 flex items-center justify-center text-[10px] font-black text-brand-blaban\">#{stats.total}</div>\r\n                            </div>\r\n                            <span className=\"text-xs font-black text-surface-500 uppercase tracking-widest\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø©</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* KPI Cards for Technician */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-surface-800 flex items-center gap-4 group hover:border-brand-blaban/30 transition-all\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-surface-800 flex items-center justify-center text-surface-400 group-hover:text-brand-blaban transition-colors\">\r\n                            <Wrench className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø©</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.total}</p>\r\n                        </div>\r\n                        <ArrowUpRight className=\"w-5 h-5 text-surface-700 mr-auto opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                    </div>\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-surface-800 flex items-center gap-4 group hover:border-purple-500/30 transition-all\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:text-purple-300\">\r\n                            <Clock className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-surface-500 uppercase tracking-widest\">ØªØ­Øª Ø§Ù„ØªÙ†ÙÙŠØ°</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.inProgress}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"glass-premium p-6 rounded-3xl border border-red-500/10 flex items-center gap-4 group animate-pulse-premium\">\r\n                        <div className=\"w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500\">\r\n                            <Zap className=\"w-6 h-6\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] font-black text-red-500/70 uppercase tracking-widest\">Ø¨Ù„Ø§ØºØ§Øª Ø§Ø³ØªØ¹Ø¬Ø§Ù„</p>\r\n                            <p className=\"text-2xl font-black text-white\">{stats.emergency}</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Main Content */}\r\n                <div className=\"space-y-4\">\r\n                    {loading ? (\r\n                        <div className=\"space-y-4\">\r\n                            {[1, 2, 3].map(i => (\r\n                                <div key={i} className=\"glass-premium rounded-3xl border border-surface-800 p-6 flex items-center justify-between opacity-50\">\r\n                                    <div className=\"flex items-center gap-5\">\r\n                                        <Skeleton variant=\"circular\" width=\"3.5rem\" height=\"3.5rem\" className=\"rounded-2xl\" />\r\n                                        <div className=\"space-y-2\">\r\n                                            <Skeleton variant=\"text\" width=\"15rem\" height=\"1.5rem\" />\r\n                                            <Skeleton variant=\"text\" width=\"10rem\" height=\"1rem\" />\r\n                                        </div>\r\n                                    </div>\r\n                                    <Skeleton variant=\"circular\" width=\"2.5rem\" height=\"2.5rem\" className=\"rounded-xl\" />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    ) : tickets.length === 0 ? (\r\n                        <div className=\"glass-premium rounded-[3rem] border border-surface-800 p-24 text-center\">\r\n                            <div className=\"w-24 h-24 bg-surface-900 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-surface-800 shadow-2xl transition-transform hover:scale-110\">\r\n                                <CheckCircle className=\"w-12 h-12 text-emerald-500/50\" />\r\n                            </div>\r\n                            <h3 className=\"text-2xl font-black text-white mb-2 tracking-tight\">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙƒØªÙ…Ù„</h3>\r\n                            <p className=\"text-surface-500 font-bold max-w-sm mx-auto leading-relaxed\">\r\n                                Ù†Ø«Ù…Ù† Ù…Ø¬Ù‡ÙˆØ¯Ø§ØªÙƒÙ…Ø› Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ„ÙŠÙØ§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø³ÙŠØªÙ… Ø¥Ø®Ø·Ø§Ø±ÙƒÙ… ÙÙˆØ± ØªÙˆÙØ± Ù…Ø£Ù…ÙˆØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©.\r\n                            </p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-1 gap-4\">\r\n                            {tickets.map(ticket => {\r\n                                const st = STATUS_LABELS[ticket.status] || { label: ticket.status, color: 'bg-surface-800 text-surface-500' };\r\n                                const isExpanded = expandedId === ticket.id;\r\n                                return (\r\n                                    <div\r\n                                        key={ticket.id}\r\n                                        className={clsx(\r\n                                            \"glass-premium rounded-3xl border transition-all duration-300 overflow-hidden\",\r\n                                            isExpanded ? \"border-brand-blaban/30 shadow-2xl bg-surface-900/60\" : \"border-surface-800 hover:border-surface-700 shadow-sm\"\r\n                                        )}\r\n                                    >\r\n                                        <button\r\n                                            onClick={() => setExpandedId(isExpanded ? null : ticket.id)}\r\n                                            className=\"w-full flex flex-col md:flex-row md:items-center gap-6 p-6 text-right group\"\r\n                                        >\r\n                                            <div className={clsx(\r\n                                                \"w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 transition-transform group-hover:scale-105 shadow-inner\",\r\n                                                ticket.is_emergency ? \"bg-red-500/10 text-red-500\" : \"bg-surface-800 text-surface-400\"\r\n                                            )}>\r\n                                                {ticket.is_emergency ? <Zap className=\"w-7 h-7 animate-pulse\" /> : <Wrench className=\"w-7 h-7\" />}\r\n                                            </div>\r\n\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"flex flex-wrap items-center gap-3 mb-2\">\r\n                                                    <span className={clsx(\"px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest border\", st.color)}>\r\n                                                        {st.label}\r\n                                                    </span>\r\n                                                    {ticket.is_emergency && <span className=\"bg-red-500/20 text-red-500 text-[9px] font-black px-2 py-1 rounded-lg border border-red-500/20\">Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦</span>}\r\n                                                </div>\r\n                                                <h4 className=\"text-xl font-black text-white truncate mb-2\">{ticket.asset_name || 'ØªÙƒÙ„ÙŠÙ ØµÙŠØ§Ù†Ø© ÙÙ†ÙŠ'}</h4>\r\n\r\n                                                <div className=\"flex flex-wrap items-center gap-4\">\r\n                                                    <div className=\"flex items-center gap-2 px-3 py-1.5 bg-surface-950/50 rounded-xl border border-surface-800/50\">\r\n                                                        <MapPin className=\"w-3.5 h-3.5 text-brand-blaban\" />\r\n                                                        <span className=\"text-xs font-black text-surface-400 uppercase tracking-widest\">{ticket.branches?.name || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>\r\n                                                    </div>\r\n                                                    <div className=\"flex items-center gap-2 text-xs text-surface-500 font-bold\">\r\n                                                        <Clock className=\"w-3.5 h-3.5 text-surface-600\" />\r\n                                                        {format(new Date(ticket.created_at), 'PPP Â· p', { locale: ar })}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            <div className=\"flex items-center justify-between md:flex-col md:items-end gap-3 border-t md:border-0 border-surface-800 pt-4 md:pt-0\">\r\n                                                <div className=\"text-[10px] font-black text-surface-600 uppercase tracking-[0.2em] md:mb-1\">Ops Profile #0{ticket.id.slice(0, 4)}</div>\r\n                                                <div className={clsx(\"p-2.5 rounded-2xl border border-surface-800 transition-all shadow-sm\", isExpanded ? \"bg-brand-blaban text-white scale-110\" : \"bg-surface-800 text-surface-500 group-hover:bg-surface-700\")}>\r\n                                                    {isExpanded ? <ChevronUp className=\"w-5 h-5\" /> : <ChevronDown className=\"w-5 h-5\" />}\r\n                                                </div>\r\n                                            </div>\r\n                                        </button>\r\n\r\n                                        {isExpanded && (\r\n                                            <div className=\"border-t border-surface-800 p-8 animate-in fade-in slide-in-from-bottom-4 duration-300\">\r\n                                                <TicketFlow ticket={ticket} onUpdate={fetchTickets} />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\map\\pages\\MapPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'mapRef'. Either include it or remove the dependency array.","line":41,"column":8,"nodeType":"ArrayExpression","endLine":41,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [mapRef]","fix":{"range":[1520,1522],"text":"[mapRef]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":211,"column":8,"nodeType":"ArrayExpression","endLine":211,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [load, profile]","fix":{"range":[9377,9386],"text":"[load, profile]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useRef } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { MapPin, Users, Shield, Map } from 'lucide-react';\r\nimport clsx from 'clsx';\r\nimport { applyRBACFilter } from '@/lib/rbac';\r\n\r\n// Use global Leaflet (L) loaded via index.html\r\nfunction useLeaflet(mapRef: React.RefObject<HTMLDivElement | null>, branches: any[], technicians: any[]) {\r\n    const mapInstanceRef = useRef<any>(null);\r\n    const markersLayerRef = useRef<any>(null);\r\n\r\n    // 1. Initial Map Setup (Run once)\r\n    useEffect(() => {\r\n        const L = (window as any).L;\r\n        if (!mapRef.current || !L || mapInstanceRef.current) return;\r\n\r\n        // Optimized for Middle East Focus\r\n        const map = L.map(mapRef.current, {\r\n            zoomControl: false,\r\n            attributionControl: false\r\n        }).setView([26.8206, 30.8025], 6);\r\n\r\n        mapInstanceRef.current = map;\r\n        (window as any).leafletMapInstance = map;\r\n\r\n        // Premium Dark Matter Tiles\r\n        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {\r\n            maxZoom: 20\r\n        }).addTo(map);\r\n\r\n        markersLayerRef.current = L.featureGroup().addTo(map);\r\n\r\n        return () => {\r\n            if (mapInstanceRef.current) {\r\n                mapInstanceRef.current.remove();\r\n                mapInstanceRef.current = null;\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    const markersMapRef = useRef<Record<string, any>>({});\r\n\r\n    // 2. Sync markers\r\n    useEffect(() => {\r\n        const L = (window as any).L;\r\n        const map = mapInstanceRef.current;\r\n        const layer = markersLayerRef.current;\r\n\r\n        if (!map || !layer || !L) return;\r\n\r\n        const currentIds = new Set();\r\n\r\n        // Premium Branch Icon with Pulse\r\n        const branchIcon = L.divIcon({\r\n            html: `\r\n                <div class=\"relative flex items-center justify-center\">\r\n                    <div class=\"absolute w-8 h-8 bg-sky-500/40 rounded-full animate-ring\"></div>\r\n                    <div class=\"relative w-8 h-8 bg-sky-500 text-white rounded-full flex items-center justify-center text-sm shadow-lg border-2 border-surface-900 group\">ğŸ¢</div>\r\n                </div>\r\n            `,\r\n            iconSize: [32, 32], iconAnchor: [16, 16], className: 'custom-div-icon'\r\n        });\r\n\r\n        // Premium Technician Icon with Emerald Pulse\r\n        const techIcon = L.divIcon({\r\n            html: `\r\n                <div class=\"relative flex items-center justify-center\">\r\n                    <div class=\"absolute w-8 h-8 bg-emerald-500/40 rounded-full animate-ring\"></div>\r\n                    <div class=\"relative w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center text-sm shadow-lg border-2 border-surface-900\">ğŸ‘¤</div>\r\n                </div>\r\n            `,\r\n            iconSize: [32, 32], iconAnchor: [16, 16], className: 'custom-div-icon'\r\n        });\r\n\r\n        // Handle Branches\r\n        branches.forEach(b => {\r\n            const id = `branch-${b.id}`;\r\n            currentIds.add(id);\r\n            const lat = b.latitude;\r\n            const lng = b.longitude;\r\n            if (lat && lng) {\r\n                let marker = markersMapRef.current[id];\r\n                if (marker) {\r\n                    marker.setLatLng([lat, lng]);\r\n                } else {\r\n                    marker = L.marker([lat, lng], { icon: branchIcon }).addTo(layer);\r\n                    marker.bindPopup(`\r\n                        <div class=\"p-3 bg-surface-950 text-white rounded-xl min-w-[200px]\">\r\n                            <h4 class=\"font-black text-sky-400 mb-1\">${b.name}</h4>\r\n                            <p class=\"text-[10px] text-surface-400 font-bold uppercase tracking-widest mb-3\">Ù…Ø±ÙƒØ² Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ±Ø¹</p>\r\n                            <div class=\"grid grid-cols-2 gap-2 mt-2\">\r\n                                <div class=\"bg-surface-900/50 p-2 rounded-lg border border-surface-800\">\r\n                                    <p class=\"text-[9px] text-surface-500 font-bold\">Ø§Ù„Ø­Ø§Ù„Ø©</p>\r\n                                    <p class=\"text-xs text-emerald-400 font-black\">Ù†Ø´Ø·</p>\r\n                                </div>\r\n                                <div class=\"bg-surface-900/50 p-2 rounded-lg border border-surface-800\">\r\n                                    <p class=\"text-[9px] text-surface-500 font-bold\">Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</p>\r\n                                    <p class=\"text-xs text-white font-black\">Ù…Ø±Ø§Ù‚Ø¨</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    `, { className: 'premium-popup' });\r\n                    markersMapRef.current[id] = marker;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Handle Technicians\r\n        technicians.forEach(t => {\r\n            const id = `tech-${t.id}`;\r\n            currentIds.add(id);\r\n            if (t.clock_in_lat && t.clock_in_lng) {\r\n                let marker = markersMapRef.current[id];\r\n                if (marker) {\r\n                    marker.setLatLng([t.clock_in_lat, t.clock_in_lng]);\r\n                } else {\r\n                    marker = L.marker([t.clock_in_lat, t.clock_in_lng], { icon: techIcon }).addTo(layer);\r\n                    marker.bindPopup(`\r\n                        <div class=\"p-3 bg-surface-950 text-white rounded-xl min-w-[180px]\">\r\n                            <h4 class=\"font-black text-emerald-400 mb-1\">${t.full_name}</h4>\r\n                            <p class=\"text-[10px] text-surface-400 font-bold uppercase tracking-widest mb-3\">ÙÙ†ÙŠ Ù…ÙŠØ¯Ø§Ù†ÙŠ Ù†Ø´Ø·</p>\r\n                            <div class=\"flex items-center gap-2 bg-emerald-900/20 p-2 rounded-lg border border-emerald-900/30\">\r\n                                <div class=\"w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse\"></div>\r\n                                <p class=\"text-[10px] text-emerald-400 font-black\">Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</p>\r\n                            </div>\r\n                        </div>\r\n                    `, { className: 'premium-popup' });\r\n                    markersMapRef.current[id] = marker;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Cleanup\r\n        Object.keys(markersMapRef.current).forEach(id => {\r\n            if (!currentIds.has(id)) {\r\n                layer.removeLayer(markersMapRef.current[id]);\r\n                delete markersMapRef.current[id];\r\n            }\r\n        });\r\n    }, [branches, technicians]);\r\n}\r\n\r\nexport default function MapPage() {\r\n    const { profile } = useAuth();\r\n    const mapRef = useRef<HTMLDivElement>(null);\r\n    const [branches, setBranches] = useState<any[]>([]);\r\n    const [technicians, setTechnicians] = useState<any[]>([]);\r\n    const [stream, setStream] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isFullscreen, setIsFullscreen] = useState(false);\r\n\r\n    const handleLocate = () => {\r\n        if (!navigator.geolocation) return;\r\n        navigator.geolocation.getCurrentPosition((pos) => {\r\n            const L = (window as any).L;\r\n            const map = (window as any).leafletMapInstance;\r\n            if (map && L) {\r\n                const latlng = [pos.coords.latitude, pos.coords.longitude];\r\n                map.flyTo(latlng, 15, { animate: true, duration: 2 });\r\n                L.circle(latlng, { radius: 100, color: '#0ea5e9', fillOpacity: 0.1, weight: 1 }).addTo(map);\r\n            }\r\n        });\r\n    };\r\n\r\n    const load = async () => {\r\n        if (!profile) return;\r\n        setLoading(true);\r\n        try {\r\n            // Branches\r\n            let bQuery = supabase.from('branches').select('id, name, latitude, longitude');\r\n            bQuery = applyRBACFilter(bQuery, 'branches', profile);\r\n\r\n            // Attendance\r\n            let aQuery = supabase.from('technician_attendance')\r\n                .select('*, profiles:profile_id!inner(full_name), clock_in_lat, clock_in_lng')\r\n                .is('clock_out', null);\r\n            aQuery = applyRBACFilter(aQuery, 'technician_attendance', profile);\r\n\r\n            // Operational Stream (Last 10 Events)\r\n            const { data: streamData } = await supabase\r\n                .from('technician_attendance')\r\n                .select('id, created_at, profile_id, profiles:profile_id(full_name), branches:branch_id(name)')\r\n                .order('created_at', { ascending: false })\r\n                .limit(10);\r\n\r\n            const [{ data: bData }, { data: aData }] = await Promise.all([bQuery, aQuery]);\r\n\r\n            setBranches(bData || []);\r\n            setTechnicians((aData || []).map((s: any) => ({\r\n                ...s,\r\n                full_name: s.profiles?.full_name,\r\n            })));\r\n            setStream(streamData || []);\r\n        } catch (e) {\r\n            console.error('Map loading error:', e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (profile) {\r\n            load();\r\n            const channel = supabase.channel('map-sync')\r\n                .on('postgres_changes', { event: '*', schema: 'public', table: 'technician_attendance' }, () => load())\r\n                .subscribe();\r\n            return () => { channel.unsubscribe(); };\r\n        }\r\n    }, [profile]);\r\n\r\n    useLeaflet(mapRef, branches, technicians);\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"flex flex-col h-full overflow-hidden\">\r\n                {/* Header Section */}\r\n                <div className=\"flex items-center justify-between mb-6 px-1\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-black text-white tracking-tight flex items-center gap-3\">\r\n                            <Map className=\"w-8 h-8 text-brand-blaban\" /> Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ\r\n                        </h2>\r\n                        <p className=\"text-surface-500 text-sm mt-1 font-bold\">Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1 min-h-0\">\r\n                    {/* Main Content (Map) */}\r\n                    <div className=\"lg:col-span-3 flex flex-col gap-6 h-full\">\r\n                        {/* KPI Bar */}\r\n                        <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-4\">\r\n                            <div className=\"glass-premium p-4 rounded-2xl border border-sky-900/20 flex items-center gap-4\">\r\n                                <div className=\"w-10 h-10 bg-sky-500/10 rounded-xl flex items-center justify-center text-sky-500 shrink-0\">ğŸ¢</div>\r\n                                <div>\r\n                                    <p className=\"text-[10px] text-surface-500 font-black uppercase tracking-widest\">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙˆØ¹</p>\r\n                                    <p className=\"text-xl font-black text-white\">{branches.length}</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"glass-premium p-4 rounded-2xl border border-emerald-900/20 flex items-center gap-4\">\r\n                                <div className=\"w-10 h-10 bg-emerald-500/10 rounded-xl flex items-center justify-center text-emerald-500 shrink-0\">ğŸ‘¤</div>\r\n                                <div>\r\n                                    <p className=\"text-[10px] text-surface-500 font-black uppercase tracking-widest\">ÙÙ†ÙŠÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</p>\r\n                                    <p className=\"text-xl font-black text-white\">{technicians.length}</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"hidden sm:flex glass-premium p-4 rounded-2xl border border-purple-900/20 items-center gap-4\">\r\n                                <div className=\"w-10 h-10 bg-purple-500/10 rounded-xl flex items-center justify-center text-purple-500 shrink-0\">ğŸ“¡</div>\r\n                                <div>\r\n                                    <p className=\"text-[10px] text-surface-500 font-black uppercase tracking-widest\">Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·</p>\r\n                                    <p className=\"text-sm font-black text-white\">Ù„Ø­Ø¸ÙŠ / Ù…ØªØµÙ„</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Map Container */}\r\n                        <div className={clsx(\r\n                            \"bg-surface-950 rounded-[2.5rem] border border-surface-800 shadow-2xl shadow-black/50 overflow-hidden relative flex-1 min-h-[400px]\",\r\n                            isFullscreen && \"fixed inset-0 z-[100] rounded-none !h-screen\"\r\n                        )}>\r\n                            <div ref={mapRef} className=\"w-full h-full grayscale-[0.2] brightness-[0.9] contrast-[1.1]\" />\r\n\r\n                            {/* Map Overlays */}\r\n                            <div className=\"absolute top-6 right-6 z-[1000] flex flex-col gap-3\">\r\n                                <button\r\n                                    onClick={() => setIsFullscreen(!isFullscreen)}\r\n                                    className=\"p-3 bg-surface-900/80 backdrop-blur-md border border-surface-700/50 rounded-2xl text-white hover:bg-brand-blaban transition-all shadow-xl group\"\r\n                                >\r\n                                    {isFullscreen ? <Users className=\"w-5 h-5\" /> : <Map className=\"w-5 h-5 group-hover:scale-110\" />}\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleLocate}\r\n                                    className=\"p-3 bg-surface-900/80 backdrop-blur-md border border-surface-700/50 rounded-2xl text-brand-blaban hover:bg-brand-blaban hover:text-white transition-all shadow-xl group\"\r\n                                >\r\n                                    <MapPin className=\"w-5 h-5 group-hover:scale-110\" />\r\n                                </button>\r\n                            </div>\r\n\r\n                            {loading && (\r\n                                <div className=\"absolute inset-0 z-[2000] bg-surface-950/60 backdrop-blur-sm flex items-center justify-center\">\r\n                                    <div className=\"flex flex-col items-center gap-4\">\r\n                                        <div className=\"w-16 h-1 bg-surface-800 rounded-full overflow-hidden\">\r\n                                            <div className=\"w-1/2 h-full bg-brand-blaban animate-progress origin-left\"></div>\r\n                                        </div>\r\n                                        <p className=\"text-xs font-black text-surface-400 uppercase tracking-widest animate-pulse\">Initializing Command Grid...</p>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Operational Stream Sidebar */}\r\n                    <div className=\"lg:col-span-1 flex flex-col bg-surface-900/30 rounded-[2.5rem] border border-surface-800 p-6 h-full min-h-0\">\r\n                        <div className=\"flex items-center justify-between mb-6\">\r\n                            <h3 className=\"font-black text-white text-lg tracking-tight\">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªÙŠ</h3>\r\n                            <span className=\"px-2 py-1 bg-brand-blaban/10 text-brand-blaban text-[10px] font-black rounded-lg\">Live</span>\r\n                        </div>\r\n\r\n                        <div className=\"flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-1\">\r\n                            {stream.length === 0 ? (\r\n                                <div className=\"h-full flex flex-col items-center justify-center text-center p-8 opacity-20\">\r\n                                    <Shield className=\"w-16 h-16 mb-4\" />\r\n                                    <p className=\"text-sm font-bold\">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø§Øª Ù…ÙŠØ¯Ø§Ù†ÙŠØ©...</p>\r\n                                </div>\r\n                            ) : (\r\n                                stream.map((item, idx) => (\r\n                                    <div key={item.id} className=\"p-4 bg-surface-950/50 border border-surface-800 rounded-2xl animate-stream-in\" style={{ animationDelay: `${idx * 0.1}s` }}>\r\n                                        <div className=\"flex items-start gap-3\">\r\n                                            <div className=\"w-8 h-8 bg-emerald-500/10 rounded-full flex items-center justify-center shrink-0\">\r\n                                                <Users className=\"w-4 h-4 text-emerald-500\" />\r\n                                            </div>\r\n                                            <div className=\"min-w-0\">\r\n                                                <p className=\"text-xs text-white font-black truncate\">{item.profiles?.full_name}</p>\r\n                                                <p className=\"text-[10px] text-surface-500 font-bold mt-0.5\">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± ÙÙŠ <span className=\"text-sky-400\">{item.branches?.name}</span></p>\r\n                                                <div className=\"flex items-center gap-2 mt-2\">\r\n                                                    <span className=\"text-[9px] text-surface-600 font-black\">{new Date(item.created_at).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</span>\r\n                                                    <div className=\"w-1 h-1 rounded-full bg-surface-700\" />\r\n                                                    <span className=\"text-[9px] text-emerald-500 font-black uppercase\">Ù†Ø§Ø¬Ø­</span>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ))\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"mt-6 pt-6 border-t border-surface-800 text-center\">\r\n                            <p className=\"text-[10px] text-surface-600 font-black uppercase tracking-[0.2em]\">Operational Pulse Active</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <style dangerouslySetInnerHTML={{\r\n                __html: `\r\n                .premium-popup .leaflet-popup-content-wrapper { background: transparent; padding: 0; border: none; box-shadow: none; }\r\n                .premium-popup .leaflet-popup-tip { background: #0a0a0a; border: 1px solid #1f2937; }\r\n                .leaflet-container { font-family: 'Cairo', sans-serif; }\r\n                @keyframes progress { \r\n                    0% { transform: translateX(-100%); }\r\n                    100% { transform: translateX(200%); }\r\n                }\r\n                .animate-progress { animation: progress 2s infinite ease-in-out; }\r\n            `}} />\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\reporting\\pages\\ReportsPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReports'. Either include it or remove the dependency array.","line":57,"column":8,"nodeType":"ArrayExpression","endLine":57,"endColumn":89,"suggestions":[{"desc":"Update the dependencies array to be: [dateRange, selectedBranch, selectedArea, selectedSector, selectedBrand, profile, fetchReports]","fix":{"range":[2062,2143],"text":"[dateRange, selectedBranch, selectedArea, selectedSector, selectedBrand, profile, fetchReports]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport {\r\n    BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,\r\n    PieChart, Pie, Cell, Legend, AreaChart, Area\r\n} from 'recharts';\r\nimport {\r\n    Calendar, Download, Filter, BarChart3, TrendingUp, PieChart as PieIcon,\r\n    FileText, CalendarDays, RefreshCw, Loader2\r\n} from 'lucide-react';\r\nimport { format, startOfMonth } from 'date-fns';\r\nimport * as XLSX from 'xlsx';\r\nimport clsx from 'clsx';\r\nimport Skeleton from '@/components/ui/Skeleton';\r\n\r\nconst COLORS = ['#004aad', '#f58220', '#662d91', '#4b2c20', '#ed1c24', '#0ea5e9', '#d9b382', '#bbf7d0'];\r\n\r\nexport default function ReportsPage() {\r\n    const { profile } = useAuth();\r\n    const [loading, setLoading] = useState(true);\r\n    const [exporting, setExporting] = useState(false);\r\n\r\n    // Filters\r\n    const [dateRange, setDateRange] = useState({\r\n        start: format(startOfMonth(new Date()), 'yyyy-MM-dd'),\r\n        end: format(new Date(), 'yyyy-MM-dd')\r\n    });\r\n    const [selectedBranch, setSelectedBranch] = useState('all');\r\n    const [selectedBrand, setSelectedBrand] = useState('all');\r\n    const [selectedSector, setSelectedSector] = useState('all');\r\n    const [selectedArea, setSelectedArea] = useState('all');\r\n\r\n    const [branches, setBranches] = useState<any[]>([]);\r\n    const [brands, setBrands] = useState<any[]>([]);\r\n    const [sectors, setSectors] = useState<any[]>([]);\r\n    const [areas, setAreas] = useState<any[]>([]);\r\n\r\n    // Data\r\n    const [reportData, setReportData] = useState<any>({\r\n        totalTickets: 0,\r\n        resolvedTickets: 0,\r\n        avgMttr: 0,\r\n        totalCost: 0,\r\n        dailyTrends: [],\r\n        categoryDistribution: [],\r\n        branchPerformance: []\r\n    });\r\n\r\n    useEffect(() => {\r\n        fetchInitialData();\r\n    }, [profile]);\r\n\r\n    useEffect(() => {\r\n        if (profile) fetchReports();\r\n    }, [dateRange, selectedBranch, selectedArea, selectedSector, selectedBrand, profile]);\r\n\r\n    const fetchInitialData = async () => {\r\n        const { data: bData } = await supabase.from('brands').select('id, name').order('name');\r\n        setBrands(bData || []);\r\n\r\n        const { data: sData } = await supabase.from('sectors').select('id, name, brand_id').order('name');\r\n        setSectors(sData || []);\r\n\r\n        const { data: aData } = await supabase.from('areas').select('id, name, sector_id').order('name');\r\n        setAreas(aData || []);\r\n\r\n        const { data: branchData } = await supabase.from('branches').select('id, name, area_id').order('name');\r\n        setBranches(branchData || []);\r\n    };\r\n\r\n    const fetchReports = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const { data, error } = await supabase.rpc('get_reports_dashboard_data', {\r\n                p_start_date: dateRange.start,\r\n                p_end_date: dateRange.end,\r\n                p_brand_id: selectedBrand !== 'all' ? selectedBrand : null,\r\n                p_sector_id: selectedSector !== 'all' ? selectedSector : null,\r\n                p_area_id: selectedArea !== 'all' ? selectedArea : null,\r\n                p_branch_id: selectedBranch !== 'all' ? selectedBranch : null\r\n            });\r\n\r\n            if (error) throw error;\r\n\r\n            if (data) {\r\n                setReportData({\r\n                    totalTickets: data.totalTickets || 0,\r\n                    resolvedTickets: data.resolvedTickets || 0,\r\n                    avgMttr: data.avgMttr || 0,\r\n                    totalCost: data.totalCost || 0,\r\n                    dailyTrends: data.dailyTrends || [],\r\n                    categoryDistribution: data.categoryDistribution || [],\r\n                    branchPerformance: data.branchPerformance || []\r\n                });\r\n            }\r\n        } catch (e) {\r\n            console.error('Error fetching reports:', e);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleExport = async () => {\r\n        setExporting(true);\r\n        try {\r\n            let offset = 0;\r\n            const CHUNK_SIZE = 5000;\r\n            let keepFetching = true;\r\n            let allTickets: any[] = [];\r\n\r\n            while (keepFetching) {\r\n                const { data, error } = await supabase.rpc('export_raw_tickets', {\r\n                    p_start_date: dateRange.start,\r\n                    p_end_date: dateRange.end,\r\n                    p_brand_id: selectedBrand !== 'all' ? selectedBrand : null,\r\n                    p_sector_id: selectedSector !== 'all' ? selectedSector : null,\r\n                    p_area_id: selectedArea !== 'all' ? selectedArea : null,\r\n                    p_branch_id: selectedBranch !== 'all' ? selectedBranch : null,\r\n                    p_limit: CHUNK_SIZE,\r\n                    p_offset: offset\r\n                });\r\n\r\n                if (error) throw error;\r\n\r\n                if (data && data.length > 0) {\r\n                    allTickets = [...allTickets, ...data];\r\n                    offset += CHUNK_SIZE;\r\n                    if (data.length < CHUNK_SIZE) keepFetching = false;\r\n                } else {\r\n                    keepFetching = false;\r\n                }\r\n            }\r\n\r\n            if (allTickets.length === 0) {\r\n                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.');\r\n                return;\r\n            }\r\n\r\n            const flatData = allTickets.map((t: any) => ({\r\n                'Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº': t.id ? t.id.slice(0, 8) : '-',\r\n                'Ø§Ù„ÙØ±Ø¹': t.branch_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',\r\n                'Ø§Ù„ØªØµÙ†ÙŠÙ': t.category_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',\r\n                'Ø§Ù„Ø­Ø§Ù„Ø©': t.status,\r\n                'Ø§Ù„ØªØ§Ø±ÙŠØ®': t.created_at ? format(new Date(t.created_at), 'yyyy-MM-dd HH:mm') : '-',\r\n                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚': t.resolved_at ? format(new Date(t.resolved_at), 'yyyy-MM-dd HH:mm') : '-',\r\n                'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…': t.rating_score || '-'\r\n            }));\r\n\r\n            const ws = XLSX.utils.json_to_sheet(flatData);\r\n            const wb = XLSX.utils.book_new();\r\n            XLSX.utils.book_append_sheet(wb, ws, \"Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±\");\r\n            XLSX.writeFile(wb, `Sovereign_Report_${format(new Date(), 'yyyy-MM-dd')}.xlsx`);\r\n        } catch (e) {\r\n            console.error('Export failed:', e);\r\n            alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + (e as Error).message);\r\n        } finally {\r\n            setExporting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            <div className=\"flex flex-col gap-6\">\r\n                <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 animate-in fade-in slide-in-from-top-4 duration-500\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-black text-white flex items-center gap-3\">\r\n                            <div className=\"p-3 rounded-2xl bg-surface-900 border border-surface-800 shadow-2xl\">\r\n                                <BarChart3 className=\"w-8 h-8 text-brand-blaban\" />\r\n                            </div>\r\n                            Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ\r\n                        </h1>\r\n                        <p className=\"text-surface-400 font-medium mt-1\">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡ØŒ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙØŒ ÙˆÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</p>\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={handleExport}\r\n                        disabled={exporting || loading}\r\n                        className=\"flex items-center gap-2 px-6 py-3 bg-surface-900 hover:bg-surface-800 border border-surface-800 text-white rounded-2xl font-bold transition-all shadow-xl disabled:opacity-50\"\r\n                    >\r\n                        {exporting ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Download className=\"w-5 h-5 text-brand-blaban\" />}\r\n                        ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"bg-surface-900/50 backdrop-blur-xl border border-surface-800 rounded-3xl p-6 flex flex-wrap gap-4 items-end animate-in fade-in slide-in-from-top-4 duration-700\">\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø§Ù„ÙØªØ±Ø© Ù…Ù†</label>\r\n                        <div className=\"relative\">\r\n                            <Calendar className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-brand-blaban\" />\r\n                            <input\r\n                                type=\"date\"\r\n                                value={dateRange.start}\r\n                                onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}\r\n                                className=\"w-full pl-3 pr-10 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø¥Ù„Ù‰</label>\r\n                        <div className=\"relative\">\r\n                            <CalendarDays className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-brand-blaban\" />\r\n                            <input\r\n                                type=\"date\"\r\n                                value={dateRange.end}\r\n                                onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}\r\n                                className=\"w-full pl-3 pr-10 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label>\r\n                        <select\r\n                            value={selectedBrand}\r\n                            onChange={(e) => {\r\n                                setSelectedBrand(e.target.value);\r\n                                setSelectedSector('all');\r\n                                setSelectedArea('all');\r\n                                setSelectedBranch('all');\r\n                            }}\r\n                            className=\"w-full px-4 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                        >\r\n                            <option value=\"all\">ÙƒØ§ÙØ© Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª</option>\r\n                            {brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø§Ù„Ù‚Ø·Ø§Ø¹</label>\r\n                        <select\r\n                            value={selectedSector}\r\n                            onChange={(e) => {\r\n                                setSelectedSector(e.target.value);\r\n                                setSelectedArea('all');\r\n                                setSelectedBranch('all');\r\n                            }}\r\n                            className=\"w-full px-4 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                        >\r\n                            <option value=\"all\">ÙƒØ§ÙØ© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</option>\r\n                            {sectors.filter(s => selectedBrand === 'all' || s.brand_id === selectedBrand).map(s => (\r\n                                <option key={s.id} value={s.id}>{s.name}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>\r\n                        <select\r\n                            value={selectedArea}\r\n                            onChange={(e) => {\r\n                                setSelectedArea(e.target.value);\r\n                                setSelectedBranch('all');\r\n                            }}\r\n                            className=\"w-full px-4 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                        >\r\n                            <option value=\"all\">ÙƒØ§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>\r\n                            {areas.filter(a => selectedSector === 'all' || a.sector_id === selectedSector).map(a => (\r\n                                <option key={a.id} value={a.id}>{a.name}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <div className=\"flex-1 min-w-[200px] space-y-2\">\r\n                        <label className=\"text-xs font-bold text-surface-500 block\">Ø§Ù„ÙØ±Ø¹</label>\r\n                        <select\r\n                            value={selectedBranch}\r\n                            onChange={(e) => setSelectedBranch(e.target.value)}\r\n                            className=\"w-full px-4 py-3 bg-surface-900 border border-surface-700 rounded-xl text-white text-sm outline-none focus:ring-2 focus:ring-brand-blaban/30 transition-all font-outfit\"\r\n                        >\r\n                            <option value=\"all\">ÙƒØ§ÙØ© Ø§Ù„ÙØ±ÙˆØ¹</option>\r\n                            {branches.filter(b => selectedArea === 'all' || b.area_id === selectedArea).map(b => (\r\n                                <option key={b.id} value={b.id}>{b.name}</option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n                    <button\r\n                        onClick={fetchReports}\r\n                        className=\"p-3.5 bg-brand-blaban text-white rounded-xl hover:bg-opacity-90 transition-all shadow-lg shadow-brand-blaban/20\"\r\n                    >\r\n                        <RefreshCw className={clsx(\"w-5 h-5\", loading && \"animate-spin\")} />\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n                    <ReportCard\r\n                        title=\"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª\"\r\n                        value={reportData.totalTickets}\r\n                        icon={FileText}\r\n                        color=\"text-blue-400\"\r\n                        loading={loading}\r\n                    />\r\n                    <ReportCard\r\n                        title=\"Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²\"\r\n                        value={`${reportData.totalTickets ? Math.round((reportData.resolvedTickets / reportData.totalTickets) * 100) : 0}%`}\r\n                        icon={TrendingUp}\r\n                        color=\"text-emerald-400\"\r\n                        loading={loading}\r\n                    />\r\n                    <ReportCard\r\n                        title=\"Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (MTTR)\"\r\n                        value={`${reportData.avgMttr} Ø³`}\r\n                        icon={BarChart3}\r\n                        color=\"text-amber-400\"\r\n                        loading={loading}\r\n                    />\r\n                    <ReportCard\r\n                        title=\"Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\"\r\n                        value={`${reportData.totalCost.toLocaleString()} Ø¬.Ù…`}\r\n                        icon={PieIcon}\r\n                        color=\"text-red-400\"\r\n                        loading={loading}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in duration-1000\">\r\n                    <div className=\"bg-surface-900 border border-surface-800 rounded-3xl p-6 shadow-xl\">\r\n                        <h3 className=\"text-lg font-bold text-white mb-6 flex items-center gap-2\">\r\n                            <TrendingUp className=\"w-5 h-5 text-brand-blaban\" /> ÙƒØ«Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\r\n                        </h3>\r\n                        <div className=\"h-[300px] w-full\">\r\n                            {loading ? <Skeleton className=\"h-full w-full rounded-2xl\" /> : (\r\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                    <AreaChart data={reportData.dailyTrends}>\r\n                                        <defs>\r\n                                            <linearGradient id=\"colorCount\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                                <stop offset=\"5%\" stopColor=\"#004aad\" stopOpacity={0.3} />\r\n                                                <stop offset=\"95%\" stopColor=\"#004aad\" stopOpacity={0} />\r\n                                            </linearGradient>\r\n                                        </defs>\r\n                                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#1e293b\" vertical={false} />\r\n                                        <XAxis dataKey=\"date\" stroke=\"#64748b\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                        <YAxis stroke=\"#64748b\" fontSize={10} tickLine={false} axisLine={false} />\r\n                                        <Tooltip\r\n                                            contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                            itemStyle={{ color: '#fff', fontSize: '12px', fontWeight: 'bold' }}\r\n                                        />\r\n                                        <Area type=\"monotone\" dataKey=\"count\" stroke=\"#004aad\" strokeWidth={3} fillOpacity={1} fill=\"url(#colorCount)\" />\r\n                                    </AreaChart>\r\n                                </ResponsiveContainer>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"bg-surface-900 border border-surface-800 rounded-3xl p-6 shadow-xl\">\r\n                        <h3 className=\"text-lg font-bold text-white mb-6 flex items-center gap-2\">\r\n                            <PieIcon className=\"w-5 h-5 text-brand-blaban\" /> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ\r\n                        </h3>\r\n                        <div className=\"h-[300px] w-full\">\r\n                            {loading ? <Skeleton className=\"h-full w-full rounded-2xl\" /> : (\r\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                    <PieChart>\r\n                                        <Pie\r\n                                            data={reportData.categoryDistribution}\r\n                                            cx=\"50%\"\r\n                                            cy=\"50%\"\r\n                                            innerRadius={60}\r\n                                            outerRadius={100}\r\n                                            paddingAngle={5}\r\n                                            dataKey=\"value\"\r\n                                        >\r\n                                            {reportData.categoryDistribution.map((_: any, index: number) => (\r\n                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\r\n                                            ))}\r\n                                        </Pie>\r\n                                        <Tooltip\r\n                                            contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                        />\r\n                                        <Legend verticalAlign=\"bottom\" height={36} />\r\n                                    </PieChart>\r\n                                </ResponsiveContainer>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"lg:col-span-2 bg-surface-900 border border-surface-800 rounded-3xl p-6 shadow-xl\">\r\n                        <h3 className=\"text-lg font-bold text-white mb-6 flex items-center gap-2\">\r\n                            <Filter className=\"w-5 h-5 text-brand-blaban\" /> ØªØ­Ù„ÙŠÙ„ ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Top 10)\r\n                        </h3>\r\n                        <div className=\"h-[400px] w-full\">\r\n                            {loading ? <Skeleton className=\"h-full w-full rounded-2xl\" /> : (\r\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                    <BarChart data={reportData.branchPerformance} layout=\"vertical\">\r\n                                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#1e293b\" horizontal={false} />\r\n                                        <XAxis type=\"number\" stroke=\"#64748b\" fontSize={10} hide />\r\n                                        <YAxis dataKey=\"name\" type=\"category\" stroke=\"#fff\" fontSize={12} width={120} tickLine={false} axisLine={false} />\r\n                                        <Tooltip\r\n                                            contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155', borderRadius: '12px' }}\r\n                                        />\r\n                                        <Bar dataKey=\"total\" fill=\"#334155\" radius={[0, 4, 4, 0]} barSize={20} />\r\n                                        <Bar dataKey=\"resolved\" fill=\"#004aad\" radius={[0, 4, 4, 0]} barSize={20} />\r\n                                    </BarChart>\r\n                                </ResponsiveContainer>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </DashboardLayout>\r\n    );\r\n}\r\n\r\nfunction ReportCard({ title, value, icon: Icon, color, loading }: any) {\r\n    return (\r\n        <div className=\"bg-surface-900 border border-surface-800 p-6 rounded-3xl shadow-sm relative overflow-hidden group hover:border-surface-700 transition-all\">\r\n            <div className={clsx(\"absolute top-0 right-0 w-24 h-24 rounded-full -mr-8 -mt-8 transition-transform group-hover:scale-125 bg-current opacity-5\", color)} />\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n                <div className={clsx(\"p-2.5 rounded-xl bg-surface-800 border border-surface-700 shadow-inner\", color)}>\r\n                    <Icon className=\"w-6 h-6\" />\r\n                </div>\r\n            </div>\r\n            {loading ? <Skeleton variant=\"text\" width=\"60%\" height=\"2rem\" /> : (\r\n                <>\r\n                    <p className=\"text-3xl font-black text-white tracking-tight\">{value}</p>\r\n                    <p className=\"text-xs font-bold text-surface-500 mt-1 uppercase tracking-widest\">{title}</p>\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\settings\\pages\\AdminSettingsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\modules\\settings\\pages\\SchemaBuilderPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAll'. Either include it or remove the dependency array.","line":82,"column":38,"nodeType":"ArrayExpression","endLine":82,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAll]","fix":{"range":[4037,4039],"text":"[fetchAll]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport DashboardLayout from '@/components/layout/DashboardLayout';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { UISchema, FieldConfig, ColumnConfig } from '@/types/schema';\r\nimport { KPICardConfig } from '@/components/sovereign/SovereignKPICard';\r\nimport SovereignKPICard from '@/components/sovereign/SovereignKPICard';\r\nimport {\r\n    Plus, Trash2, Save, ChevronDown, ChevronUp, GripVertical,\r\n    Settings2, List, FormInput, Loader2, CheckCircle2, AlertCircle,\r\n    ToggleLeft, ToggleRight, Database, RefreshCw, X, Table2,\r\n    Zap, BarChart3, Wand2, Binary, Sparkles, ShieldCheck\r\n} from 'lucide-react';\r\nimport * as LucideIcons from 'lucide-react';\r\nimport { suggestLabel } from '@/lib/sovereign-dictionary';\r\n\r\nconst FIELD_TYPES: { value: FieldConfig['type']; label: string }[] = [\r\n    { value: 'text', label: 'ğŸ“ Ù†Øµ' },\r\n    { value: 'textarea', label: 'ğŸ“„ Ù†Øµ ÙƒØ¨ÙŠØ±' },\r\n    { value: 'number', label: 'ğŸ”¢ Ø±Ù‚Ù…' },\r\n    { value: 'date', label: 'ğŸ“… ØªØ§Ø±ÙŠØ®' },\r\n    { value: 'select', label: 'ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©' },\r\n    { value: 'email', label: 'ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' },\r\n    { value: 'hidden', label: 'ğŸ™ˆ Ù…Ø®ÙÙŠ' },\r\n];\r\n\r\nconst COLUMN_TYPES: { value: ColumnConfig['type']; label: string }[] = [\r\n    { value: 'text', label: 'ğŸ“ Ù†Øµ' },\r\n    { value: 'number', label: 'ğŸ”¢ Ø±Ù‚Ù…' },\r\n    { value: 'date', label: 'ğŸ“… ØªØ§Ø±ÙŠØ®' },\r\n    { value: 'status', label: 'ğŸ”µ Ø­Ø§Ù„Ø©' },\r\n    { value: 'badge', label: 'ğŸ·ï¸ Ø´Ø§Ø±Ø©' },\r\n];\r\n\r\n// Postgres type mapped from form field type\r\nconst PG_TYPE_MAP: Record<string, string> = {\r\n    text: 'text', textarea: 'text', email: 'text', hidden: 'text',\r\n    select: 'text', number: 'numeric', date: 'timestamptz',\r\n};\r\n\r\nconst emptyField = (): FieldConfig => ({ key: '', label: '', type: 'text', required: false, placeholder: '' });\r\nconst emptyColumn = (): ColumnConfig => ({ key: '', label: '', type: 'text', sortable: true });\r\n\r\ninterface DbTable { table_name: string; row_count: number; registered: boolean; }\r\n\r\nexport default function SchemaBuilderPage() {\r\n    // â”€â”€ Schema state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const [schemas, setSchemas] = useState<UISchema[]>([]);\r\n    const [selected, setSelected] = useState<UISchema | null>(null);\r\n    const [formFields, setFormFields] = useState<FieldConfig[]>([]);\r\n    const [listCols, setListCols] = useState<ColumnConfig[]>([]);\r\n    const [tableTitle, setTableTitle] = useState('');\r\n    const [formTitle, setFormTitle] = useState('');\r\n    const [activeTab, setActiveTab] = useState<'form' | 'list' | 'kpi' | 'nav'>('form');\r\n    const [kpiCards, setKpiCards] = useState<KPICardConfig[]>([]);\r\n    const [navConfig, setNavConfig] = useState<{ is_visible: boolean; icon: string; roles: string[]; color: string }>({\r\n        is_visible: true,\r\n        icon: 'Layout',\r\n        roles: ['admin'],\r\n        color: 'blue'\r\n    });\r\n\r\n    // â”€â”€ DB Explorer state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const [dbTables, setDbTables] = useState<DbTable[]>([]);\r\n    const [dbLoading, setDbLoading] = useState(false);\r\n    const [sidebarMode, setSidebarMode] = useState<'schemas' | 'explorer'>('explorer');\r\n    const [discoveredCols, setDiscoveredCols] = useState<{ name: string; type: string }[]>([]);\r\n    const [discovering, setDiscovering] = useState(false);\r\n\r\n    // â”€â”€ Status state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const [saving, setSaving] = useState(false);\r\n    const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');\r\n    const [statusMsg, setStatusMsg] = useState('');\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // â”€â”€ New Schema modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const [newSchemaModal, setNewSchemaModal] = useState(false);\r\n    const [newTableName, setNewTableName] = useState('');\r\n    const [newDisplayName, setNewDisplayName] = useState('');\r\n    const [addingSchema, setAddingSchema] = useState(false);\r\n    const [createDbTable, setCreateDbTable] = useState(true);\r\n\r\n    useEffect(() => { fetchAll(); }, []);\r\n\r\n    const fetchAll = async () => {\r\n        setLoading(true);\r\n        await Promise.all([fetchSchemas(), fetchDbTables()]);\r\n        setLoading(false);\r\n    };\r\n\r\n    const fetchSchemas = async () => {\r\n        const { data } = await supabase.from('ui_schemas' as any).select('*').order('table_name');\r\n        if (data) setSchemas(data as UISchema[]);\r\n    };\r\n\r\n    const fetchDbTables = async () => {\r\n        setDbLoading(true);\r\n        const { data, error } = await supabase.rpc('sovereign_list_tables');\r\n        if (!error && data) {\r\n            const { data: schemaData } = await supabase.from('ui_schemas' as any).select('table_name');\r\n            const registeredNames = new Set((schemaData || []).map((s: any) => s.table_name));\r\n            setDbTables((data as any[]).map(t => ({\r\n                table_name: t.table_name,\r\n                row_count: t.row_count,\r\n                registered: registeredNames.has(t.table_name),\r\n            })));\r\n        }\r\n        setDbLoading(false);\r\n    };\r\n\r\n    const handleSelect = (s: UISchema) => {\r\n        setSelected(s);\r\n        setFormFields(s.form_config?.fields || []);\r\n        setListCols(s.list_config?.columns || []);\r\n        setTableTitle(s.list_config?.title || '');\r\n        setFormTitle(s.form_config?.title || '');\r\n        setKpiCards((s as any).page_config?.kpi_cards || []);\r\n        setNavConfig((s as any).nav_config || { is_visible: true, icon: 'Layout', roles: ['admin'], color: 'blue' });\r\n        setSaveStatus('idle');\r\n        fetchDiscoveredColumns(s.table_name);\r\n    };\r\n\r\n    const fetchDiscoveredColumns = async (tableName: string) => {\r\n        setDiscovering(true);\r\n        try {\r\n            const { data, error } = await supabase.rpc('get_table_columns', { p_table_name: tableName });\r\n            if (!error && data) {\r\n                setDiscoveredCols((data as any[]).map(c => ({\r\n                    name: c.column_name,\r\n                    type: c.data_type\r\n                })));\r\n            }\r\n        } catch (e) {\r\n            console.error('Field discovery error', e);\r\n        } finally {\r\n            setDiscovering(false);\r\n        }\r\n    };\r\n\r\n    const importFromDb = (colName: string) => {\r\n        const alreadyInForm = formFields.some(f => f.key === colName);\r\n        if (alreadyInForm) return;\r\n\r\n        const label = suggestLabel(colName);\r\n        const newField: FieldConfig = {\r\n            key: colName,\r\n            label: label,\r\n            type: colName.includes('date') || colName.includes('at') ? 'date' :\r\n                colName.includes('id') ? 'select' : 'text',\r\n            required: false,\r\n            placeholder: `Ø£Ø¯Ø®Ù„ ${label}`\r\n        };\r\n        setFormFields(p => [...p, newField]);\r\n\r\n        // Also add to list view if not present\r\n        if (!listCols.some(c => c.key === colName)) {\r\n            setListCols(p => [...p, { key: colName, label: label, type: 'text', sortable: true }]);\r\n        }\r\n    };\r\n\r\n    // â”€â”€ Auto-DDL Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const handleSave = async () => {\r\n        if (!selected) return;\r\n        const invalid = formFields.some(f => !f.key.trim() || !f.label.trim())\r\n            || listCols.some(c => !c.key.trim() || !c.label.trim());\r\n        if (invalid) { setSaveStatus('error'); setStatusMsg('ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ø¡ Ø§Ø³Ù… Ø¸Ø§Ù‡Ø± ÙˆØ§Ø³Ù… Ø¨Ø±Ù…Ø¬ÙŠ Ù„ÙƒÙ„ Ø­Ù‚Ù„'); return; }\r\n\r\n        setSaving(true);\r\n        setSaveStatus('idle');\r\n\r\n        try {\r\n            // 1. Auto-add missing DB columns via RPC (no SQL needed!)\r\n            const addResults: string[] = [];\r\n            for (const field of formFields) {\r\n                if (!field.key.trim() || field.type === 'hidden') continue;\r\n                const pgType = PG_TYPE_MAP[field.type] || 'text';\r\n                const { data, error } = await supabase.rpc('sovereign_add_column', {\r\n                    p_table: selected.table_name,\r\n                    p_column: field.key.trim(),\r\n                    p_type: pgType,\r\n                });\r\n                if (error) throw new Error(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ ${field.key}: ${error.message}`);\r\n                if ((data as any)?.action === 'added') addResults.push(field.key);\r\n            }\r\n\r\n            // 2. Save schema definition including KPI cards\r\n            const { error: saveError } = await supabase\r\n                .from('ui_schemas' as any)\r\n                .update({\r\n                    list_config: { ...selected.list_config, title: tableTitle, columns: listCols },\r\n                    form_config: { ...selected.form_config, title: formTitle, fields: formFields },\r\n                    page_config: { kpi_cards: kpiCards },\r\n                    nav_config: navConfig,\r\n                })\r\n                .eq('id', selected.id);\r\n\r\n            if (saveError) throw saveError;\r\n\r\n            const msg = addResults.length\r\n                ? `âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ© ${addResults.length} Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯: ${addResults.join(', ')}`\r\n                : 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';\r\n            setSaveStatus('success');\r\n            setStatusMsg(msg);\r\n            fetchSchemas();\r\n            setTimeout(() => setSaveStatus('idle'), 4000);\r\n        } catch (e: any) {\r\n            setSaveStatus('error');\r\n            setStatusMsg(e.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    // â”€â”€ Delete field with DB column drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const handleDeleteField = async (i: number) => {\r\n        const field = formFields[i];\r\n        if (!selected || !field.key.trim()) {\r\n            setFormFields(p => p.filter((_, j) => j !== i));\r\n            return;\r\n        }\r\n        const confirm = window.confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„ \"${field.label}\" ÙˆØ¹Ù…ÙˆØ¯ \"${field.key}\" Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙŠØ¶Ø§Ù‹ØŸ\\n\\nâš ï¸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ù„ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯!`);\r\n        if (!confirm) {\r\n            setFormFields(p => p.filter((_, j) => j !== i));\r\n            return;\r\n        }\r\n        await supabase.rpc('sovereign_drop_column', {\r\n            p_table: selected.table_name,\r\n            p_column: field.key.trim(),\r\n        });\r\n        setFormFields(p => p.filter((_, j) => j !== i));\r\n    };\r\n\r\n    // â”€â”€ Add New Schema with optional DB Table creation â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const handleAddSchema = async () => {\r\n        const key = newTableName.trim().toLowerCase().replace(/\\s+/g, '_');\r\n        if (!key) return;\r\n        setAddingSchema(true);\r\n        try {\r\n            if (createDbTable) {\r\n                const { error: createErr } = await supabase.rpc('sovereign_create_table', { p_table: key });\r\n                if (createErr) throw createErr;\r\n            }\r\n            const { error } = await supabase\r\n                .from('ui_schemas' as any)\r\n                .insert([{\r\n                    table_name: key,\r\n                    form_config: { title: newDisplayName || key, fields: [] },\r\n                    list_config: { title: newDisplayName || key, columns: [] },\r\n                }]);\r\n            if (error) throw error;\r\n            setNewSchemaModal(false);\r\n            setNewTableName('');\r\n            setNewDisplayName('');\r\n            setCreateDbTable(true);\r\n            fetchAll();\r\n        } catch (e: any) {\r\n            alert(`Ø®Ø·Ø£: ${e.message}`);\r\n        } finally {\r\n            setAddingSchema(false);\r\n        }\r\n    };\r\n\r\n    // â”€â”€ Register unregistered table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const handleRegisterTable = async (tableName: string) => {\r\n        const { error } = await supabase\r\n            .from('ui_schemas' as any)\r\n            .insert([{\r\n                table_name: tableName,\r\n                form_config: { title: tableName, fields: [] },\r\n                list_config: { title: tableName, columns: [] },\r\n            }]);\r\n        if (!error) fetchAll();\r\n    };\r\n\r\n    // â”€â”€ Field helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n    const updateField = (i: number, k: keyof FieldConfig, v: any) =>\r\n        setFormFields(p => { const a = [...p]; a[i] = { ...a[i], [k]: v }; return a; });\r\n    const moveField = (i: number, dir: 'up' | 'down') =>\r\n        setFormFields(p => {\r\n            const a = [...p]; const t = dir === 'up' ? i - 1 : i + 1;\r\n            if (t < 0 || t >= a.length) return a;\r\n            [a[i], a[t]] = [a[t], a[i]]; return a;\r\n        });\r\n    const updateCol = (i: number, k: keyof ColumnConfig, v: any) =>\r\n        setListCols(p => { const a = [...p]; a[i] = { ...a[i], [k]: v }; return a; });\r\n\r\n    const inp = 'w-full bg-surface-900 border border-surface-800 text-white rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all placeholder:text-surface-600';\r\n\r\n    return (\r\n        <DashboardLayout>\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between mb-6\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className=\"w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary-500/20\">\r\n                        <Settings2 className=\"w-5 h-5 text-white\" />\r\n                    </div>\r\n                    <div>\r\n                        <h2 className=\"text-2xl font-bold text-surface-900 dark:text-white\">Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ V2</h2>\r\n                        <p className=\"text-surface-500 text-sm\">Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª â€” Ø¨Ø¯ÙˆÙ† SQL</p>\r\n                    </div>\r\n                </div>\r\n                <button onClick={fetchAll} className=\"flex items-center gap-2 px-4 py-2 text-sm text-surface-400 hover:text-white hover:bg-surface-900 rounded-xl transition-all border border-surface-800\">\r\n                    <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />\r\n                    ØªØ­Ø¯ÙŠØ«\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"flex gap-5 items-start\">\r\n                {/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\r\n                <div className=\"w-60 shrink-0 flex flex-col gap-2\">\r\n                    {/* Toggle */}\r\n                    <div className=\"flex bg-surface-900 p-1 rounded-xl gap-1 border border-surface-800\">\r\n                        {[\r\n                            { id: 'explorer', label: 'DB Explorer', icon: Database },\r\n                            { id: 'schemas', label: 'Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©', icon: Settings2 },\r\n                        ].map(({ id, label, icon: Icon }) => (\r\n                            <button key={id} onClick={() => setSidebarMode(id as any)}\r\n                                className={`flex-1 flex items-center justify-center gap-1.5 py-1.5 rounded-lg text-xs font-semibold transition-all ${sidebarMode === id ? 'bg-surface-800 text-white shadow-lg border border-white/5' : 'text-surface-500'}`}>\r\n                                <Icon className=\"w-3.5 h-3.5\" />{label}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Add new */}\r\n                    <button onClick={() => setNewSchemaModal(true)}\r\n                        className=\"flex items-center gap-2 px-3 py-2 bg-primary-600 hover:bg-primary-500 text-white text-xs font-semibold rounded-xl transition-all shadow-md shadow-primary-500/20\">\r\n                        <Plus className=\"w-4 h-4\" /> Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯\r\n                    </button>\r\n\r\n                    {/* Table list */}\r\n                    <div className=\"bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-800 shadow-sm overflow-hidden\">\r\n                        {sidebarMode === 'explorer' ? (\r\n                            dbLoading ? (\r\n                                <div className=\"py-8 flex justify-center\"><Loader2 className=\"w-5 h-5 animate-spin text-primary-400\" /></div>\r\n                            ) : (\r\n                                <div className=\"max-h-[60vh] overflow-y-auto\">\r\n                                    {dbTables.map(t => (\r\n                                        <div key={t.table_name}\r\n                                            onClick={() => { const s = schemas.find(s => s.table_name === t.table_name); if (s) handleSelect(s); }}\r\n                                            className={`flex items-center gap-2 px-3 py-2.5 text-sm cursor-pointer border-b border-surface-100 dark:border-surface-800 last:border-0 transition-all hover:bg-surface-50 dark:hover:bg-surface-800 ${selected?.table_name === t.table_name ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-400 font-semibold' : 'text-surface-700 dark:text-surface-300'}`}\r\n                                        >\r\n                                            <span className=\"text-base\">{t.registered ? 'ğŸŸ¢' : 'âšª'}</span>\r\n                                            <span className=\"flex-1 truncate font-mono text-xs\">{t.table_name}</span>\r\n                                            <span className=\"text-xs text-surface-400 shrink-0\">{t.row_count}</span>\r\n                                            {!t.registered && (\r\n                                                <button\r\n                                                    onClick={e => { e.stopPropagation(); handleRegisterTable(t.table_name); }}\r\n                                                    title=\"ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ\"\r\n                                                    className=\"shrink-0 px-1.5 py-0.5 bg-primary-900/40 text-primary-400 border border-primary-500/30 rounded text-xs font-semibold hover:bg-primary-500 hover:text-white transition-colors\">\r\n                                                    +\r\n                                                </button>\r\n                                            )}\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )\r\n                        ) : (\r\n                            <div className=\"max-h-[60vh] overflow-y-auto p-2 space-y-1\">\r\n                                {schemas.map(s => (\r\n                                    <button key={s.id} onClick={() => handleSelect(s)}\r\n                                        className={`w-full text-right px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${selected?.id === s.id ? 'bg-primary-600 text-white shadow-lg shadow-primary-500/20' : 'text-surface-400 hover:bg-surface-800'}`}\r\n                                    >{s.table_name}</button>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Legend */}\r\n                    <div className=\"text-xs text-surface-500 px-1 space-y-1\">\r\n                        <p>ğŸŸ¢ Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ</p>\r\n                        <p>ğŸ”µ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DB ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* â”€â”€ Main Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\r\n                {!selected ? (\r\n                    <div className=\"flex-1 bg-surface-900 rounded-2xl border border-surface-800 shadow-2xl flex items-center justify-center py-24\">\r\n                        <div className=\"text-center text-surface-400\">\r\n                            <Database className=\"w-14 h-14 mx-auto mb-3 text-surface-300\" />\r\n                            <p className=\"font-semibold text-lg\">Ø§Ø®ØªØ± Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</p>\r\n                            <p className=\"text-sm mt-1\">ğŸŸ¢ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</p>\r\n                        </div>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"flex-1 flex flex-col gap-4\">\r\n                        {/* Table info bar */}\r\n                        <div className=\"bg-surface-900 border border-surface-800 rounded-2xl px-5 py-3 flex items-center gap-3 shadow-xl\">\r\n                            <Table2 className=\"w-5 h-5 text-primary-500\" />\r\n                            <span className=\"font-mono text-sm font-semibold text-white\">{selected.table_name}</span>\r\n                            <span className=\"text-surface-300\">â†</span>\r\n                            <span className=\"text-sm text-surface-500\">{formFields.length} Ø­Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Â· {listCols.length} Ø¹Ù…ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</span>\r\n                            <div className=\"mr-auto flex items-center gap-1.5 text-xs text-emerald-400 bg-emerald-900/10 px-3 py-1 rounded-full border border-emerald-900/30\">\r\n                                <Zap className=\"w-3.5 h-3.5\" />\r\n                                Ø§Ù„Ø­ÙØ¸ ÙŠÙØ¶ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù€ DB Ø¢Ù„ÙŠØ§Ù‹\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Tabs */}\r\n                        <div className=\"flex gap-1 bg-surface-900 p-1 rounded-xl w-fit border border-surface-800\">\r\n                            {[\r\n                                { id: 'form', label: 'Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', icon: FormInput },\r\n                                { id: 'list', label: 'Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„', icon: List },\r\n                                { id: 'kpi', label: 'KPI Cards', icon: BarChart3 },\r\n                                { id: 'nav', label: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ© (SaaS)', icon: Sparkles },\r\n                            ].map(({ id, label, icon: Icon }) => (\r\n                                <button key={id} onClick={() => setActiveTab(id as any)}\r\n                                    className={`flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === id ? 'bg-surface-800 text-white shadow-lg border border-white/5' : 'text-surface-500 hover:text-surface-300'}`}>\r\n                                    <Icon className=\"w-4 h-4 text-primary-500\" />{label}\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n\r\n                        {activeTab === 'form' && (\r\n                            <div className=\"bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-800 shadow-sm overflow-hidden\">\r\n                                <div className=\"p-5 border-b border-surface-100 dark:border-surface-800 flex items-center justify-between flex-wrap gap-3\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <span className=\"text-sm text-surface-500\">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©:</span>\r\n                                        <input value={formTitle} onChange={e => setFormTitle(e.target.value)} placeholder=\"Ù…Ø«Ø§Ù„: Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹\" className={`${inp} w-52`} />\r\n                                    </div>\r\n                                    <button onClick={() => setFormFields(p => [...p, emptyField()])}\r\n                                        className=\"flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white text-sm font-medium rounded-xl transition-all\">\r\n                                        <Plus className=\"w-4 h-4\" /> Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„\r\n                                    </button>\r\n                                </div>\r\n\r\n                                {/* â”€â”€ Discovery Banner â”€â”€ */}\r\n                                {discoveredCols.length > 0 && (\r\n                                    <div className=\"bg-primary-950/20 border-b border-primary-900/30 p-4\">\r\n                                        <div className=\"flex items-center justify-between mb-3\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <Wand2 className={`w-4 h-4 text-primary-400 ${discovering ? 'animate-spin' : 'animate-pulse'}`} />\r\n                                                <span className=\"text-sm font-bold text-primary-400\">\r\n                                                    {discovering ? 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...' : 'Ø§Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© (Smart Discovery):'}\r\n                                                </span>\r\n                                            </div>\r\n                                            {discovering && <Loader2 className=\"w-4 h-4 animate-spin text-primary-400\" />}\r\n                                        </div>\r\n                                        <div className=\"flex flex-wrap gap-2\">\r\n                                            {discoveredCols\r\n                                                .filter(dbCol => !formFields.some(f => f.key === dbCol.name))\r\n                                                .map(dbCol => (\r\n                                                    <button\r\n                                                        key={dbCol.name}\r\n                                                        onClick={() => importFromDb(dbCol.name)}\r\n                                                        className=\"flex items-center gap-1.5 px-3 py-1.5 bg-surface-950 border border-primary-900/30 rounded-lg text-xs font-semibold text-primary-400 hover:bg-primary-600 hover:text-white transition-all shadow-lg group\"\r\n                                                    >\r\n                                                        <Binary className=\"w-3.5 h-3.5 opacity-50 group-hover:opacity-100\" />\r\n                                                        <span>{dbCol.name}</span>\r\n                                                        <span className=\"mx-1 opacity-20\">|</span>\r\n                                                        <span className=\"text-[10px] opacity-70\">{suggestLabel(dbCol.name)}</span>\r\n                                                        <Plus className=\"w-3 h-3 ml-1\" />\r\n                                                    </button>\r\n                                                ))\r\n                                            }\r\n                                            {discoveredCols.filter(dbCol => !formFields.some(f => f.key === dbCol.name)).length === 0 && (\r\n                                                <span className=\"text-xs text-primary-400 italic\">ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ù†Ø¬Ø§Ø­.</span>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"p-5 space-y-3 max-h-[55vh] overflow-y-auto\">\r\n                                    {formFields.length === 0 && (\r\n                                        <p className=\"text-center text-surface-400 py-10\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„. Ø§Ø¶ØºØ· \"Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„\" Ù„Ù„Ø¨Ø¯Ø¡.</p>\r\n                                    )}\r\n                                    {formFields.map((field, i) => (\r\n                                        <div key={i} className=\"flex gap-3 items-start bg-surface-800/20 rounded-xl p-4 border border-surface-800 transition-colors hover:border-surface-700\">\r\n                                            <div className=\"flex flex-col gap-1 pt-1\">\r\n                                                <button onClick={() => moveField(i, 'up')} disabled={i === 0} className=\"p-1 text-surface-400 hover:text-surface-700 disabled:opacity-30\"><ChevronUp className=\"w-4 h-4\" /></button>\r\n                                                <GripVertical className=\"w-4 h-4 text-surface-300 mx-auto\" />\r\n                                                <button onClick={() => moveField(i, 'down')} disabled={i === formFields.length - 1} className=\"p-1 text-surface-400 hover:text-surface-700 disabled:opacity-30\"><ChevronDown className=\"w-4 h-4\" /></button>\r\n                                            </div>\r\n                                            <div className=\"flex-1 grid grid-cols-2 gap-3\">\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± *</label>\r\n                                                    <input value={field.label} onChange={e => updateField(i, 'label', e.target.value)} placeholder=\"Ù…Ø«Ø§Ù„: Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù\" className={inp} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ * <span className=\"text-surface-400\">[EN]</span></label>\r\n                                                    <input value={field.key} onChange={e => updateField(i, 'key', e.target.value.replace(/\\s/g, '_').toLowerCase())} dir=\"ltr\" placeholder=\"full_name\" className={`${inp} font-mono`} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„</label>\r\n                                                    <select value={field.type} onChange={e => updateField(i, 'type', e.target.value as FieldConfig['type'])} className={inp}>\r\n                                                        {FIELD_TYPES.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}\r\n                                                    </select>\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ù†Øµ ØªÙ„Ù…ÙŠØ­ÙŠ</label>\r\n                                                    <input value={field.placeholder || ''} onChange={e => updateField(i, 'placeholder', e.target.value)} className={inp} />\r\n                                                </div>\r\n                                                {field.type === 'select' && (\r\n                                                    <div className=\"col-span-2\">\r\n                                                        <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª <span className=\"text-primary-500\">(Ø§Ø³Ù… Ø¬Ø¯ÙˆÙ„)</span></label>\r\n                                                        <input value={field.dataSource || ''} onChange={e => updateField(i, 'dataSource', e.target.value)} dir=\"ltr\" placeholder=\"branches\" className={`${inp} font-mono`} />\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                            <div className=\"flex flex-col items-center gap-2 pt-1\">\r\n                                                <span className=\"text-xs text-surface-400\">Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</span>\r\n                                                <button onClick={() => updateField(i, 'required', !field.required)}>\r\n                                                    {field.required ? <ToggleRight className=\"w-8 h-8 text-primary-500\" /> : <ToggleLeft className=\"w-8 h-8 text-surface-300\" />}\r\n                                                </button>\r\n                                                <button onClick={() => handleDeleteField(i)} className=\"p-2 text-red-500 hover:bg-red-950/30 rounded-lg transition-colors border border-transparent hover:border-red-900/30\">\r\n                                                    <Trash2 className=\"w-4 h-4\" />\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* â”€â”€ List Columns â”€â”€ */}\r\n                        {activeTab === 'list' && (\r\n                            <div className=\"bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-800 shadow-sm overflow-hidden\">\r\n                                <div className=\"p-5 border-b border-surface-100 dark:border-surface-800 flex items-center justify-between flex-wrap gap-3\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <span className=\"text-sm text-surface-500\">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©:</span>\r\n                                        <input value={tableTitle} onChange={e => setTableTitle(e.target.value)} placeholder=\"Ù…Ø«Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹\" className={`${inp} w-52`} />\r\n                                    </div>\r\n                                    <button onClick={() => setListCols(p => [...p, emptyColumn()])}\r\n                                        className=\"flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white text-sm font-medium rounded-xl transition-all\">\r\n                                        <Plus className=\"w-4 h-4\" /> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯\r\n                                    </button>\r\n                                </div>\r\n                                <div className=\"p-5 space-y-3 max-h-[55vh] overflow-y-auto\">\r\n                                    {listCols.length === 0 && (\r\n                                        <p className=\"text-center text-surface-400 py-10\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø©. Ø§Ø¶ØºØ· \"Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯\" Ù„Ù„Ø¨Ø¯Ø¡.</p>\r\n                                    )}\r\n                                    {listCols.map((col, i) => (\r\n                                        <div key={i} className=\"flex gap-3 items-center bg-surface-800/20 rounded-xl p-4 border border-surface-800 transition-colors hover:border-surface-700\">\r\n                                            <div className=\"flex-1 grid grid-cols-3 gap-3\">\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ *</label>\r\n                                                    <input value={col.label} onChange={e => updateCol(i, 'label', e.target.value)} className={inp} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ *</label>\r\n                                                    <input value={col.key} onChange={e => updateCol(i, 'key', e.target.value.replace(/\\s/g, '_').toLowerCase())} dir=\"ltr\" className={`${inp} font-mono`} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶</label>\r\n                                                    <select value={col.type} onChange={e => updateCol(i, 'type', e.target.value as ColumnConfig['type'])} className={inp}>\r\n                                                        {COLUMN_TYPES.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}\r\n                                                    </select>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div className=\"flex flex-col items-center gap-1\">\r\n                                                <span className=\"text-xs text-surface-400\">ØªØ±ØªÙŠØ¨</span>\r\n                                                <button onClick={() => updateCol(i, 'sortable', !col.sortable)}>\r\n                                                    {col.sortable ? <ToggleRight className=\"w-8 h-8 text-primary-500\" /> : <ToggleLeft className=\"w-8 h-8 text-surface-300\" />}\r\n                                                </button>\r\n                                            </div>\r\n                                            <button onClick={() => setListCols(p => p.filter((_, j) => j !== i))} className=\"p-2 text-red-500 hover:bg-red-950/30 rounded-lg border border-transparent hover:border-red-900/30\">\r\n                                                <Trash2 className=\"w-4 h-4\" />\r\n                                            </button>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* â”€â”€ KPI Cards â”€â”€ */}\r\n                        {activeTab === 'kpi' && (\r\n                            <div className=\"space-y-4\">\r\n                                {/* Editor */}\r\n                                <div className=\"bg-surface-900 rounded-2xl border border-surface-800 shadow-2xl overflow-hidden\">\r\n                                    <div className=\"p-5 border-b border-surface-800 flex items-center justify-between\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <BarChart3 className=\"w-5 h-5 text-primary-500\" />\r\n                                            <span className=\"font-semibold text-white\">ØªØ¹Ø±ÙŠÙ Ø¨Ø·Ø§Ù‚Ø§Øª KPI Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</span>\r\n                                            <span className=\"text-xs text-surface-400 bg-surface-950 px-2 py-0.5 rounded-full border border-surface-800\">ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>\r\n                                        </div>\r\n                                        <button\r\n                                            onClick={() => setKpiCards(p => [...p, { label: '', table: selected?.table_name || '', aggregate: 'count', color: 'blue', icon: 'BarChart3' }])}\r\n                                            className=\"flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white text-sm font-medium rounded-xl transition-all\">\r\n                                            <Plus className=\"w-4 h-4\" /> Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©\r\n                                        </button>\r\n                                    </div>\r\n                                    <div className=\"p-5 space-y-3 max-h-[40vh] overflow-y-auto\">\r\n                                        {kpiCards.length === 0 && (\r\n                                            <p className=\"text-center text-surface-400 py-8\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª. Ø§Ø¶ØºØ· \"Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©\" Ù„Ù„Ø¨Ø¯Ø¡.</p>\r\n                                        )}\r\n                                        {kpiCards.map((card, i) => (\r\n                                            <div key={i} className=\"grid grid-cols-2 lg:grid-cols-3 gap-3 bg-surface-800/20 rounded-xl p-4 border border-surface-800 items-end\">\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>\r\n                                                    <input value={card.label} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], label: e.target.value }; return a; })} placeholder=\"Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø©\" className={inp} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>\r\n                                                    <input dir=\"ltr\" value={card.table} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], table: e.target.value }; return a; })} placeholder=\"tickets\" className={`${inp} font-mono`} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„ØªØ¬Ù…ÙŠØ¹</label>\r\n                                                    <select value={card.aggregate} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], aggregate: e.target.value as any }; return a; })} className={inp}>\r\n                                                        <option value=\"count\">Ø¹Ø¯Ø¯ (count)</option>\r\n                                                        <option value=\"sum\">Ù…Ø¬Ù…ÙˆØ¹ (sum)</option>\r\n                                                        <option value=\"avg\">Ù…ØªÙˆØ³Ø· (avg)</option>\r\n                                                    </select>\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">ÙÙ„ØªØ± (column=value)</label>\r\n                                                    <input dir=\"ltr\" placeholder='{\"status\":\"open\"}' defaultValue={card.filter ? JSON.stringify(card.filter) : ''} onBlur={e => { try { setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], filter: e.target.value ? JSON.parse(e.target.value) : undefined }; return a; }); } catch { /* invalid json handled gracefully */ } }} className={`${inp} font-mono text-xs`} />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø§Ù„Ù„ÙˆÙ†</label>\r\n                                                    <select value={card.color} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], color: e.target.value as any }; return a; })} className={inp}>\r\n                                                        {['blue', 'red', 'green', 'amber', 'purple', 'teal'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                                    </select>\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø£ÙŠÙ‚ÙˆÙ†Ø© Lucide</label>\r\n                                                    <input dir=\"ltr\" value={card.icon || ''} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], icon: e.target.value }; return a; })} placeholder=\"Wrench\" className={`${inp} font-mono`} />\r\n                                                </div>\r\n                                                <div className=\"col-span-2\">\r\n                                                    <label className=\"text-xs font-medium text-surface-500 mb-1 block\">Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>\r\n                                                    <input dir=\"ltr\" value={card.link_to || ''} onChange={e => setKpiCards(p => { const a = [...p]; a[i] = { ...a[i], link_to: e.target.value }; return a; })} placeholder=\"/tickets\" className={`${inp} font-mono`} />\r\n                                                </div>\r\n                                                <div className=\"flex justify-end\">\r\n                                                    <button onClick={() => setKpiCards(p => p.filter((_, j) => j !== i))} className=\"px-3 py-2 text-red-500 hover:bg-red-950/30 border border-transparent hover:border-red-900/30 rounded-lg text-sm flex items-center gap-1 transition-colors\">\r\n                                                        <Trash2 className=\"w-4 h-4\" /> Ø­Ø°Ù\r\n                                                    </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Live Preview */}\r\n                                {kpiCards.length > 0 && (\r\n                                    <div className=\"bg-surface-900 rounded-2xl border border-surface-800 shadow-2xl p-5\">\r\n                                        <p className=\"text-xs font-semibold text-surface-400 uppercase tracking-widest mb-4\">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø­ÙŠØ©</p>\r\n                                        <div className=\"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3\">\r\n                                            {kpiCards.filter(c => c.label).map((card, i) => (\r\n                                                <SovereignKPICard key={i} config={card} />\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* â”€â”€ Platform / SaaS Settings â”€â”€ */}\r\n                        {activeTab === 'nav' && (\r\n                            <div className=\"animate-in fade-in slide-in-from-bottom-4 duration-500 bg-surface-900 rounded-2xl border border-surface-800 shadow-2xl overflow-hidden p-6 space-y-8\">\r\n                                <div className=\"flex items-center gap-3 border-b border-surface-800 pb-4\">\r\n                                    <Sparkles className=\"w-6 h-6 text-primary-500\" />\r\n                                    <div>\r\n                                        <h3 className=\"font-bold text-lg text-white\">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± ÙˆØ§Ù„ÙˆØµÙˆÙ„ (SaaS Ready)</h3>\r\n                                        <p className=\"text-sm text-surface-500\">ØªØ­ÙƒÙ… ÙÙŠ ÙƒÙŠÙÙŠØ© Ø¸Ù‡ÙˆØ± Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆÙ…Ù† Ù‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù… Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§.</p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                                    {/* Column 1: Appearance */}\r\n                                    <div className=\"space-y-4\">\r\n                                        <h4 className=\"text-sm font-bold text-surface-400 uppercase tracking-widest flex items-center gap-2\">\r\n                                            <Wand2 className=\"w-4 h-4\" /> Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¨ØµØ±ÙŠ\r\n                                        </h4>\r\n                                        <div>\r\n                                            <label className=\"text-xs font-semibold text-surface-500 mb-1.5 block\">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Lucide Icon)</label>\r\n                                            <div className=\"flex gap-2\">\r\n                                                <input dir=\"ltr\" value={navConfig.icon} onChange={e => setNavConfig(p => ({ ...p, icon: e.target.value }))} className={`${inp} font-mono`} placeholder=\"Ticket, Users, Box...\" />\r\n                                                <div className=\"w-10 h-10 bg-primary-950 text-white rounded-xl flex items-center justify-center shrink-0 border border-primary-900/30\">\r\n                                                    {(() => {\r\n                                                        const IconComp = (LucideIcons as any)[navConfig.icon] || (LucideIcons as any).Layout;\r\n                                                        return <IconComp className=\"w-5 h-5 text-primary-600\" />;\r\n                                                    })()}\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                        <div>\r\n                                            <label className=\"text-xs font-semibold text-surface-500 mb-1.5 block\">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ²</label>\r\n                                            <select value={navConfig.color} onChange={e => setNavConfig(p => ({ ...p, color: e.target.value }))} className={inp}>\r\n                                                {['blue', 'red', 'green', 'amber', 'purple', 'teal', 'indigo', 'rose'].map(c => <option key={c} value={c}>{c}</option>)}\r\n                                            </select>\r\n                                        </div>\r\n                                        <label className=\"flex items-center gap-3 cursor-pointer p-4 bg-surface-800/20 rounded-2xl border border-surface-800 transition-all hover:border-primary-500/50 group\">\r\n                                            <div className=\"flex-1\">\r\n                                                <p className=\"text-sm font-bold text-white group-hover:text-primary-400 transition-colors\">Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>\r\n                                                <p className=\"text-xs text-surface-500\">Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ø³ØªØ¸Ù„ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‚Ø·.</p>\r\n                                            </div>\r\n                                            <button onClick={() => setNavConfig(p => ({ ...p, is_visible: !p.is_visible }))}>\r\n                                                {navConfig.is_visible ? <ToggleRight className=\"w-10 h-10 text-primary-500\" /> : <ToggleLeft className=\"w-10 h-10 text-surface-300\" />}\r\n                                            </button>\r\n                                        </label>\r\n                                    </div>\r\n\r\n                                    {/* Column 2: Access Control */}\r\n                                    <div className=\"space-y-4\">\r\n                                        <h4 className=\"text-sm font-bold text-surface-400 uppercase tracking-widest flex items-center gap-2\">\r\n                                            <ShieldCheck className=\"w-4 h-4\" /> Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ (RBAC)\r\n                                        </h4>\r\n                                        <div className=\"grid grid-cols-1 gap-2\">\r\n                                            <label className=\"text-xs font-semibold text-surface-500 mb-1.5 block\">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙˆØµÙˆÙ„</label>\r\n                                            {[\r\n                                                { id: 'admin', label: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' },\r\n                                                { id: 'brand_ops_manager', label: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª' },\r\n                                                { id: 'maint_manager', label: 'Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©' },\r\n                                                { id: 'area_manager', label: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©' },\r\n                                                { id: 'manager', label: 'Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹' },\r\n                                                { id: 'technician', label: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©' }\r\n                                            ].map(role => (\r\n                                                <label key={role.id} className=\"flex items-center gap-3 px-3 py-2 rounded-xl bg-surface-800/20 hover:bg-surface-800 border border-transparent hover:border-surface-700 transition-all cursor-pointer group\">\r\n                                                    <input\r\n                                                        type=\"checkbox\"\r\n                                                        checked={navConfig.roles?.includes(role.id)}\r\n                                                        onChange={e => {\r\n                                                            const roles = e.target.checked\r\n                                                                ? [...(navConfig.roles || []), role.id]\r\n                                                                : (navConfig.roles || []).filter(r => r !== role.id);\r\n                                                            setNavConfig(p => ({ ...p, roles }));\r\n                                                        }}\r\n                                                        className=\"w-4 h-4 accent-primary-600 rounded\"\r\n                                                    />\r\n                                                    <span className=\"text-sm font-medium text-surface-300 group-hover:text-white\">{role.label}</span>\r\n                                                    <span className=\"text-[10px] font-mono opacity-40 ml-auto\">{role.id}</span>\r\n                                                </label>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n\r\n                        {/* â”€â”€ Save Bar â”€â”€ */}\r\n                        <div className=\"flex items-center justify-end gap-4\">\r\n                            {saveStatus !== 'idle' && (\r\n                                <div className={`flex items-center gap-2 text-sm rounded-xl px-4 py-2 border ${saveStatus === 'success' ? 'bg-green-950/20 text-green-400 border-green-900/30' : 'bg-red-950/20 text-red-400 border-red-900/30'}`}>\r\n                                    {saveStatus === 'success' ? <CheckCircle2 className=\"w-4 h-4 shrink-0\" /> : <AlertCircle className=\"w-4 h-4 shrink-0\" />}\r\n                                    {statusMsg}\r\n                                </div>\r\n                            )}\r\n                            <button onClick={handleSave} disabled={saving}\r\n                                className=\"flex items-center gap-2 px-7 py-3 bg-primary-600 hover:bg-primary-500 text-white font-semibold rounded-xl shadow-lg shadow-primary-500/20 transition-all disabled:opacity-70\">\r\n                                {saving ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Save className=\"w-5 h-5\" />}\r\n                                {saving ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù€ DB...' : 'Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* â•â• New Schema Modal â•â• */}\r\n            {newSchemaModal && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n                    <div className=\"absolute inset-0 bg-surface-900/40 backdrop-blur-sm\" onClick={() => setNewSchemaModal(false)} />\r\n                    <div className=\"relative bg-surface-900 rounded-3xl shadow-[0_0_50px_rgba(0,0,0,0.5)] w-full max-w-md overflow-hidden border border-surface-800\">\r\n                        <div className=\"flex items-center justify-between p-6 border-b border-surface-800\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"w-9 h-9 bg-primary-950 text-white rounded-xl flex items-center justify-center border border-primary-900/30\">\r\n                                    <Plus className=\"w-5 h-5 text-primary-400\" />\r\n                                </div>\r\n                                <h3 className=\"font-bold text-white\">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h3>\r\n                            </div>\r\n                            <button onClick={() => setNewSchemaModal(false)} className=\"p-2 text-surface-500 hover:text-white hover:bg-surface-800 rounded-full transition-colors\">\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"p-6 space-y-4\">\r\n                            <div>\r\n                                <label className=\"text-xs font-semibold text-surface-500 mb-1.5 block\">Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª *</label>\r\n                                <input dir=\"ltr\" value={newTableName} onChange={e => setNewTableName(e.target.value.replace(/\\s/g, '_').toLowerCase())}\r\n                                    placeholder=\"Ù…Ø«Ø§Ù„: equipment\" className={`${inp} font-mono`} />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"text-xs font-semibold text-surface-500 mb-1.5 block\">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶</label>\r\n                                <input value={newDisplayName} onChange={e => setNewDisplayName(e.target.value)}\r\n                                    placeholder=\"Ù…Ø«Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª\" className={inp} />\r\n                            </div>\r\n                            <label className=\"flex items-center gap-3 cursor-pointer p-3 bg-surface-950/50 rounded-xl border border-surface-800 hover:border-surface-700 transition-colors\">\r\n                                <input type=\"checkbox\" checked={createDbTable} onChange={e => setCreateDbTable(e.target.checked)} className=\"w-4 h-4 accent-primary-600 bg-surface-900 border-surface-700\" />\r\n                                <div>\r\n                                    <p className=\"text-sm font-semibold text-white\">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†</p>\r\n                                    <p className=\"text-xs text-surface-500\">Ø³ÙŠÙÙ†Ø´Ø£ Ø¨Ù€ id, created_at, updated_at ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>\r\n                                </div>\r\n                            </label>\r\n                        </div>\r\n                        <div className=\"p-6 pt-0 flex justify-end gap-3\">\r\n                            <button onClick={() => setNewSchemaModal(false)} className=\"px-5 py-2.5 text-surface-400 font-medium hover:bg-surface-800 hover:text-white rounded-xl transition-colors\">Ø¥Ù„ØºØ§Ø¡</button>\r\n                            <button onClick={handleAddSchema} disabled={addingSchema || !newTableName.trim()}\r\n                                className=\"flex items-center gap-2 px-6 py-2.5 bg-primary-600 hover:bg-primary-500 text-white font-semibold rounded-xl shadow-lg shadow-primary-500/20 transition-all disabled:opacity-70\">\r\n                                {addingSchema ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Database className=\"w-5 h-5\" />}\r\n                                {createDbTable ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡' : 'ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ ÙÙ‚Ø·'}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </DashboardLayout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"c:\\AG V4.5\\src\\types\\schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]
